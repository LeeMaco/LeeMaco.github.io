<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI æ™ºèƒ½æœƒå“¡ç³»çµ± V5.2 (å®¢è£½ç‰ˆ)</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .tab-btn { position: relative; color: #64748b; transition: all 0.3s; }
        .tab-active { color: #4f46e5; font-weight: bold; }
        .tab-active::after { content: ''; position: absolute; bottom: -12px; left: 0; width: 100%; height: 3px; background: #4f46e5; border-radius: 3px 3px 0 0; }
        .loader { width: 18px; height: 18px; border: 2px solid #e2e8f0; border-top-color: #4f46e5; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes fadeInUp { from { opacity: 0; transform: translate3d(0, 20px, 0); } to { opacity: 1; transform: none; } }
        .animate-fade-in-up { animation: fadeInUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        
        #video-container video { width: 100%; height: 100%; object-fit: cover; }
        .scan-line { position: absolute; width: 100%; height: 2px; background: #4f46e5; box-shadow: 0 0 15px #4f46e5; animation: scanning 2s infinite ease-in-out; }
        @keyframes scanning { 0% {top:0; opacity: 0;} 10% {opacity: 1;} 90% {opacity: 1;} 100% {top:100%; opacity: 0;} }
        
        /* Toast Notification Styles */
        .toast-enter-active, .toast-leave-active { transition: all 0.3s ease; }
        .toast-enter-from, .toast-leave-to { opacity: 0; transform: translateX(30px); }
    </style>
</head>
<body>

<div id="app" class="min-h-screen flex flex-col pb-safe" @click="unlockAudio">
    
    <div class="fixed top-4 right-4 z-[100] flex flex-col gap-2 pointer-events-none">
        <transition-group name="toast">
            <div v-for="toast in toasts" :key="toast.id" 
                 class="pointer-events-auto min-w-[300px] max-w-sm bg-white rounded-xl shadow-xl border-l-4 p-4 flex items-center gap-3"
                 :class="{'border-emerald-500': toast.type==='success', 'border-rose-500': toast.type==='error', 'border-amber-500': toast.type==='warning'}">
                <i class="fa-solid text-xl" 
                   :class="{'fa-check-circle text-emerald-500': toast.type==='success', 'fa-times-circle text-rose-500': toast.type==='error', 'fa-exclamation-circle text-amber-500': toast.type==='warning'}"></i>
                <div>
                    <h4 class="font-bold text-slate-800 text-sm">{{ toast.title }}</h4>
                    <p class="text-xs text-slate-500">{{ toast.msg }}</p>
                </div>
            </div>
        </transition-group>
    </div>

    <div v-if="!isConfigured" class="fixed inset-0 bg-slate-900 z-[99] flex items-center justify-center p-6">
        <div class="bg-white rounded-2xl p-8 w-full max-w-md shadow-2xl animate-fade-in-up">
            <h2 class="text-2xl font-bold text-slate-800 mb-6">ç³»çµ±åˆå§‹åŒ– V5.2</h2>
            <div class="space-y-4">
                <div><label class="text-xs font-bold text-slate-500">Supabase URL</label><input v-model="config.url" class="w-full border-2 border-slate-200 p-3 rounded-xl focus:border-indigo-500 outline-none"></div>
                <div><label class="text-xs font-bold text-slate-500">Supabase Key (Anon)</label><input v-model="config.key" class="w-full border-2 border-slate-200 p-3 rounded-xl focus:border-indigo-500 outline-none"></div>
                <div><label class="text-xs font-bold text-rose-500">è¨­å®šç®¡ç†å“¡å¯†ç¢¼</label><input v-model="config.adminPwd" type="password" placeholder="é è¨­: 0000" class="w-full border-2 border-rose-200 p-3 rounded-xl focus:border-rose-500 bg-rose-50 outline-none"></div>
                <button @click="saveConfig" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 transition">å•Ÿå‹•ç³»çµ±</button>
            </div>
        </div>
    </div>

    <header class="bg-white shadow-sm sticky top-0 z-40">
        <div class="px-5 py-4 flex justify-between items-center">
            <h1 class="text-xl font-bold text-slate-800 flex items-center"><i class="fa-solid fa-cube text-indigo-600 mr-2"></i>SmartMember <span class="text-xs bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded ml-2">V5.2</span></h1>
            <div class="flex gap-4 items-center">
                <button @click="resetConfigSecure" class="text-slate-300 hover:text-slate-500"><i class="fa-solid fa-gear"></i></button>
                <button @click="checkAdmin(() => modals.io = true)" class="text-slate-400 hover:text-indigo-600 transition"><i class="fa-solid fa-file-export text-xl"></i></button>
                <div class="flex items-center gap-2 text-xs font-bold bg-slate-100 px-3 py-1.5 rounded-full">
                    <span class="text-emerald-500 flex items-center"><i class="fa-solid fa-database mr-1.5"></i>{{ members.length }}</span>
                    <span class="w-[1px] h-3 bg-slate-300 mx-1"></span>
                    <span :class="isFaceModelLoaded ? 'text-indigo-500' : 'text-slate-400'" class="flex items-center">
                        <i class="fa-solid" :class="isFaceModelLoaded ? 'fa-brain' : 'fa-circle-notch fa-spin'"></i>
                    </span>
                </div>
            </div>
        </div>
        <div class="flex border-t border-slate-100 bg-white px-2">
            <button v-for="tab in tabs" :key="tab.id" @click="currentTab = tab.id" :class="{'tab-active': currentTab === tab.id}" class="tab-btn flex-1 py-3 text-sm flex justify-center items-center">
                <i :class="tab.icon" class="mr-1.5"></i>{{ tab.label }}
            </button>
        </div>
    </header>

    <main class="flex-grow p-4 overflow-y-auto bg-slate-50">
        <div v-show="currentTab === 'self_service'" class="max-w-md mx-auto mt-4 pb-20">
            <div class="bg-white rounded-3xl shadow-lg overflow-hidden border border-slate-100 p-8 min-h-[60vh] flex flex-col items-center justify-center text-center relative animate-fade-in-up">
                
                <div v-if="verifyStatus === 'idle'" class="w-full space-y-6">
                    <div class="space-y-2">
                        <i class="fa-solid fa-robot text-5xl text-indigo-500 mb-2"></i>
                        <h2 class="text-2xl font-black text-slate-800">æ™ºèƒ½æ¥å¾…ä¸­å¿ƒ</h2>
                        <p class="text-slate-400 text-sm">è«‹é¸æ“‡æœå‹™</p>
                    </div>

                    <div class="grid gap-4 mt-6">
                        <button @click="startHomepageScan" class="w-full py-5 bg-gradient-to-r from-indigo-600 to-blue-600 text-white rounded-2xl shadow-xl hover:scale-[1.02] transition active:scale-95 flex items-center justify-center gap-3">
                            <i class="fa-solid fa-expand text-xl"></i>
                            <div class="text-left">
                                <div class="text-lg font-bold">å•Ÿå‹• AI è¿è³“æƒæ</div>
                                <div class="text-xs text-indigo-100">é€£çºŒè¾¨è­˜æœƒå“¡ / æ–°å®¢åµæ¸¬</div>
                            </div>
                        </button>

                        <div class="grid grid-cols-2 gap-3">
                            <button @click="searchMode='phone'" class="py-4 bg-white border-2 border-slate-100 rounded-xl font-bold text-slate-600 hover:border-indigo-200 transition">
                                <i class="fa-solid fa-mobile-screen mb-1 block text-xl text-indigo-400"></i> é›»è©±æŸ¥è©¢
                            </button>
                            <button @click="openSelfRegister" class="py-4 bg-white border-2 border-slate-100 rounded-xl font-bold text-slate-600 hover:border-indigo-200 transition">
                                <i class="fa-solid fa-user-plus mb-1 block text-xl text-emerald-400"></i> æœƒå“¡è¨»å†Š
                            </button>
                        </div>
                    </div>

                    <div v-if="searchMode === 'phone'" class="mt-4 pt-4 border-t animate-fade-in-up">
                         <input v-model="selfServiceInput" type="tel" placeholder="è¼¸å…¥é›»è©±è™Ÿç¢¼..." class="w-full text-center text-xl font-bold py-3 border-b-2 border-slate-200 focus:border-indigo-500 outline-none bg-transparent" @keyup.enter="performVerification">
                         <button @click="performVerification" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold mt-3 shadow-md">æŸ¥è©¢</button>
                    </div>
                </div>

                <div v-else class="w-full space-y-6 animate-fade-in-up">
                    <div class="w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-4" :class="verifyStatus === 'success' ? 'bg-emerald-100' : 'bg-rose-100'">
                        <i class="fa-solid text-5xl" :class="verifyStatus === 'success' ? 'fa-check text-emerald-500' : 'fa-xmark text-rose-500'"></i>
                    </div>
                    <div>
                        <h2 class="text-3xl font-black text-slate-800">{{ verifyStatus === 'success' ? 'æŸ¥è©¢æˆåŠŸ' : 'æŸ¥ç„¡è³‡æ–™' }}</h2>
                        <div v-if="verifyStatus === 'success'" class="mt-3">
                            <p class="text-2xl font-bold text-indigo-600">{{ verifiedMember?.name }}</p>
                            <p v-if="verifiedMember?.notes" class="text-sm text-slate-500 bg-slate-100 inline-block px-3 py-1 rounded-full mt-2">{{ verifiedMember.notes }}</p>
                        </div>
                    </div>
                    <button @click="resetSelfService" class="w-full bg-slate-500 text-white py-3 rounded-xl font-bold mt-6">è¿”å›</button>
                </div>
            </div>
        </div>

        <div v-show="currentTab === 'list'" class="space-y-4 max-w-4xl mx-auto animate-fade-in-up">
             <div class="relative group"><i class="fa-solid fa-magnifying-glass absolute left-4 top-4 text-slate-400"></i><input v-model="searchQuery" type="text" placeholder="æœå°‹æœƒå“¡å§“åæˆ–å‚™è¨»..." class="w-full pl-11 pr-4 py-3.5 border-0 rounded-2xl shadow-sm bg-white focus:ring-2 focus:ring-indigo-100 outline-none"></div>
             <div class="flex justify-between px-1"><span class="text-sm text-slate-500">å…± {{ members.length }} äºº</span><button @click="openAdminAdd" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow hover:bg-indigo-700 transition">+ æ–°å¢</button></div>
             <div class="grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
                 <div v-for="m in filteredMembers" :key="m.id" @click="editMember(m)" class="bg-white p-4 rounded-2xl shadow-sm flex items-start gap-4 cursor-pointer border border-slate-100 hover:border-indigo-200 transition relative overflow-hidden">
                     <img :src="m.photo||'https://via.placeholder.com/150'" class="w-12 h-12 rounded-full object-cover bg-gray-100 border flex-shrink-0">
                     <div class="flex-1 overflow-hidden">
                         <b class="truncate block text-lg">{{m.name}}</b>
                         <p class="text-xs text-gray-400 truncate">{{m.phone}}</p>
                         <p v-if="m.notes" class="text-xs text-indigo-600 mt-1 truncate bg-indigo-50 px-2 py-0.5 rounded inline-block"><i class="fa-solid fa-tag mr-1"></i>{{m.notes}}</p>
                     </div>
                 </div>
             </div>
        </div>

        <div v-show="currentTab === 'dashboard'" class="max-w-4xl mx-auto animate-fade-in-up">
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-white p-5 rounded-2xl shadow-sm border-l-4 border-indigo-500"><h3 class="text-sm text-slate-500 mb-1">ä»Šæ—¥ä¾†å®¢ (AI)</h3><span class="text-3xl font-bold text-indigo-600">{{stats.todayVisits}}</span></div>
                <div class="bg-white p-5 rounded-2xl shadow-sm border-l-4 border-emerald-500"><h3 class="text-sm text-slate-500 mb-1">æœƒå“¡ç¸½æ•¸</h3><span class="text-3xl font-bold text-emerald-600">{{members.length}}</span></div>
            </div>
        </div>
    </main>

    <div v-if="modals.register || modals.form" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-fade-in-up">
        <div class="bg-white w-full max-w-md rounded-3xl max-h-[90vh] flex flex-col shadow-2xl">
            <div class="px-6 py-4 bg-indigo-600 text-white flex justify-between items-center">
                <h3 class="font-bold text-lg">{{ modals.register ? 'ç”³è«‹åŠ å…¥æœƒå“¡' : 'ç·¨è¼¯è³‡æ–™' }}</h3>
                <button @click="closeModals" class="text-white/80 hover:text-white"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div class="p-6 overflow-y-auto space-y-4 flex-1">
                <div v-if="modals.register" class="bg-slate-50 p-4 rounded-xl border border-slate-200 mb-2">
                    <p class="text-xs text-slate-400 font-bold mb-2">æœƒå“¡æ¢æ¬¾</p>
                    <button @click="modals.privacy = true" class="w-full py-2 bg-white border border-indigo-200 text-indigo-600 rounded-lg text-xs font-bold shadow-sm hover:bg-indigo-50 flex items-center justify-center gap-2">
                        <i class="fa-solid fa-file-contract"></i> é–±è®€æ¢æ¬¾
                    </button>
                    <div class="flex items-center gap-2 mt-3 pt-2 border-t border-slate-200">
                        <input type="checkbox" id="agree_chk" v-model="registerForm.agree" :disabled="!registerForm.hasRead" class="w-4 h-4 rounded accent-indigo-600 disabled:opacity-50">
                        <label for="agree_chk" class="text-sm font-bold" :class="registerForm.hasRead ? 'text-slate-700' : 'text-slate-400'">æˆ‘åŒæ„æ¢æ¬¾</label>
                    </div>
                </div>
                
                <div class="grid gap-4" :class="{'opacity-50 pointer-events-none': modals.register && !registerForm.agree}">
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase">å§“å</label>
                        <input v-model="activeForm.name" type="text" class="w-full border-2 border-slate-200 p-2.5 rounded-xl mt-1 focus:border-indigo-500 outline-none">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase">é›»è©±</label>
                        <input v-model="activeForm.phone" type="tel" class="w-full border-2 border-slate-200 p-2.5 rounded-xl mt-1 focus:border-indigo-500 outline-none">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase">å‚™è¨» (Notes)</label>
                        <textarea v-model="activeForm.notes" rows="2" placeholder="ä¾‹å¦‚ï¼šVIP, å–œæ­¡é çª—..." class="w-full border-2 border-slate-200 p-2.5 rounded-xl mt-1 focus:border-indigo-500 outline-none resize-none"></textarea>
                    </div>
                    
                    <div class="flex gap-4 items-center mt-2">
                        <img v-if="activePhoto" :src="activePhoto" class="w-16 h-16 rounded object-cover border bg-gray-50">
                        <button @click="startScanForForm" class="flex-1 py-3 bg-slate-100 hover:bg-slate-200 rounded-xl font-bold text-slate-600 text-sm flex items-center justify-center gap-2 transition">
                            <i class="fa-solid fa-camera"></i> {{ activeForm.face_descriptor ? 'é‡æ‹ç…§ç‰‡' : 'æ‹æ”äººè‡‰' }}
                        </button>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t bg-slate-50 flex gap-3">
                <button v-if="modals.form" @click="deleteMember" class="px-4 py-3 text-rose-500 font-bold bg-rose-50 rounded-xl hover:bg-rose-100">åˆªé™¤</button>
                <button @click="submitForm" :disabled="modals.register && !registerForm.agree" class="flex-1 py-3 bg-indigo-600 text-white rounded-xl shadow-lg font-bold disabled:opacity-50 hover:bg-indigo-700">å„²å­˜è³‡æ–™</button>
            </div>
        </div>
    </div>

    <div v-if="modals.privacy" class="fixed inset-0 bg-black/80 z-[70] flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-lg rounded-2xl flex flex-col max-h-[80vh]">
            <div class="p-4 border-b font-bold text-lg">æœƒå“¡æœå‹™æ¢æ¬¾</div>
            <div class="p-6 overflow-y-auto text-sm text-slate-600 leading-relaxed">
                <p>1. æœ¬ç³»çµ±è’é›†æ‚¨çš„å§“åã€é›»è©±åŠäººè‡‰ç‰¹å¾µï¼Œç”¨æ–¼èº«åˆ†è­˜åˆ¥ã€‚</p>
                <p>2. æ‚¨æœ‰æ¬Šéš¨æ™‚è¦æ±‚åˆªé™¤è³‡æ–™ã€‚</p>
                <p>3. ç³»çµ±å°‡è‡ªå‹•è¨˜éŒ„æ‚¨çš„åˆ°è¨ªæ™‚é–“ã€‚</p>
            </div>
            <div class="p-4 border-t">
                <button @click="confirmPrivacy" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700">åŒæ„ä¸¦ç¹¼çºŒ</button>
            </div>
        </div>
    </div>

    <div v-show="modals.faceScan" class="fixed inset-0 bg-black z-[60] flex flex-col">
        <div class="absolute top-0 w-full z-30 p-4 flex justify-between bg-gradient-to-b from-black/60 to-transparent">
            <select v-model="currentDeviceId" @change="handleCameraSwitch" class="bg-black/40 text-white border border-white/20 py-2 pl-4 pr-10 rounded-full text-sm backdrop-blur-md outline-none appearance-none">
                <option value="">è‡ªå‹•é¸æ“‡é¡é ­</option>
                <option v-for="cam in videoDevices" :key="cam.deviceId" :value="cam.deviceId">{{ cam.label || 'Camera' }}</option>
            </select>
            <button @click="stopFaceScan" class="w-10 h-10 rounded-full bg-white/20 backdrop-blur-md text-white"><i class="fa-solid fa-times"></i></button>
        </div>
        
        <div id="video-container" class="flex-1 relative flex items-center justify-center bg-black">
            <video id="video" autoplay muted playsinline></video>
            <div class="absolute w-64 h-64 border-2 border-white/30 rounded-3xl overflow-hidden"><div class="scan-line"></div></div>
            
            <div v-if="scanMessage.show" class="absolute bottom-24 left-4 right-4 text-center animate-bounce">
                <div class="inline-block px-6 py-4 rounded-2xl shadow-2xl backdrop-blur-md border border-white/20"
                     :class="scanMessage.type === 'member' ? 'bg-emerald-500/90 text-white' : 'bg-slate-500/90 text-white'">
                    <div class="text-2xl font-black flex items-center justify-center gap-2">
                        <i class="fa-solid" :class="scanMessage.type === 'member' ? 'fa-circle-check' : 'fa-user-clock'"></i>
                        {{ scanMessage.title }}
                    </div>
                    <div v-if="scanMessage.subtitle" class="text-sm font-bold mt-1 opacity-90 bg-black/10 px-2 py-0.5 rounded inline-block">
                        {{ scanMessage.subtitle }}
                    </div>
                </div>
            </div>
            
            <div class="absolute bottom-8 text-white/50 text-xs w-full text-center">AI Running @ {{ fps }} FPS</div>
        </div>
    </div>
    
    <div v-if="modals.io" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl text-center">
            <h3 class="font-bold text-lg mb-4">è³‡æ–™ç®¡ç†</h3>
            <div class="space-y-3">
                <button @click="exportFastExcel" class="w-full py-3 bg-emerald-50 text-emerald-700 rounded-xl font-bold border border-emerald-200 hover:bg-emerald-100 flex items-center justify-center gap-2">
                    <i class="fa-solid fa-download"></i> åŒ¯å‡º (å«å‚™è¨»)
                </button>
                <div class="relative w-full py-3 bg-indigo-50 text-indigo-700 rounded-xl font-bold border border-indigo-200 hover:bg-indigo-100 flex items-center justify-center gap-2 cursor-pointer group">
                    <i class="fa-solid fa-upload"></i> åŒ¯å…¥ (å«å‚™è¨»)
                    <input type="file" accept=".xlsx, .xls" @change="handleImport" class="absolute inset-0 opacity-0 cursor-pointer" :disabled="isImporting">
                </div>
                <p class="text-[10px] text-slate-400">Excel æ ¼å¼: å§“å, é›»è©±, å‚™è¨»</p>
            </div>
            <button @click="modals.io=false" class="mt-6 text-gray-400 py-2">é—œé–‰</button>
        </div>
    </div>

</div>

<script>
const { createApp, ref, computed, onMounted, reactive, watch } = Vue;

const app = createApp({
    setup() {
        const config = reactive({ url: '', key: '', adminPwd: '' });
        const isConfigured = ref(false);
        const members = ref([]);
        const toasts = ref([]);
        
        const isLoading = ref(false);
        const currentTab = ref('self_service');
        const searchQuery = ref('');
        const modals = reactive({ form: false, faceScan: false, io: false, register: false, privacy: false });
        const tabs = [
            {id:'self_service', label:'é¦–é ', icon:'fa-solid fa-home'},
            {id:'list', label:'æœƒå“¡åˆ—è¡¨', icon:'fa-solid fa-list-ul'},
            {id:'dashboard', label:'åˆ†æ', icon:'fa-solid fa-chart-line'},
        ];

        // ğŸ“Œ æ›´æ–°è¡¨å–®çµæ§‹ï¼šç§»é™¤ birthdayï¼Œä¿ç•™ notes
        const form = reactive({ id: null, name: '', phone: '', notes: '', photo: null, search_history: [], face_descriptor: null });
        const registerForm = reactive({ name: '', phone: '', notes: '', photo: null, face_descriptor: null, agree: false, hasRead: false });
        const activeForm = computed(() => modals.register ? registerForm : form);
        const activePhoto = computed(() => modals.register ? registerForm.photo : form.photo);

        // AI ç‹€æ…‹
        const isFaceModelLoaded = ref(false);
        const verifyStatus = ref('idle');
        const verifiedMember = ref(null);
        const searchMode = ref(''); // ç©ºå­—ä¸²ç‚ºé è¨­é¦–é 
        const selfServiceInput = ref('');
        
        // ğŸ“Œ æƒæè¨Šæ¯ç‰©ä»¶ (æ§åˆ¶é¡¯ç¤ºå§“å+å‚™è¨»)
        const scanMessage = reactive({ show: false, title: '', subtitle: '', type: 'member' });
        const fps = ref(0);
        
        // ğŸ“Œ è¨˜éŒ„æœƒå“¡ä¸Šæ¬¡æƒææ™‚é–“ (Map<MemberId, Timestamp>)
        const memberCooldowns = reactive({});
        // è¨˜éŒ„ä¸Šæ¬¡æœªçŸ¥è¨ªå®¢æƒææ™‚é–“ï¼Œé¿å…åˆ·å±
        const lastUnknownScan = ref(0);

        const videoDevices = ref([]);
        const currentDeviceId = ref('');
        
        let supabase = null;
        let faceMatcher = null;
        let videoStream = null;
        let isScanning = false;
        let lastScanTime = 0;
        let frameCount = 0;
        let lastFpsTime = 0;
        let audioContext = null;

        // --- å·¥å…· ---
        const showToast = (msg, type='success', title='æç¤º') => {
            const id = Date.now();
            toasts.value.push({ id, msg, type, title });
            setTimeout(() => toasts.value = toasts.value.filter(t => t.id !== id), 3000);
        };

        const playSound = (type) => {
            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            if (audioContext.state === 'suspended') audioContext.resume();
            const osc = audioContext.createOscillator(); const gain = audioContext.createGain();
            osc.connect(gain); gain.connect(audioContext.destination);
            osc.type = type === 'success' ? 'sine' : 'square';
            osc.frequency.setValueAtTime(type==='success'?880:150, audioContext.currentTime);
            gain.gain.setValueAtTime(0.1, audioContext.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.3);
            osc.start(); osc.stop(audioContext.currentTime + 0.3);
        };

        const unlockAudio = () => { if(!audioContext) playSound('success'); };

        onMounted(async () => {
            const saved = localStorage.getItem('supabase_config_v5');
            if(saved) {
                try { Object.assign(config, JSON.parse(saved)); if(config.url) initSupabase(); } 
                catch(e) { console.error(e); }
            }
            const URL = 'https://justadudewhohacks.github.io/face-api.js/models';
            try {
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(URL)
                ]);
                isFaceModelLoaded.value = true;
            } catch(e) { showToast('AI æ¨¡å‹è¼‰å…¥å¤±æ•—', 'error'); }
            
            try {
                await navigator.mediaDevices.getUserMedia({ video: true });
                const devices = await navigator.mediaDevices.enumerateDevices();
                videoDevices.value = devices.filter(d => d.kind === 'videoinput');
                const back = videoDevices.value.find(d => d.label.toLowerCase().includes('back'));
                if(back) currentDeviceId.value = back.deviceId;
            } catch(e) {}
        });

        const initSupabase = () => {
            if(!config.url || !config.key) return;
            try {
                supabase = window.supabase.createClient(config.url, config.key);
                isConfigured.value = true;
                fetchMembers();
            } catch(e) { showToast('é€£ç·šå¤±æ•—', 'error'); }
        };

        const fetchMembers = async () => {
            if(!supabase) return;
            isLoading.value = true;
            const { data, error } = await supabase.from('members').select('*').order('updated_at', {ascending:false});
            if(error) { showToast(error.message, 'error'); }
            else {
                members.value = data || [];
                if(members.value.length > 0) {
                    const labeled = members.value
                        .filter(m => m.face_descriptor)
                        .map(m => new faceapi.LabeledFaceDescriptors(m.id, [new Float32Array(m.face_descriptor)]));
                    if(labeled.length) faceMatcher = new faceapi.FaceMatcher(labeled, 0.45);
                }
            }
            isLoading.value = false;
        };

        const stopFaceScan = () => {
            isScanning = false;
            modals.faceScan = false;
            scanMessage.show = false; // é—œé–‰è¨Šæ¯
            if(videoStream) { videoStream.getTracks().forEach(t => t.stop()); videoStream = null; }
        };

        const closeModals = () => {
            modals.form = false; modals.register = false; modals.faceScan = false; modals.io = false;
            stopFaceScan();
        };

        const submitForm = async () => {
            const target = modals.register ? registerForm : form;
            if(!target.name || !target.phone) return showToast('è«‹å¡«å¯«å®Œæ•´è³‡æ–™', 'warning');
            
            isLoading.value = true;
            try {
                const payload = { ...target };
                delete payload.agree; delete payload.hasRead; 
                
                if(!modals.register && payload.id) {
                    const { error } = await supabase.from('members').update({...payload, updated_at: new Date()}).eq('id', payload.id);
                    if(error) throw error;
                    showToast('æ›´æ–°æˆåŠŸ');
                } else {
                    payload.id = Date.now().toString();
                    payload.created_at = new Date();
                    payload.updated_at = new Date();
                    const { error } = await supabase.from('members').insert(payload);
                    if(error) throw error;
                    showToast('è¨»å†ŠæˆåŠŸ');
                }
                closeModals();
                fetchMembers();
            } catch(e) { showToast(e.message, 'error'); }
            finally { isLoading.value = false; }
        };

        const deleteMember = async () => {
            if(!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) return;
            const { error } = await supabase.from('members').delete().eq('id', form.id);
            if(error) showToast('åˆªé™¤å¤±æ•—', 'error');
            else { showToast('å·²åˆªé™¤'); closeModals(); fetchMembers(); }
        };

        const confirmPrivacy = () => { registerForm.hasRead = true; registerForm.agree = true; modals.privacy = false; };

        // --- AI æƒææ ¸å¿ƒ (V5.2 æ ¸å¿ƒæ›´æ–°) ---
        const startVideo = async () => {
            if(!isFaceModelLoaded.value) { showToast('AI åˆå§‹åŒ–ä¸­...', 'warning'); return null; }
            const v = document.getElementById('video');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { deviceId: currentDeviceId.value ? { exact: currentDeviceId.value } : undefined, width: { ideal: 640 }, height: { ideal: 480 } } 
                });
                v.srcObject = stream;
                videoStream = stream;
                return new Promise(resolve => v.onloadedmetadata = () => { v.play(); resolve(v); });
            } catch(e) { showToast('ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿ', 'error'); return null; }
        };

        const scanningLoop = async (video) => {
            if(!isScanning || !modals.faceScan) return;

            const now = Date.now();
            if(now - lastFpsTime >= 1000) { fps.value = frameCount; frameCount = 0; lastFpsTime = now; }
            frameCount++;

            try {
                const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions({ inputSize: 224, scoreThreshold: 0.5 }))
                    .withFaceLandmarks().withFaceDescriptor();

                if(detection) {
                    // --- è¨»å†Šæ¨¡å¼ ---
                    if(app.scanMode === 'register') {
                        isScanning = false;
                        const canvas = document.createElement('canvas');
                        const box = detection.detection.box;
                        const pad = 50;
                        canvas.width = 300; canvas.height = 300;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(video, box.x - pad, box.y - pad, box.width + (pad*2), box.height + (pad*2), 0, 0, 300, 300);
                        
                        const photo = canvas.toDataURL('image/jpeg', 0.8);
                        const desc = Array.from(detection.descriptor);
                        
                        if(modals.register) { registerForm.photo = photo; registerForm.face_descriptor = desc; }
                        else { form.photo = photo; form.face_descriptor = desc; }
                        
                        playSound('success');
                        stopFaceScan();
                        return;
                    }
                    
                    // --- é¦–é é€£çºŒæƒææ¨¡å¼ (æ ¸å¿ƒæ›´æ–°) ---
                    if(app.scanMode === 'homepage_scan') {
                        // 1. è¾¨è­˜æœƒå“¡
                        if(faceMatcher) {
                            const match = faceMatcher.findBestMatch(detection.descriptor);
                            
                            // A. è¾¨è­˜åˆ°æœƒå“¡
                            if(match.label !== 'unknown') {
                                const member = members.value.find(m => m.id === match.label);
                                if(member) {
                                    const lastTime = memberCooldowns[member.id] || 0;
                                    // â±ï¸ 3åˆ†é˜å†·å»æª¢æŸ¥ (3 * 60 * 1000 = 180000 ms)
                                    if (now - lastTime > 180000) {
                                        // æ›´æ–°å†·å»æ™‚é–“
                                        memberCooldowns[member.id] = now;
                                        
                                        playSound('success');
                                        
                                        // é¡¯ç¤º UIï¼šå§“å + å‚™è¨»
                                        scanMessage.type = 'member';
                                        scanMessage.title = member.name;
                                        scanMessage.subtitle = member.notes || '';
                                        scanMessage.show = true;
                                        
                                        // 3ç§’å¾Œéš±è—è¨Šæ¯
                                        setTimeout(() => { if(scanMessage.title === member.name) scanMessage.show = false; }, 3000);

                                        // å¯«å…¥è³‡æ–™åº«è¨˜éŒ„
                                        const history = member.search_history || [];
                                        history.push({ timestamp: new Date().toISOString() });
                                        supabase.from('members').update({ search_history: history }).eq('id', member.id).then();
                                    }
                                }
                            } 
                            // B. è¾¨è­˜ç‚ºé™Œç”Ÿäºº (æ–°å®¢äºº)
                            else {
                                // é™Œç”Ÿäººé˜²åˆ·å± (æ¯ 5 ç§’æç¤ºä¸€æ¬¡)
                                if(now - lastUnknownScan.value > 5000) {
                                    lastUnknownScan.value = now;
                                    // playSound('square'); // å¯é¸æ“‡æ˜¯å¦é–‹å•Ÿé™Œç”ŸäººéŸ³æ•ˆ
                                    
                                    scanMessage.type = 'guest';
                                    scanMessage.title = 'ğŸ‘‹ æ­¡è¿ æ–°å®¢äºº';
                                    scanMessage.subtitle = 'è«‹æ´½æ«ƒå°è¨»å†Š';
                                    scanMessage.show = true;
                                    
                                    setTimeout(() => { if(scanMessage.type === 'guest') scanMessage.show = false; }, 2500);
                                }
                            }
                        }
                    }
                }
            } catch(e) { console.error(e); }

            if(isScanning) requestAnimationFrame(() => scanningLoop(video));
        };

        const startScan = async (mode) => {
            app.scanMode = mode; 
            modals.faceScan = true;
            isScanning = true;
            scanMessage.show = false; // é‡ç½®è¨Šæ¯
            const video = await startVideo();
            if(video) scanningLoop(video);
        };

        const performVerification = () => {
            const val = selfServiceInput.value.trim();
            if(!val) return showToast('è«‹è¼¸å…¥å…§å®¹', 'warning');
            
            const member = members.value.find(m => 
                (searchMode.value === 'phone' && m.phone === val) || 
                (searchMode.value === 'name' && m.name === val)
            );

            if(member) {
                verifyStatus.value = 'success';
                verifiedMember.value = member;
                playSound('success');
            } else {
                verifyStatus.value = 'fail';
                playSound('fail');
                setTimeout(() => verifyStatus.value = 'idle', 2000);
            }
        };

        const resetSelfService = () => { verifyStatus.value = 'idle'; selfServiceInput.value = ''; verifiedMember.value = null; };
        
        const isExporting = ref(false);
        const exportFastExcel = async () => {
            isExporting.value = true;
            try {
                const wb = new ExcelJS.Workbook();
                const ws = wb.addWorksheet('Members');
                // ğŸ“Œ Excel æ›´æ–°ï¼šNotes
                ws.columns = [{header:'ID',key:'id'}, {header:'Name',key:'name'}, {header:'Phone',key:'phone'}, {header:'Notes',key:'notes'}, {header:'Created',key:'created_at'}];
                members.value.forEach(m => ws.addRow(m));
                const buffer = await wb.xlsx.writeBuffer();
                saveAs(new Blob([buffer]), `members_v5.2.xlsx`);
                showToast('åŒ¯å‡ºå®Œæˆ');
            } catch(e) { showToast('åŒ¯å‡ºå¤±æ•—', 'error'); }
            finally { isExporting.value = false; }
        };

        const isImporting = ref(false);
        const handleImport = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            isImporting.value = true;
            try {
                const buffer = await file.arrayBuffer();
                const wb = new ExcelJS.Workbook();
                await wb.xlsx.load(buffer);
                const ws = wb.getWorksheet(1);
                
                const newMembers = [];
                ws.eachRow((row, rowNumber) => {
                    if(rowNumber > 1) {
                        const name = row.getCell(1).text;
                        const phone = row.getCell(2).text;
                        const notes = row.getCell(3).text; // ğŸ“Œ è®€å–ç¬¬ä¸‰æ¬„ä½œç‚ºå‚™è¨»
                        if(name && phone) {
                            newMembers.push({
                                id: Date.now().toString() + Math.random().toString(36).substr(2, 5),
                                name: name,
                                phone: phone,
                                notes: notes || '',
                                created_at: new Date(),
                                updated_at: new Date()
                            });
                        }
                    }
                });

                if(newMembers.length > 0) {
                    const { error } = await supabase.from('members').insert(newMembers);
                    if(error) throw error;
                    showToast(`æˆåŠŸåŒ¯å…¥ ${newMembers.length} ç­†`);
                    fetchMembers();
                    modals.io = false;
                } else { showToast('ç„¡æœ‰æ•ˆè³‡æ–™', 'warning'); }
            } catch(e) { showToast('åŒ¯å…¥å¤±æ•—: ' + e.message, 'error'); } 
            finally { isImporting.value = false; e.target.value = ''; }
        };

        const saveConfig = () => { localStorage.setItem('supabase_config_v5', JSON.stringify(config)); initSupabase(); };
        const resetConfigSecure = () => { if(prompt("å¯†ç¢¼")===(config.adminPwd||'0000')) { localStorage.removeItem('supabase_config_v5'); location.reload(); } };

        const filteredMembers = computed(() => {
            if(!searchQuery.value) return members.value;
            const q = searchQuery.value.toLowerCase();
            return members.value.filter(m => m.name.toLowerCase().includes(q) || m.phone.includes(q) || (m.notes && m.notes.toLowerCase().includes(q)));
        });

        const stats = computed(() => {
            const today = new Date().toISOString().slice(0,10);
            const visits = members.value.reduce((acc, m) => acc + (m.search_history?.filter(h => h.timestamp.startsWith(today)).length || 0), 0);
            return { todayVisits: visits };
        });

        app.scanMode = ''; 
        return {
            config, isConfigured, saveConfig, resetConfigSecure, checkAdmin: (cb) => { const p=prompt('Pwd?'); if(p===(config.adminPwd||'0000'))cb(); else alert('Err'); },
            members, filteredMembers, isLoading, isExporting, isImporting, exportFastExcel, handleImport,
            currentTab, tabs, modals, closeModals, confirmPrivacy,
            form, registerForm, activeForm, activePhoto, submitForm, deleteMember,
            openAdminAdd: () => { Object.assign(form, {id:null,name:'',phone:'',notes:'',photo:null,face_descriptor:null}); modals.form=true; modals.register=false; },
            editMember: (m) => { Object.assign(form, JSON.parse(JSON.stringify(m))); modals.form=true; modals.register=false; },
            openSelfRegister: () => { Object.assign(registerForm, {name:'',phone:'',notes:'',photo:null,face_descriptor:null, agree:false, hasRead:false}); modals.register=true; modals.form=false; },
            startScanForForm: () => startScan('register'),
            // ğŸ“Œ å•Ÿå‹•é¦–é é€£çºŒæƒæ
            startHomepageScan: () => startScan('homepage_scan'),
            stopFaceScan, handleCameraSwitch: async () => { if(videoStream) { stopFaceScan(); await startScan(app.scanMode); } },
            selfServiceInput, searchMode, verifyStatus, verifiedMember, performVerification, resetSelfService,
            stats, isFaceModelLoaded, videoDevices, currentDeviceId, scanMessage, fps,
            unlockAudio, toasts
        };
    }
});

app.mount('#app');
</script>
</body>
</html>
