<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI 會員人臉辨識系統 V6.7</title>
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            margin: 0;
            overscroll-behavior: none; /* 防止手機下拉重新整理 */
        }

        h2 { margin-bottom: 10px; font-size: 1.5rem; text-align: center; }

        /* 相機容器 */
        .camera-container {
            position: relative;
            width: 100%;
            max-width: 640px;
            aspect-ratio: 4/3;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            margin-bottom: 15px;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        /* 只有這個 class 存在時才鏡像翻轉 (用於前鏡頭) */
        video.mirrored {
            transform: scaleX(-1);
            -webkit-transform: scaleX(-1);
        }

        /* 畫布覆蓋層 */
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none; /* 讓點擊事件穿透到 video */
        }

        /* 狀態顯示區 */
        #status-panel {
            width: 90%;
            max-width: 600px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
            margin-bottom: 15px;
        }

        .status-text {
            font-size: 1.1rem;
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }
        
        .status-loading { color: #e67e22; }
        .status-member { color: #27ae60; }
        .status-unknown { color: #c0392b; }
        
        #recognitionResult {
            font-size: 0.9rem;
            color: #666;
            line-height: 1.4;
        }

        /* 按鈕區 */
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
        }

        button {
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            color: white;
            font-weight: 600;
            touch-action: manipulation; /* 優化觸控反應 */
        }

        .btn-switch { background-color: #3498db; }
        .btn-register { background-color: #2ecc71; }
        
        button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }

        /* 手機版面優化 */
        @media (max-width: 480px) {
            .camera-container { border-radius: 8px; }
            button { flex: 1; min-width: 120px; }
        }
    </style>
</head>
<body>

    <h2>AI 會員人臉辨識系統</h2>

    <div class="camera-container">
        <video id="video" autoplay playsinline muted></video>
    </div>

    <div id="status-panel">
        <span id="systemStatus" class="status-text status-loading">系統初始化中...</span>
        <div id="recognitionResult">正在連接模型伺服器...</div>
    </div>

    <div class="controls">
        <button id="switchCameraBtn" class="btn-switch" onclick="switchCamera()">切換前後鏡頭</button>
        <button id="registerBtn" class="btn-register" onclick="registerCurrentFace()" disabled>註冊會員</button>
    </div>

    <script>
        const video = document.getElementById('video');
        const systemStatus = document.getElementById('systemStatus');
        const recognitionResult = document.getElementById('recognitionResult');
        const registerBtn = document.getElementById('registerBtn');
        let canvas;

        // 狀態變數
        let currentFacingMode = 'user'; // 預設前鏡頭
        let isModelLoaded = false;
        let labeledFaceDescriptors = []; 
        let faceMatcher = null; 

        // 嚴格模式：0.45 (數值越小越嚴格，解決誤判問題)
        const MATCH_THRESHOLD = 0.45; 

        // 1. 初始化：載入模型 (改用 CDN 解決 TypeError)
        async function loadModels() {
            try {
                systemStatus.innerText = "正在下載 AI 模型...";
                
                // --- 關鍵修正：使用穩定的線上 CDN 路徑 ---
                // 這解決了手機找不到 './models' 資料夾導致的 TypeError
                const modelPath = 'https://justadudewhohacks.github.io/face-api.js/models';

                await Promise.all([
                    faceapi.nets.ssdMobilenetv1.loadFromUri(modelPath),
                    faceapi.nets.faceLandmark68Net.loadFromUri(modelPath),
                    faceapi.nets.faceRecognitionNet.loadFromUri(modelPath)
                ]);

                isModelLoaded = true;
                systemStatus.innerText = "模型載入完成，啟動相機...";
                systemStatus.className = "status-text";
                startCamera();

            } catch (error) {
                console.error("模型載入失敗:", error);
                systemStatus.innerText = "錯誤：無法載入模型";
                recognitionResult.innerText = "請檢查網路連線 (TypeError: Failed to fetch)";
                systemStatus.className = "status-text status-unknown";
            }
        }

        // 2. 啟動相機 (修正畫面翻轉邏輯)
        async function startCamera() {
            // 停止舊串流 (防止切換時黑屏)
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }

            const constraints = {
                video: {
                    facingMode: currentFacingMode,
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            };

            try {
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                
                // 等待影片載入 metadata 確保尺寸正確
                video.onloadedmetadata = () => {
                    video.play();
                    // --- 修正畫面翻轉 ---
                    if (currentFacingMode === 'user') {
                        video.classList.add('mirrored'); // 前鏡頭：翻轉
                    } else {
                        video.classList.remove('mirrored'); // 後鏡頭：正常
                    }
                };

            } catch (err) {
                console.error("相機錯誤:", err);
                systemStatus.innerText = "無法存取相機";
                recognitionResult.innerText = "請確認瀏覽器已授權相機權限 (HTTPS Required)";
                systemStatus.className = "status-text status-unknown";
            }
        }

        // 3. 核心偵測邏輯
        video.addEventListener('play', () => {
            // 避免重複建立 canvas
            const container = document.querySelector('.camera-container');
            if (document.querySelector('canvas')) {
                document.querySelector('canvas').remove();
            }
            canvas = faceapi.createCanvasFromMedia(video);
            container.append(canvas);
            
            const displaySize = { width: video.videoWidth, height: video.videoHeight };
            faceapi.matchDimensions(canvas, displaySize);

            // 啟動迴圈
            setInterval(async () => {
                if (!isModelLoaded || video.paused || video.ended) return;

                // 更新畫布尺寸 (應對手機旋轉)
                const currentDisplaySize = { width: video.videoWidth, height: video.videoHeight };
                if (canvas.width !== currentDisplaySize.width) {
                    faceapi.matchDimensions(canvas, currentDisplaySize);
                }

                // 偵測
                const detections = await faceapi.detectAllFaces(video, new faceapi.SsdMobilenetv1Options({ minConfidence: 0.5 }))
                    .withFaceLandmarks()
                    .withFaceDescriptors();

                const resizedDetections = faceapi.resizeResults(detections, currentDisplaySize);
                
                // 清空畫布
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // 如果資料庫是空的 -> 全部視為陌生人
                if (labeledFaceDescriptors.length === 0) {
                    if (detections.length > 0) {
                        // 畫預設框
                        faceapi.draw.drawDetections(canvas, resizedDetections);
                        updateUI("unknown", 0);
                    } else {
                        recognitionResult.innerText = "偵測中...請注視鏡頭";
                        registerBtn.disabled = true;
                        systemStatus.innerText = "監控中";
                        systemStatus.className = "status-text";
                    }
                    return;
                }

                // 建立比對器
                if (!faceMatcher) {
                    faceMatcher = new faceapi.FaceMatcher(labeledFaceDescriptors, MATCH_THRESHOLD);
                }

                const results = resizedDetections.map(d => faceMatcher.findBestMatch(d.descriptor));

                results.forEach((result, i) => {
                    const box = resizedDetections[i].detection.box;
                    const { label, distance } = result;

                    // 繪製結果框
                    // 注意：若前鏡頭翻轉，Canvas 的繪製不需要手動翻轉，因為它對應的是 video 座標
                    const drawBox = new faceapi.draw.DrawBox(box, { 
                        label: label === 'unknown' ? "陌生人" : `${label} (${Math.round((1-distance)*100)}%)` 
                    });
                    drawBox.draw(canvas);

                    updateUI(label, distance);
                });

            }, 200); // 稍微放寬到 200ms 節省手機效能
        });

        // 4. UI 更新邏輯
        function updateUI(label, distance) {
            if (label === 'unknown') {
                systemStatus.innerText = "偵測到陌生訪客";
                systemStatus.className = "status-text status-unknown";
                recognitionResult.innerHTML = `身份未確認 <br> 請點擊下方按鈕註冊`;
                registerBtn.disabled = false; // 允許註冊
            } else {
                systemStatus.innerText = `歡迎會員：${label}`;
                systemStatus.className = "status-text status-member";
                const score = Math.round((1 - distance) * 100);
                recognitionResult.innerHTML = `識別成功 (信心度: ${score}%)`;
                registerBtn.disabled = true; // 禁止重複註冊
            }
        }

        // 5. 註冊功能
        async function registerCurrentFace() {
            if (!video.srcObject) return;
            registerBtn.disabled = true; // 防止連點

            const name = prompt("請輸入會員姓名以完成註冊：");
            if (!name) {
                registerBtn.disabled = false;
                return;
            }

            systemStatus.innerText = "正在分析特徵...";
            
            // 擷取單一人臉
            const detection = await faceapi.detectSingleFace(video, new faceapi.SsdMobilenetv1Options())
                .withFaceLandmarks()
                .withFaceDescriptor();
            
            if (detection) {
                const newDescriptor = new faceapi.LabeledFaceDescriptors(name, [detection.descriptor]);
                labeledFaceDescriptors.push(newDescriptor);
                
                // 重建比對器
                faceMatcher = new faceapi.FaceMatcher(labeledFaceDescriptors, MATCH_THRESHOLD);
                
                alert(`註冊成功！歡迎 ${name}`);
            } else {
                alert("註冊失敗：未偵測到清晰人臉，請靠近鏡頭重試。");
                registerBtn.disabled = false;
            }
        }

        // 6. 切換鏡頭
        function switchCamera() {
            currentFacingMode = (currentFacingMode === 'user') ? 'environment' : 'user';
            startCamera();
        }

        // 啟動
        window.onload = loadModels;

    </script>
</body>
</html>
