<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <title>AI 智能會員系統 V7.3 (POS 最終版)</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; overscroll-behavior: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .tab-btn { position: relative; color: #64748b; transition: all 0.3s; }
        .tab-active { color: #4f46e5; font-weight: bold; }
        .tab-active::after { content: ''; position: absolute; bottom: -12px; left: 0; width: 100%; height: 3px; background: #4f46e5; border-radius: 3px 3px 0 0; }
        
        @keyframes fadeInUp { from { opacity: 0; transform: translate3d(0, 20px, 0); } to { opacity: 1; transform: none; } }
        .animate-fade-in-up { animation: fadeInUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        
        .numpad-btn { transition: all 0.1s; box-shadow: 0 4px 0 #cbd5e1; }
        .numpad-btn:active { transform: translateY(4px); box-shadow: 0 0 0 #cbd5e1; }
        
        #video-container video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); } /* 鏡像翻轉對體驗較好 */
        /* 移除對 Video 的模糊濾鏡以提高 AI 準確率，僅保留飽和度調整 */
        .beauty-filter { filter: saturate(1.1) brightness(1.1) contrast(1.05); }
        
        .scan-line { position: absolute; width: 100%; height: 2px; background: #4f46e5; box-shadow: 0 0 15px #4f46e5; animation: scanning 2s infinite ease-in-out; }
        @keyframes scanning { 0% {top:0; opacity: 0;} 10% {opacity: 1;} 90% {opacity: 1;} 100% {top:100%; opacity: 0;} }
        
        .list-enter-active, .list-leave-active { transition: all 0.5s ease; }
        .list-enter-from, .list-leave-to { opacity: 0; transform: translateX(30px); }
        .toast-enter-active, .toast-leave-active { transition: all 0.3s ease; }
        .toast-enter-from, .toast-leave-to { opacity: 0; transform: translateX(30px); }
    </style>
</head>
<body>

<div id="app" class="min-h-screen flex flex-col pb-safe" @click="unlockAudio">
    
    <div class="fixed top-4 right-4 z-[100] flex flex-col gap-2 pointer-events-none">
        <transition-group name="toast">
            <div v-for="toast in toasts" :key="toast.id" class="pointer-events-auto min-w-[300px] max-w-sm bg-white rounded-xl shadow-xl border-l-4 p-4 flex items-center gap-3" :class="{'border-emerald-500': toast.type==='success', 'border-rose-500': toast.type==='error', 'border-amber-500': toast.type==='warning'}">
                <i class="fa-solid text-xl" :class="{'fa-check-circle text-emerald-500': toast.type==='success', 'fa-times-circle text-rose-500': toast.type==='error', 'fa-exclamation-circle text-amber-500': toast.type==='warning'}"></i>
                <div><h4 class="font-bold text-slate-800 text-sm">{{ toast.title }}</h4><p class="text-xs text-slate-500">{{ toast.msg }}</p></div>
            </div>
        </transition-group>
    </div>

    <div v-if="!isConfigured" class="fixed inset-0 bg-slate-900 z-[99] flex items-center justify-center p-6">
        <div class="bg-white rounded-2xl p-8 w-full max-w-md shadow-2xl animate-fade-in-up">
            <h2 class="text-2xl font-bold text-slate-800 mb-6">系統初始化 V7.3</h2>
            <div class="space-y-4">
                <div><label class="text-xs font-bold text-slate-500">商店/公司名稱</label><input v-model="config.storeName" placeholder="例如：E書漫" class="w-full border-2 border-slate-200 p-3 rounded-xl focus:border-indigo-500 outline-none"></div>
                <div><label class="text-xs font-bold text-slate-500">Supabase URL</label><input v-model="config.url" class="w-full border-2 border-slate-200 p-3 rounded-xl focus:border-indigo-500 outline-none"></div>
                <div><label class="text-xs font-bold text-slate-500">Supabase Key (Anon)</label><input v-model="config.key" class="w-full border-2 border-slate-200 p-3 rounded-xl focus:border-indigo-500 outline-none"></div>
                <div><label class="text-xs font-bold text-rose-500">設定管理員密碼</label><input v-model="config.adminPwd" type="password" placeholder="預設: 0000" class="w-full border-2 border-rose-200 p-3 rounded-xl focus:border-rose-500 bg-rose-50 outline-none"></div>
                <button @click="saveConfig" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 transition">啟動系統</button>
            </div>
        </div>
    </div>

    <header class="bg-white shadow-sm sticky top-0 z-40">
        <div class="px-5 py-4 flex justify-between items-center">
            <h1 class="text-xl font-bold text-slate-800 flex items-center"><i class="fa-solid fa-cube text-indigo-600 mr-2"></i>SmartMember <span class="text-xs bg-indigo-600 text-white px-2 py-0.5 rounded ml-2 shadow-sm">POS V7.3</span></h1>
            <div class="flex gap-4 items-center">
                <button @click="toggleFullScreen" class="text-slate-300 hover:text-indigo-600 hidden sm:block"><i class="fa-solid fa-expand"></i></button>
                <button @click="resetConfigSecure" class="text-slate-300 hover:text-slate-500"><i class="fa-solid fa-gear"></i></button>
                <button @click="checkAdmin(() => modals.io = true)" class="text-slate-400 hover:text-indigo-600 transition"><i class="fa-solid fa-file-export text-xl"></i></button>
                <div class="hidden sm:flex items-center gap-2 text-xs font-bold bg-slate-100 px-3 py-1.5 rounded-full">
                    <span class="text-indigo-500 flex items-center"><i class="fa-solid fa-cloud mr-1.5"></i>Online</span>
                    <span class="w-[1px] h-3 bg-slate-300 mx-1"></span>
                    <span :class="isFaceModelLoaded ? 'text-emerald-500' : 'text-slate-400'" class="flex items-center">
                        <i class="fa-solid" :class="isFaceModelLoaded ? 'fa-brain' : 'fa-circle-notch fa-spin'"></i>
                    </span>
                </div>
            </div>
        </div>
        <div class="flex border-t border-slate-100 bg-white px-2">
            <button v-for="tab in tabs" :key="tab.id" @click="currentTab = tab.id" :class="{'tab-active': currentTab === tab.id}" class="tab-btn flex-1 py-3 text-sm flex justify-center items-center">
                <i :class="tab.icon" class="mr-1.5"></i>{{ tab.label }}
            </button>
        </div>
    </header>

    <main class="flex-grow p-4 overflow-y-auto bg-slate-50">
        
        <div v-show="currentTab === 'self_service'" class="max-w-7xl mx-auto mt-2 pb-20 h-full">
            <div class="bg-white rounded-3xl shadow-lg overflow-hidden border border-slate-100 min-h-[75vh] lg:h-[80vh] flex flex-col lg:grid lg:grid-cols-12 animate-fade-in-up">
                
                <div class="lg:col-span-5 p-8 bg-slate-50/50 flex flex-col justify-center border-b lg:border-b-0 lg:border-r border-slate-100 relative">
                    <div class="space-y-8 relative z-10">
                        <div class="text-center lg:text-left space-y-2">
                            <div class="inline-block p-3 rounded-2xl bg-indigo-100 text-indigo-600 mb-2">
                                <i class="fa-solid fa-robot text-3xl"></i>
                            </div>
                            <h2 class="text-2xl font-black text-slate-800">{{ config.storeName || '智能接待中心' }}</h2>
                            <p class="text-slate-400 text-sm">請選擇服務項目</p>
                        </div>

                        <button @click="startHomepageScan" class="w-full py-6 bg-gradient-to-r from-indigo-600 to-blue-600 text-white rounded-2xl shadow-xl hover:scale-[1.02] transition active:scale-95 flex items-center justify-center gap-4 group">
                            <div class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center group-hover:bg-white/30 transition">
                                <i class="fa-solid fa-expand text-2xl"></i>
                            </div>
                            <div class="text-left">
                                <div class="text-xl font-bold">啟動 AI 迎賓</div>
                                <div class="text-xs text-indigo-100 opacity-80">Face ID 快速通關</div>
                            </div>
                        </button>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <button @click="setSearchMode('phone')" :class="searchMode==='phone' ? 'border-indigo-500 bg-indigo-50 text-indigo-700' : 'border-slate-200 bg-white text-slate-600'" class="py-5 border-2 rounded-2xl font-bold transition hover:border-indigo-300 flex flex-col items-center gap-2">
                                <i class="fa-solid fa-mobile-screen text-2xl"></i> 電話查詢
                            </button>
                            <button @click="openSelfRegister" class="py-5 bg-white border-2 border-slate-200 rounded-2xl font-bold text-slate-600 hover:border-emerald-300 hover:text-emerald-600 hover:bg-emerald-50 transition flex flex-col items-center gap-2">
                                <i class="fa-solid fa-user-plus text-2xl"></i> 新會員註冊
                            </button>
                        </div>
                    </div>
                    <div class="absolute -bottom-10 -left-10 w-64 h-64 bg-indigo-100 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-pulse"></div>
                </div>

                <div class="lg:col-span-7 p-6 lg:p-10 flex flex-col relative bg-white">
                    
                    <div v-if="verifyStatus === 'idle' && searchMode !== 'phone'" class="flex-1 flex flex-col items-center justify-center text-slate-300 select-none">
                        <i class="fa-solid fa-store text-6xl mb-4 opacity-20"></i>
                        <p>請選擇左側功能</p>
                    </div>

                    <div v-if="searchMode === 'phone' && verifyStatus === 'idle'" class="flex-1 flex flex-col max-w-md mx-auto w-full animate-fade-in-up">
                        <div class="mb-6 text-center">
                            <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">輸入會員電話</label>
                            <input readonly :value="selfServiceInput" class="w-full text-center text-4xl font-mono font-bold py-4 border-b-2 border-indigo-100 text-indigo-600 focus:outline-none bg-transparent placeholder-slate-200 tracking-widest" placeholder="09XX...">
                        </div>
                        
                        <div class="grid grid-cols-3 gap-3 flex-1 mb-4">
                            <button v-for="n in [1,2,3,4,5,6,7,8,9]" :key="n" @click="handleKeypad(n)" class="numpad-btn bg-slate-50 text-slate-700 text-2xl font-bold rounded-xl py-4 hover:bg-slate-100 active:bg-slate-200 border border-slate-200">
                                {{ n }}
                            </button>
                            <button @click="handleKeypad('clear')" class="numpad-btn bg-rose-50 text-rose-500 text-lg font-bold rounded-xl py-4 hover:bg-rose-100 border border-rose-100">清除</button>
                            <button @click="handleKeypad(0)" class="numpad-btn bg-slate-50 text-slate-700 text-2xl font-bold rounded-xl py-4 hover:bg-slate-100 border border-slate-200">0</button>
                            <button @click="handleKeypad('del')" class="numpad-btn bg-slate-50 text-slate-500 text-xl font-bold rounded-xl py-4 hover:bg-slate-100 border border-slate-200"><i class="fa-solid fa-delete-left"></i></button>
                        </div>
                        
                        <button @click="performVerification" :disabled="isLoading || selfServiceInput.length < 4" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold text-xl shadow-lg disabled:opacity-50 disabled:shadow-none hover:bg-indigo-700 transition active:scale-[0.98]">
                             <span v-if="isLoading"><i class="fa-solid fa-circle-notch fa-spin mr-2"></i>查詢中...</span>
                             <span v-else>確認查詢</span>
                        </button>
                    </div>

                    <div v-if="verifyStatus !== 'idle'" class="flex-1 flex flex-col items-center justify-center animate-fade-in-up w-full max-w-md mx-auto">
                        <div class="w-28 h-28 rounded-full flex items-center justify-center mb-6 shadow-xl" :class="verifyStatus === 'success' ? 'bg-emerald-100 text-emerald-500' : 'bg-rose-100 text-rose-500'">
                            <i class="fa-solid text-6xl" :class="verifyStatus === 'success' ? 'fa-check' : 'fa-xmark'"></i>
                        </div>
                        
                        <h2 class="text-3xl font-black text-slate-800 mb-2">{{ verifyStatus === 'success' ? '歡迎光臨' : '查無資料' }}</h2>
                        
                        <div v-if="verifyStatus === 'success'" class="text-center w-full">
                            <p class="text-3xl font-bold text-indigo-600 mb-1">{{ verifiedMember?.name }}</p>
                            <p class="text-gray-400 text-xl mb-4 font-mono">{{ verifiedMember?.phone }}</p>
                            
                            <div v-if="verifiedMember?.notes" class="mb-6">
                                <span class="bg-indigo-50 text-indigo-600 px-4 py-2 rounded-lg font-bold text-sm border border-indigo-100 inline-block max-w-full truncate">{{ verifiedMember.notes }}</span>
                            </div>
                            
                            <div v-if="verifiedMemberPhoto" class="flex justify-center mb-6">
                                <img :src="verifiedMemberPhoto" class="w-40 h-40 rounded-2xl object-cover border-4 border-white shadow-2xl bg-gray-100 rotate-2 hover:rotate-0 transition duration-500">
                            </div>
                            <div v-else class="mb-6">
                                <button @click="editMember(verifiedMember)" class="w-full bg-indigo-50 border-2 border-dashed border-indigo-200 rounded-2xl p-4 hover:bg-indigo-100 transition group">
                                    <div class="flex items-center justify-center gap-3 text-indigo-600 font-bold">
                                        <i class="fa-solid fa-camera text-xl"></i>
                                        補拍照片啟用 AI
                                    </div>
                                </button>
                            </div>
                        </div>

                        <button @click="resetSelfService" class="w-full bg-slate-800 text-white py-4 rounded-xl font-bold text-lg mt-auto shadow-lg hover:bg-slate-900 transition flex items-center justify-center">
                            <i class="fa-solid fa-arrow-rotate-left mr-2"></i> 返回首頁 (電話查詢)
                        </button>
                    </div>

                </div>
            </div>
        </div>

        <div v-show="currentTab === 'list'" class="space-y-4 max-w-7xl mx-auto animate-fade-in-up">
             <div class="flex flex-col sm:flex-row gap-4">
                 <div class="relative group flex-1">
                     <i class="fa-solid fa-magnifying-glass absolute left-4 top-4 text-slate-400"></i>
                     <input v-model="searchQuery" @keyup.enter="searchMembers" type="text" placeholder="搜尋雲端資料庫 (姓名或電話)..." class="w-full pl-11 pr-4 py-3.5 border-0 rounded-2xl shadow-sm bg-white focus:ring-2 focus:ring-indigo-100 outline-none">
                 </div>
                 <button @click="searchMembers" class="bg-indigo-600 text-white px-8 py-3 rounded-2xl font-bold shadow hover:bg-indigo-700 transition w-full sm:w-auto">搜尋</button>
                 <button @click="openAdminAdd" class="bg-emerald-600 text-white px-8 py-3 rounded-2xl font-bold shadow hover:bg-emerald-700 transition w-full sm:w-auto flex items-center justify-center gap-2"><i class="fa-solid fa-plus"></i> 新增</button>
             </div>
             
             <div class="flex justify-between px-1">
                 <span class="text-sm text-slate-500 font-bold">最新註冊會員 (顯示前 50 筆)</span>
             </div>
             
             <div v-if="isLoadingList" class="py-20 text-center text-slate-400">
                 <i class="fa-solid fa-circle-notch fa-spin text-3xl"></i>
                 <p class="text-sm mt-3">資料讀取中...</p>
             </div>

             <div v-else class="grid gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
                 <div v-for="m in displayMembers" :key="m.id" @click="editMember(m)" class="bg-white p-5 rounded-2xl shadow-sm flex items-start gap-4 cursor-pointer border border-slate-100 hover:border-indigo-300 hover:shadow-md transition relative overflow-hidden group">
                     <div class="w-14 h-14 rounded-2xl bg-slate-100 flex items-center justify-center text-slate-500 font-bold text-xl flex-shrink-0 border border-slate-200 group-hover:bg-indigo-50 group-hover:text-indigo-600 transition">
                        {{ m.name ? m.name.charAt(0) : '?' }}
                     </div>
                     <div class="flex-1 overflow-hidden">
                         <div class="flex justify-between items-start">
                             <b class="truncate block text-lg text-slate-800">{{m.name}}</b>
                             <span class="text-[10px] text-white bg-indigo-400 px-2 py-0.5 rounded-full font-bold shadow-sm">
                                註冊: {{ formatDateSimple(m.created_at) }}
                             </span>
                         </div>
                         <p class="text-sm text-gray-400 truncate font-mono mt-0.5">{{m.phone}}</p>
                         <div class="flex gap-2 mt-2">
                             <span v-if="m.face_descriptor" class="text-[10px] bg-emerald-50 text-emerald-600 px-2 py-1 rounded-md border border-emerald-100 font-bold flex items-center"><i class="fa-solid fa-check mr-1"></i>已掃臉</span>
                             <span v-if="m.notes" class="text-[10px] bg-slate-50 text-slate-500 px-2 py-1 rounded-md border border-slate-200 truncate max-w-[100px]">{{m.notes}}</span>
                         </div>
                     </div>
                 </div>
             </div>
        </div>

        <div v-show="currentTab === 'dashboard'" class="max-w-7xl mx-auto animate-fade-in-up pb-20">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-3xl shadow-sm border-l-8 border-indigo-500 flex items-center justify-between">
                    <div>
                        <h3 class="text-sm text-slate-500 font-bold mb-1">今日來客</h3>
                        <span class="text-4xl font-black text-indigo-600">{{stats.todayVisits}}</span>
                    </div>
                    <div class="w-12 h-12 bg-indigo-50 rounded-full flex items-center justify-center text-indigo-500"><i class="fa-solid fa-users text-xl"></i></div>
                </div>
                <div class="bg-white p-6 rounded-3xl shadow-sm border-l-8 border-emerald-500 flex items-center justify-between">
                    <div>
                        <h3 class="text-sm text-slate-500 font-bold mb-1">總會員數</h3>
                        <span class="text-4xl font-black text-emerald-600">
                            {{ totalMemberCount > 0 ? totalMemberCount.toLocaleString() : '...' }}
                        </span>
                    </div>
                    <div class="w-12 h-12 bg-emerald-50 rounded-full flex items-center justify-center text-emerald-500"><i class="fa-solid fa-database text-xl"></i></div>
                </div>
            </div>
            
            <div class="mt-8 grid lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2">
                    <h3 class="font-bold text-slate-800 mb-4 flex items-center text-lg">
                        <i class="fa-solid fa-clock-rotate-left text-indigo-600 mr-2"></i>即時紀錄
                    </h3>
                    <div class="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden">
                        <div v-if="scanHistory.length === 0" class="p-10 text-center text-slate-400">
                            <span class="text-sm font-bold">尚無來客資料</span>
                        </div>
                        <ul v-else class="divide-y divide-slate-50">
                            <transition-group name="list">
                                <li v-for="log in scanHistory" :key="log.id" class="p-5 flex items-center justify-between hover:bg-slate-50 transition group">
                                    <div class="flex items-center gap-4">
                                        <div class="relative">
                                            <div class="w-12 h-12 rounded-full flex items-center justify-center text-white text-lg font-bold shadow-md" :class="log.type === 'phone' ? 'bg-indigo-400' : 'bg-emerald-400'">
                                                <i class="fa-solid" :class="log.type === 'phone' ? 'fa-phone' : 'fa-camera'"></i>
                                            </div>
                                            <div v-if="log.photo" class="absolute -top-1 -right-1 w-5 h-5 bg-white rounded-full flex items-center justify-center border border-slate-200">
                                                <img :src="log.photo" class="w-full h-full rounded-full object-cover">
                                            </div>
                                        </div>
                                        <div>
                                            <div class="font-bold text-slate-800 text-lg">{{ log.name }}</div>
                                            <div class="text-xs text-slate-400 font-mono">{{ log.phone || '無電話' }}</div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-base font-bold text-slate-600">{{ log.time }}</div>
                                        <div class="text-[10px] uppercase font-bold tracking-wider" :class="log.type === 'phone' ? 'text-indigo-400' : 'text-emerald-500'">
                                            {{ log.type === 'phone' ? 'Manual' : 'Face ID' }}
                                        </div>
                                    </div>
                                </li>
                            </transition-group>
                        </ul>
                    </div>
                </div>
                
                <div class="bg-indigo-900 rounded-3xl p-6 text-white flex flex-col justify-between shadow-xl">
                    <div>
                        <h4 class="font-bold text-indigo-200 mb-2">系統狀態</h4>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between border-b border-indigo-800 pb-2">
                                <span class="text-sm opacity-70">相機裝置</span>
                                <span class="font-mono text-xs bg-indigo-800 px-2 py-1 rounded">{{ currentDeviceId ? 'Active' : 'N/A' }}</span>
                            </div>
                            <div class="flex items-center justify-between border-b border-indigo-800 pb-2">
                                <span class="text-sm opacity-70">AI 模型</span>
                                <span class="text-xs font-bold" :class="isFaceModelLoaded ? 'text-emerald-400' : 'text-rose-400'">{{ isFaceModelLoaded ? 'Ready' : 'Loading' }}</span>
                            </div>
                            <div class="flex items-center justify-between border-b border-indigo-800 pb-2">
                                <span class="text-sm opacity-70">AI FPS</span>
                                <span class="font-mono text-emerald-400 font-bold">{{ fps }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div v-if="modals.register || modals.form" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-fade-in-up">
        <div class="bg-white w-full max-w-2xl rounded-3xl max-h-[90vh] flex flex-col shadow-2xl overflow-hidden">
            <div class="px-8 py-5 bg-slate-50 border-b border-slate-100 flex justify-between items-center">
                <h3 class="font-black text-xl text-slate-800">{{ modals.register ? '申請加入會員' : '編輯會員資料' }}</h3>
                <button @click="closeModals" class="w-10 h-10 rounded-full bg-white border border-slate-200 text-slate-400 hover:text-rose-500 hover:border-rose-200 flex items-center justify-center transition"><i class="fa-solid fa-times text-lg"></i></button>
            </div>
            
            <div class="p-8 overflow-y-auto space-y-6 flex-1">
                <div v-if="modals.register" 
                     @click="modals.privacy = true"
                     class="group bg-gradient-to-r from-indigo-50 to-blue-50 p-5 rounded-2xl border-2 border-indigo-100 hover:border-indigo-300 cursor-pointer flex items-center gap-4 transition shadow-sm hover:shadow-md select-none relative overflow-hidden">
                    
                    <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center text-indigo-600 shadow-sm group-hover:scale-110 transition">
                        <i class="fa-solid fa-file-contract text-2xl"></i>
                    </div>
                    <div class="flex-1">
                         <h4 class="font-bold text-indigo-800 text-lg">會員條款與個資聲明</h4>
                         <p class="text-xs text-indigo-500">點擊閱讀詳細條款內容以繼續</p>
                    </div>
                    <div class="absolute right-4 top-1/2 -translate-y-1/2">
                        <i class="fa-solid fa-chevron-right text-indigo-200 group-hover:text-indigo-400"></i>
                    </div>
                </div>

                <div v-if="modals.register" class="flex items-center gap-3 px-2">
                    <input type="checkbox" id="agree_chk" v-model="registerForm.agree" :disabled="!registerForm.hasRead" class="w-5 h-5 rounded accent-indigo-600 cursor-pointer disabled:opacity-50">
                    <label for="agree_chk" class="text-sm font-bold cursor-pointer select-none" :class="registerForm.hasRead ? 'text-slate-800' : 'text-slate-400'">
                        我已閱讀並同意上述條款 <span v-if="!registerForm.hasRead" class="text-xs text-rose-400">(請先點擊上方區塊閱讀)</span>
                    </label>
                </div>
                
                <div class="flex flex-col md:flex-row gap-8" :class="{'opacity-50 pointer-events-none grayscale': modals.register && !registerForm.agree}">
                    <div class="md:w-1/3 flex flex-col gap-3">
                        <div class="aspect-square bg-slate-100 rounded-2xl border-2 border-dashed border-slate-300 flex items-center justify-center overflow-hidden relative group">
                            <div v-if="isLoadingPhoto" class="absolute inset-0 bg-white/80 flex items-center justify-center z-10"><i class="fa-solid fa-circle-notch fa-spin text-indigo-500"></i></div>
                            <img v-if="activePhoto" :src="activePhoto" class="w-full h-full object-cover">
                            <div v-else class="text-center text-slate-400">
                                <i class="fa-solid fa-camera text-3xl mb-2"></i>
                                <div class="text-xs">無照片</div>
                            </div>
                        </div>
                        <button @click="startScanForForm" class="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold shadow hover:bg-indigo-700 flex items-center justify-center gap-2">
                            <i class="fa-solid fa-camera"></i> {{ activeForm.face_descriptor ? '重拍' : '拍照' }}
                        </button>
                        <button v-if="!modals.register && activePhoto" @click="deletePhoto" class="w-full py-2 text-rose-500 text-xs font-bold hover:bg-rose-50 rounded-lg">刪除照片</button>
                    </div>

                    <div class="md:w-2/3 space-y-5">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">姓名</label>
                            <input v-model="activeForm.name" type="text" class="w-full border-2 border-slate-200 p-3 rounded-xl focus:border-indigo-500 outline-none font-bold text-slate-700 text-lg">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">電話</label>
                            <input v-model="activeForm.phone" type="tel" class="w-full border-2 border-slate-200 p-3 rounded-xl focus:border-indigo-500 outline-none font-bold text-slate-700 text-lg font-mono">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">備註 / ID</label>
                            <textarea v-model="activeForm.notes" rows="3" class="w-full border-2 border-slate-200 p-3 rounded-xl focus:border-indigo-500 outline-none resize-none"></textarea>
                        </div>
                        
                        <div v-if="modals.form" class="pt-4 border-t border-slate-100 flex justify-between text-xs text-slate-400">
                            <span>註冊: {{ formatDate(activeForm.created_at) }}</span>
                            <span>更新: {{ formatDate(activeForm.updated_at) }}</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="p-6 border-t bg-slate-50 flex gap-4">
                <button v-if="modals.form" @click="deleteMember" class="px-6 py-3 text-rose-500 font-bold bg-white border border-rose-200 rounded-xl hover:bg-rose-50">刪除</button>
                <div class="flex-1"></div>
                <button @click="closeModals" class="px-6 py-3 text-slate-500 font-bold hover:bg-slate-200 rounded-xl transition">取消</button>
                <button @click="submitForm" :disabled="(modals.register && !registerForm.agree) || isLoadingPhoto" class="px-8 py-3 bg-indigo-600 text-white rounded-xl shadow-lg font-bold disabled:opacity-50 hover:bg-indigo-700 transition">儲存資料</button>
            </div>
        </div>
    </div>

    <div v-if="modals.privacy" class="fixed inset-0 bg-black/80 z-[70] flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-lg rounded-2xl flex flex-col max-h-[85vh]">
            <div class="p-4 border-b font-bold text-lg bg-indigo-50 rounded-t-2xl">會員個人資料蒐集告知聲明</div>
            <div class="p-6 overflow-y-auto text-sm text-slate-700 leading-relaxed space-y-4">
                <p><strong>{{ config.storeName || '本公司' }}</strong> 依據個資法，蒐集您的資料（姓名、電話、人臉影像等）用於會員管理與身分識別。您可隨時請求刪除。若拒絕提供人臉資料，將無法使用 AI 快速通關。</p>
            </div>
            <div class="p-4 border-t bg-slate-50 rounded-b-2xl">
                <button @click="confirmPrivacy" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 shadow-lg">本人已詳閱並同意</button>
            </div>
        </div>
    </div>

    <div v-show="modals.faceScan" class="fixed inset-0 bg-black z-[60] flex flex-col">
        <div id="video-container" class="relative w-full h-[35vh] lg:h-[45vh] bg-black overflow-hidden border-b border-white/20">
            <button @click="stopFaceScan" class="absolute top-4 right-4 w-12 h-12 rounded-full bg-black/40 backdrop-blur-md text-white z-40 border border-white/10 flex items-center justify-center active:scale-95 hover:bg-red-500/50 transition"><i class="fa-solid fa-times text-xl"></i></button>
            <select v-model="currentDeviceId" @change="handleCameraSwitch" class="absolute top-4 left-4 bg-black/40 text-white border border-white/20 py-2 pl-4 pr-8 rounded-full text-xs backdrop-blur-md outline-none appearance-none z-40 max-w-[150px]">
                <option value="">切換鏡頭</option>
                <option v-for="cam in videoDevices" :key="cam.deviceId" :value="cam.deviceId">{{ cam.label || 'Camera' }}</option>
            </select>

            <video id="video" autoplay muted playsinline class="w-full h-full object-cover beauty-filter"></video>
            <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                 <div class="w-48 h-48 lg:w-64 lg:h-64 border-2 border-white/30 rounded-full relative overflow-hidden shadow-[0_0_100px_rgba(79,70,229,0.3)]">
                     <div class="scan-line"></div>
                 </div>
            </div>
            <div class="absolute bottom-2 left-4 text-white/50 text-[10px] font-mono">AI Running @ {{ fps }} FPS</div>
        </div>

        <div v-if="app.scanMode === 'homepage_scan'" class="flex-1 bg-slate-900 overflow-hidden flex flex-col">
            <div class="p-4 border-b border-white/10 bg-slate-800/50 backdrop-blur-sm flex justify-between items-center">
                <h3 class="text-white font-bold flex items-center gap-2"><i class="fa-solid fa-history text-indigo-400"></i> 即時監控</h3>
                <span class="text-xs text-slate-500">Live Feed</span>
            </div>
            <div class="flex-1 overflow-y-auto p-4 space-y-3 no-scrollbar">
                <transition-group name="list">
                    <div v-for="log in scanHistory" :key="log.id" class="bg-white/5 rounded-xl p-3 flex gap-4 items-center border border-white/5 hover:bg-white/10 transition">
                        <img :src="log.photo" class="w-16 h-16 rounded-full object-cover border-2" :class="log.type==='phone'?'border-indigo-500':(log.type==='member'?'border-emerald-500':'border-slate-500')">
                        <div class="flex-1 overflow-hidden">
                            <div class="flex justify-between items-start"><h4 class="text-white font-bold truncate text-lg">{{ log.name }}</h4><span class="text-xs text-slate-400 font-mono">{{ log.time }}</span></div>
                            <p v-if="log.type==='member' || log.type==='phone'" class="text-sm text-emerald-400 truncate mt-1">{{ log.type==='phone' ? '電話報到' : 'Face ID 驗證成功' }}</p>
                            <p v-else class="text-sm text-slate-400 mt-1">新訪客</p>
                        </div>
                    </div>
                </transition-group>
                <div v-if="scanHistory.length === 0" class="text-center text-slate-600 mt-10">
                    <p class="text-sm">等待會員經過...</p>
                </div>
            </div>
        </div>
        
        <div v-if="app.scanMode === 'register'" class="flex-1 bg-black flex flex-col items-center justify-between text-white/70 p-6 text-center relative">
            <div class="mt-8">
                <p class="text-2xl font-bold text-white mb-2" :class="isFaceDetected ? 'text-emerald-400' : ''">
                    {{ isFaceDetected ? '已偵測到人臉' : '請看鏡頭' }}
                </p>
                <p class="text-sm opacity-80">請保持頭部在圓框內，按下快門</p>
            </div>
            
            <div class="mb-8 w-full flex justify-center">
                 <button @click="manualCapture" class="w-24 h-24 rounded-full border-[6px] border-white/20 bg-white/10 flex items-center justify-center transition-all active:scale-90 active:bg-white/20 relative cursor-pointer group">
                     <div class="w-20 h-20 rounded-full bg-white shadow-[0_0_20px_rgba(255,255,255,0.5)] transition-all group-hover:scale-105" :class="isFaceDetected ? 'bg-emerald-400 shadow-emerald-500/50' : 'bg-white'"></div>
                 </button>
            </div>
        </div>
    </div>
    
    <div v-if="modals.io" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-8 w-full max-w-sm shadow-2xl text-center">
            <h3 class="font-bold text-xl mb-6 text-slate-800">資料庫管理</h3>
            
            <div class="text-left text-xs text-slate-500 bg-slate-50 p-4 rounded-xl mb-6 space-y-2 border border-slate-100">
                <p><strong>批次匯入格式：</strong><br>A欄:ID / B欄:姓名 / C欄:電話</p>
                <p class="text-rose-500 font-bold">系統將自動過濾重複電話。</p>
            </div>

            <div class="space-y-4">
                <button @click="exportAllMembers" class="w-full py-4 bg-white text-slate-700 rounded-xl font-bold border-2 border-slate-200 hover:bg-slate-50 hover:border-slate-300 transition flex items-center justify-center gap-2">
                     <i v-if="!isExporting" class="fa-solid fa-download"></i>
                     <span v-else class="flex items-center gap-2">
                        <i class="fa-solid fa-circle-notch fa-spin"></i> {{ exportProgress }}%
                     </span>
                     {{ isExporting ? '處理中...' : '匯出全部會員 (Excel)' }}
                </button>

                <div class="relative w-full py-4 bg-indigo-600 text-white rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition flex items-center justify-center gap-2 cursor-pointer group">
                    <i v-if="!isImporting" class="fa-solid fa-upload"></i>
                    <i v-else class="fa-solid fa-circle-notch fa-spin"></i>
                    {{ isImporting ? `匯入中 ${importProgress}%` : '選擇 Excel 檔案匯入' }}
                    <input type="file" accept=".xlsx, .xls" @change="handleImport" class="absolute inset-0 opacity-0 cursor-pointer" :disabled="isImporting">
                </div>
            </div>
            <button @click="modals.io=false" class="mt-8 text-gray-400 hover:text-gray-600 font-bold text-sm" :disabled="isImporting || isExporting">關閉視窗</button>
        </div>
    </div>
</div>

<script>
const { createApp, ref, computed, onMounted, reactive } = Vue;

const app = createApp({
    setup() {
        const config = reactive({ url: '', key: '', adminPwd: '', storeName: '' });
        const isConfigured = ref(false);
        const displayMembers = ref([]); 
        const aiMembers = ref([]); 
        const totalMemberCount = ref(0); 
        
        const toasts = ref([]);
        const isLoading = ref(false);
        const isLoadingList = ref(false);
        const isLoadingPhoto = ref(false);
        const isImporting = ref(false);
        const isExporting = ref(false);
        const importProgress = ref(0);
        const exportProgress = ref(0);
        
        const currentTab = ref('self_service');
        const searchQuery = ref('');
        const modals = reactive({ form: false, faceScan: false, io: false, register: false, privacy: false });
        const tabs = [{id:'self_service', label:'POS 櫃檯', icon:'fa-solid fa-cash-register'},{id:'list', label:'會員列表', icon:'fa-solid fa-users'},{id:'dashboard', label:'營運分析', icon:'fa-solid fa-chart-pie'}];

        const form = reactive({ id: null, name: '', phone: '', notes: '', photo: null, search_history: [], face_descriptor: null, created_at: null, updated_at: null });
        const registerForm = reactive({ name: '', phone: '', notes: '', photo: null, face_descriptor: null, agree: false, hasRead: false });
        const activeForm = computed(() => modals.register ? registerForm : form);
        const activePhoto = computed(() => modals.register ? registerForm.photo : form.photo);

        const isFaceModelLoaded = ref(false);
        const verifyStatus = ref('idle');
        const verifiedMember = ref(null);
        const verifiedMemberPhoto = ref(null);
        const searchMode = ref('phone'); // 預設進入電話模式
        const selfServiceInput = ref('');
        
        const scanHistory = ref([]);
        const fps = ref(0);
        const memberCooldowns = reactive({});
        
        const videoDevices = ref([]);
        const currentDeviceId = ref('');
        const isFaceDetected = ref(false);
        const lastDetectedFace = ref(null);

        let supabase = null;
        let faceMatcher = null;
        let videoStream = null;
        let isScanning = false;
        let lastFpsTime = 0;
        let frameCount = 0;
        let audioContext = null;
        let wakeLock = null;

        // Wake Lock 請求
        const requestWakeLock = async () => {
            if ('wakeLock' in navigator) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    wakeLock.addEventListener('release', () => { console.log('Wake Lock Released'); });
                } catch (err) { console.error(`${err.name}, ${err.message}`); }
            }
        };

        const stopFaceScan = () => { 
            isScanning = false; 
            modals.faceScan = false; 
            if(videoStream) { 
                videoStream.getTracks().forEach(t => t.stop()); 
                videoStream = null; 
            }
            if(wakeLock) { wakeLock.release(); wakeLock = null; }
        };
        
        const closeModals = () => { modals.form = false; modals.register = false; modals.faceScan = false; modals.io = false; stopFaceScan(); };

        const showToast = (msg, type='success', title='提示') => {
            const id = Date.now();
            toasts.value.push({ id, msg, type, title });
            setTimeout(() => toasts.value = toasts.value.filter(t => t.id !== id), 3000);
        };

        const playSound = (type) => {
            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            if (audioContext.state === 'suspended') { audioContext.resume().catch(e=>console.log(e)); }
            
            const osc = audioContext.createOscillator(); const gain = audioContext.createGain();
            osc.connect(gain); gain.connect(audioContext.destination);
            
            if (type === 'key') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(1200, audioContext.currentTime);
                gain.gain.setValueAtTime(0.05, audioContext.currentTime);
                osc.start(); osc.stop(audioContext.currentTime + 0.05);
            } else {
                osc.type = type === 'success' ? 'sine' : 'square';
                osc.frequency.setValueAtTime(type==='success'?880:150, audioContext.currentTime);
                gain.gain.setValueAtTime(0.1, audioContext.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.3);
                osc.start(); osc.stop(audioContext.currentTime + 0.3);
            }
        };
        const unlockAudio = () => { if(!audioContext) playSound('key'); };

        const handleKeypad = (val) => {
            playSound('key');
            if (val === 'clear') {
                selfServiceInput.value = '';
            } else if (val === 'del') {
                selfServiceInput.value = selfServiceInput.value.slice(0, -1);
            } else {
                if (selfServiceInput.value.length < 10) {
                    selfServiceInput.value += val;
                }
            }
        };

        const setSearchMode = (mode) => {
            searchMode.value = mode;
            verifyStatus.value = 'idle';
            selfServiceInput.value = '';
        };

        const formatDate = (isoString) => {
            if (!isoString) return '--';
            return new Date(isoString).toLocaleString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
        };

        const formatDateSimple = (isoString) => {
            if (!isoString) return '';
            const d = new Date(isoString);
            return `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${d.getMinutes().toString().padStart(2,'0')}`;
        };

        const fetchTotalCount = async () => {
            if(!supabase) return;
            const { count, error } = await supabase.from('members').select('*', { count: 'exact', head: true });
            if(!error) totalMemberCount.value = count;
        };

        const initSystemData = async () => {
            if(!supabase) return;
            // 優化: 加入資料完整性檢查，確保 descriptor 長度正確
            const { data, error } = await supabase.from('members').select('id, name, face_descriptor, notes').not('face_descriptor', 'is', null);
            if(!error && data) {
                // 過濾壞掉的資料 (FaceAPI 需要 Float32Array length=128)
                const validData = data.filter(m => Array.isArray(m.face_descriptor) && m.face_descriptor.length === 128);
                aiMembers.value = validData;
                if(validData.length > 0) {
                    const labeled = validData.map(m => new faceapi.LabeledFaceDescriptors(m.id, [new Float32Array(m.face_descriptor)]));
                    faceMatcher = new faceapi.FaceMatcher(labeled, 0.45);
                }
            }
            searchMembers('');
            fetchTotalCount();
        };

        const searchMembers = async (overrideQuery) => {
            if(!supabase) return;
            isLoadingList.value = true;
            let query = supabase.from('members').select('id, name, phone, notes, face_descriptor, updated_at, created_at').order('created_at', {ascending:false}).limit(50);
            const q = (typeof overrideQuery === 'string' ? overrideQuery : searchQuery.value).trim();
            if(q) {
                query = supabase.from('members').select('*').or(`name.ilike.%${q}%,phone.ilike.%${q}%`).limit(50);
            }
            const { data, error } = await query;
            if(error) showToast(error.message, 'error');
            else displayMembers.value = data || [];
            isLoadingList.value = false;
        };

        const handleCheckIn = async (member, type) => {
            const now = Date.now();
            if (type === 'face' && now - (memberCooldowns[member.id]||0) < 180000) return;
            memberCooldowns[member.id] = now;
            verifyStatus.value = 'success';
            verifiedMember.value = member;
            verifiedMemberPhoto.value = member.photo;
            playSound('success');
            const timeStr = new Date().toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            scanHistory.value.unshift({ 
                id: now, name: member.name, phone: member.phone, type: type === 'face' ? 'member' : 'phone', notes: member.notes, photo: member.photo, time: timeStr 
            });
            if (scanHistory.value.length > 50) scanHistory.value.pop();
            if(supabase) { await supabase.from('members').update({ updated_at: new Date() }).eq('id', member.id); }
        };

        const performVerification = async () => {
            const val = selfServiceInput.value.trim();
            if(!val) return showToast('請輸入電話', 'warning');
            isLoading.value = true;
            const { data, error } = await supabase.from('members').select('*').eq('phone', val).single();
            isLoading.value = false;
            if(data) { await handleCheckIn(data, 'phone'); } else { verifyStatus.value = 'fail'; playSound('fail'); setTimeout(()=>verifyStatus.value='idle', 2000); }
        };

        const fetchMemberPhoto = async (id) => {
            const { data } = await supabase.from('members').select('photo').eq('id', id).single();
            return data?.photo || null;
        };

        const editMember = async (m) => {
            isLoadingPhoto.value = true;
            Object.assign(form, JSON.parse(JSON.stringify(m)));
            form.photo = null; 
            modals.form = true; 
            modals.register = false;
            const photo = await fetchMemberPhoto(m.id);
            form.photo = photo;
            isLoadingPhoto.value = false;
        };

        const deletePhoto = () => {
            if(!confirm('確定要刪除此照片嗎？\n(注意：需按下「儲存資料」才會生效)')) return;
            form.photo = null;
            form.face_descriptor = null;
        };

        const checkDuplicate = async (phone) => {
            if(!phone) return false;
            const { data } = await supabase.from('members').select('id').eq('phone', phone).single();
            return !!data;
        };

        const submitForm = async () => {
            const target = modals.register ? registerForm : form;
            if(!target.name || !target.phone) return showToast('資料不完整', 'warning');
            
            isLoading.value = true;
            try {
                const isNew = modals.register || !target.id;
                if(isNew) {
                    const exists = await checkDuplicate(target.phone);
                    if(exists) {
                         showToast('此電話號碼已存在，請勿重複註冊', 'error');
                         isLoading.value = false;
                         return;
                    }
                }

                const payload = { ...target };
                delete payload.agree; delete payload.hasRead; 
                if(!isNew) {
                    const { error } = await supabase.from('members').update({...payload, updated_at: new Date()}).eq('id', payload.id);
                    if(error) throw error;
                    showToast('更新成功');
                } else {
                    payload.id = Date.now().toString(); payload.created_at = new Date(); payload.updated_at = new Date();
                    const { error } = await supabase.from('members').insert(payload);
                    if(error) throw error;
                    showToast('註冊成功');
                }
                closeModals(); initSystemData(); resetSelfService();
            } catch(e) { showToast(e.message, 'error'); } finally { isLoading.value = false; }
        };

        const deleteMember = async () => { if(!confirm('確定刪除會員？此操作無法復原。')) return; const { error } = await supabase.from('members').delete().eq('id', form.id); if(error) showToast('刪除失敗', 'error'); else { showToast('已刪除'); closeModals(); initSystemData(); } };
        const confirmPrivacy = () => { registerForm.hasRead = true; registerForm.agree = true; modals.privacy = false; };
        
        const resetSelfService = () => { 
            verifyStatus.value = 'idle'; 
            selfServiceInput.value = ''; 
            verifiedMember.value = null; 
            verifiedMemberPhoto.value = null; 
            searchMode.value = 'phone'; 
        };

        const exportAllMembers = async () => {
            if(!confirm(`即將下載 ${totalMemberCount.value} 筆會員資料。\n(僅匯出文字，不含照片)\n\n確定繼續？`)) return;
            isExporting.value = true; exportProgress.value = 0;
            const allMembers = []; const BATCH_SIZE = 1000; let page = 0;
            try {
                while(true) {
                    const from = page * BATCH_SIZE; const to = from + BATCH_SIZE - 1;
                    const { data, error } = await supabase.from('members').select('id, name, phone, notes, created_at, updated_at').range(from, to).order('created_at', {ascending: true});
                    if (error) throw error; if (!data || data.length === 0) break;
                    allMembers.push(...data);
                    exportProgress.value = Math.min(100, Math.round((allMembers.length / totalMemberCount.value) * 100));
                    if (data.length < BATCH_SIZE) break; page++;
                }
                if (allMembers.length > 0) {
                    const wb = new ExcelJS.Workbook(); const ws = wb.addWorksheet('All Members');
                    ws.columns = [{header:'ID',key:'id', width: 15}, {header:'Name',key:'name', width: 15}, {header:'Phone',key:'phone', width: 15}, {header:'Notes',key:'notes', width: 30}, {header:'Created',key:'created_at', width: 20}, {header:'Updated',key:'updated_at', width: 20}];
                    allMembers.forEach(m => ws.addRow(m));
                    const buffer = await wb.xlsx.writeBuffer(); saveAs(new Blob([buffer]), `SmartMember_Export_${new Date().toISOString().slice(0,10)}.xlsx`);
                    showToast(`成功匯出 ${allMembers.length} 筆資料`);
                } else { showToast('無資料可匯出', 'warning'); }
            } catch(e) { showToast('匯出失敗: '+e.message, 'error'); } finally { isExporting.value = false; }
        };

        const handleImport = async (e) => {
            const file = e.target.files[0]; if (!file) return; isImporting.value = true; importProgress.value = 0;
            try {
                const buffer = await file.arrayBuffer(); const wb = new ExcelJS.Workbook(); await wb.xlsx.load(buffer); const ws = wb.getWorksheet(1);
                const membersToUpsert = []; const seenPhones = new Set();
                let idxName = 2; let idxPhone = 3; let idxNotes = 4;
                const headerRow = ws.getRow(1).values; 
                if(Array.isArray(headerRow)) { headerRow.forEach((val, idx) => { if(!val) return; const v = val.toString().toLowerCase(); if(v.includes('姓名') || v.includes('name')) idxName = idx; else if(v.includes('電話') || v.includes('mobile')) idxPhone = idx; else if(v.includes('備註') || v.includes('notes')) idxNotes = idx; }); }
                ws.eachRow((row, rowNumber) => { 
                    if(rowNumber === 1) return; 
                    let name = row.getCell(idxName).text?.trim(); 
                    let phone = row.getCell(idxPhone).text?.trim(); 
                    if(phone) phone = phone.replace(/[^0-9]/g, ''); 
                    if(name && phone) { 
                        if(seenPhones.has(phone)) return; seenPhones.add(phone); 
                        membersToUpsert.push({ id: Date.now() + Math.random().toString(36).substr(2, 5), name: name, phone: phone, notes: row.getCell(idxNotes).text?.trim()||'', updated_at: new Date() }); 
                    } 
                });
                if(membersToUpsert.length === 0) throw new Error("無有效資料");
                const BATCH_SIZE = 500; const total = membersToUpsert.length; let processed = 0;
                for (let i = 0; i < total; i += BATCH_SIZE) { 
                    const batch = membersToUpsert.slice(i, i + BATCH_SIZE); 
                    const { error } = await supabase.from('members').upsert(batch, { onConflict: 'phone' }); 
                    if (error) console.error(error); processed += batch.length; importProgress.value = Math.floor((processed / total) * 100); 
                }
                showToast(`成功匯入 ${processed} 筆 (重複電話已自動覆蓋更新)`); modals.io = false; initSystemData();
            } catch(e) { showToast('匯入失敗: ' + e.message, 'error'); } finally { isImporting.value = false; e.target.value = ''; }
        };

        onMounted(async () => {
            const saved = localStorage.getItem('supabase_config_v6');
            if(saved) { try { Object.assign(config, JSON.parse(saved)); if(config.url) initSupabase(); } catch(e){} }
            const URL = 'https://justadudewhohacks.github.io/face-api.js/models';
            try { await Promise.all([faceapi.nets.tinyFaceDetector.loadFromUri(URL),faceapi.nets.faceLandmark68Net.loadFromUri(URL),faceapi.nets.faceRecognitionNet.loadFromUri(URL)]); isFaceModelLoaded.value = true; } catch(e) { showToast('AI 模型載入失敗', 'error'); }
            try { await navigator.mediaDevices.getUserMedia({ video: true }); const d = await navigator.mediaDevices.enumerateDevices(); videoDevices.value = d.filter(k=>k.kind==='videoinput'); const b = videoDevices.value.find(l=>l.label.toLowerCase().includes('back')); if(b) currentDeviceId.value = b.deviceId; } catch(e){}
        });

        const initSupabase = () => { if(!config.url || !config.key) return; try { supabase = window.supabase.createClient(config.url, config.key); isConfigured.value = true; initSystemData(); } catch(e) { showToast('連線失敗', 'error'); } };

        const startVideo = async () => {
            if(!isFaceModelLoaded.value) { showToast('AI 初始化中...', 'warning'); return null; }
            requestWakeLock(); // 啟動相機時保持螢幕常亮
            const v = document.getElementById('video');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { deviceId: currentDeviceId.value ? { exact: currentDeviceId.value } : undefined, width: { ideal: 640 }, height: { ideal: 480 } } });
                v.srcObject = stream; videoStream = stream;
                isFaceDetected.value = false; lastDetectedFace.value = null;
                return new Promise(r => v.onloadedmetadata = () => { v.play(); r(v); });
            } catch(e) { showToast('無法啟動相機', 'error'); return null; }
        };

        const captureFace = (video, box) => {
            const canvas = document.createElement('canvas'); const pad = 50; canvas.width = 150; canvas.height = 150; const ctx = canvas.getContext('2d');
            try { ctx.drawImage(video, Math.max(0, box.x-pad), Math.max(0, box.y-pad), box.width+pad*2, box.height+pad*2, 0, 0, 150, 150); } catch(e){}
            return canvas.toDataURL('image/jpeg', 0.8);
        };

        const manualCapture = () => {
            const video = document.getElementById('video');
            if (!video) return;
            let box = null; let desc = null;
            if (lastDetectedFace.value && isFaceDetected.value) { box = lastDetectedFace.value.detection.box; desc = Array.from(lastDetectedFace.value.descriptor); } 
            else { const size = Math.min(video.videoWidth, video.videoHeight) * 0.6; box = { x: (video.videoWidth - size) / 2, y: (video.videoHeight - size) / 2, width: size, height: size }; }
            const cvs = document.createElement('canvas'); cvs.width=300; cvs.height=300; const ctx = cvs.getContext('2d');
            // 注意: 若 Video 有 CSS transform scaleX(-1)，手動截圖需調整，這裡簡化為直接截取
            try { ctx.drawImage(video, box.x, box.y, box.width, box.height, 0,0,300,300); } catch(e) { ctx.drawImage(video, 0,0,300,300); }
            const photo = cvs.toDataURL('image/jpeg', 0.8);
            if(modals.register) { registerForm.photo = photo; registerForm.face_descriptor = desc; } else { form.photo = photo; form.face_descriptor = desc; }
            playSound('success'); stopFaceScan();
        };

        const scanningLoop = async (video) => {
            if(!isScanning || !modals.faceScan) return;
            const now = Date.now(); 
            if(now - lastFpsTime >= 1000) { fps.value = frameCount; frameCount = 0; lastFpsTime = now; } 
            frameCount++;

            try {
                // 使用 TinyFaceDetector 搭配 224x224 輸入尺寸以平衡速度與準確度
                const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions({ inputSize: 224, scoreThreshold: 0.5 })).withFaceLandmarks().withFaceDescriptor();
                isFaceDetected.value = !!detection; if (detection) lastDetectedFace.value = detection;
                if(detection) {
                    const box = detection.detection.box;
                    if(app.scanMode === 'homepage_scan' && faceMatcher) {
                        const match = faceMatcher.findBestMatch(detection.descriptor);
                        if(match.label !== 'unknown') {
                            const m = aiMembers.value.find(x => x.id === match.label); 
                            if(m) { const fullMember = { ...m, photo: captureFace(video, box) }; handleCheckIn(fullMember, 'face'); }
                        }
                    }
                }
            } catch(e){}
            if(isScanning) requestAnimationFrame(() => scanningLoop(video));
        };

        const startScan = async (mode) => { app.scanMode = mode; modals.faceScan = true; isScanning = true; const v = await startVideo(); if(v) scanningLoop(v); };
        const saveConfig = () => { localStorage.setItem('supabase_config_v6', JSON.stringify(config)); initSupabase(); };
        const resetConfigSecure = () => { if(prompt("密碼")===(config.adminPwd||'0000')) { localStorage.removeItem('supabase_config_v6'); location.reload(); } };
        const stats = computed(() => { const count = scanHistory.value.filter(log => log.type === 'member' || log.type === 'phone').length; return { todayVisits: count }; });

        const toggleFullScreen = () => {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else if (document.exitFullscreen) {
                document.exitFullscreen();
            }
        };

        return {
            config, isConfigured, saveConfig, resetConfigSecure, checkAdmin: (cb) => { const p=prompt('Pwd?'); if(p===(config.adminPwd||'0000'))cb(); else alert('Err'); },
            displayMembers, aiMembers, totalMemberCount, searchMembers, searchQuery, isLoading, isLoadingList, isLoadingPhoto, isImporting, isExporting, importProgress, exportProgress, handleImport, exportAllMembers,
            currentTab, tabs, modals, closeModals, confirmPrivacy,
            form, registerForm, activeForm, activePhoto, submitForm, deleteMember, editMember, deletePhoto,
            openAdminAdd: () => { Object.assign(form, {id:null,name:'',phone:'',notes:'',photo:null,face_descriptor:null, created_at:null, updated_at:null}); modals.form=true; modals.register=false; },
            openSelfRegister: () => { Object.assign(registerForm, {name:'',phone:'',notes:'',photo:null,face_descriptor:null, agree:false, hasRead:false}); modals.register=true; modals.form=false; },
            startScanForForm: () => startScan('register'), startHomepageScan: () => startScan('homepage_scan'),
            stopFaceScan, handleCameraSwitch: async () => { if(videoStream) { stopFaceScan(); await startScan(app.scanMode); } },
            selfServiceInput, searchMode, setSearchMode, handleKeypad, verifyStatus, verifiedMember, verifiedMemberPhoto, performVerification, resetSelfService,
            stats, isFaceModelLoaded, videoDevices, currentDeviceId, scanHistory, fps, app, unlockAudio, toasts, formatDate, formatDateSimple,
            isFaceDetected, manualCapture, toggleFullScreen
        };
    }
});
app.mount('#app');
</script>
</body>
</html>
