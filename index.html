<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI æ™ºèƒ½æœƒå“¡ç³»çµ± V5.0 (å•†ç”¨æ——è‰¦ç‰ˆ)</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .tab-btn { position: relative; color: #64748b; transition: all 0.3s; }
        .tab-active { color: #4f46e5; font-weight: bold; }
        .tab-active::after { content: ''; position: absolute; bottom: -12px; left: 0; width: 100%; height: 3px; background: #4f46e5; border-radius: 3px 3px 0 0; }
        .loader { width: 18px; height: 18px; border: 2px solid #e2e8f0; border-top-color: #4f46e5; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes fadeInUp { from { opacity: 0; transform: translate3d(0, 20px, 0); } to { opacity: 1; transform: none; } }
        .animate-fade-in-up { animation: fadeInUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        
        #video-container video { width: 100%; height: 100%; object-fit: cover; }
        .scan-line { position: absolute; width: 100%; height: 2px; background: #4f46e5; box-shadow: 0 0 15px #4f46e5; animation: scanning 2s infinite ease-in-out; }
        @keyframes scanning { 0% {top:0; opacity: 0;} 10% {opacity: 1;} 90% {opacity: 1;} 100% {top:100%; opacity: 0;} }
        
        /* Toast Notification Styles */
        .toast-enter-active, .toast-leave-active { transition: all 0.3s ease; }
        .toast-enter-from, .toast-leave-to { opacity: 0; transform: translateX(30px); }
    </style>
</head>
<body>

<div id="app" class="min-h-screen flex flex-col pb-safe" @click="unlockAudio">
    
    <div class="fixed top-4 right-4 z-[100] flex flex-col gap-2 pointer-events-none">
        <transition-group name="toast">
            <div v-for="toast in toasts" :key="toast.id" 
                 class="pointer-events-auto min-w-[300px] max-w-sm bg-white rounded-xl shadow-xl border-l-4 p-4 flex items-center gap-3"
                 :class="{'border-emerald-500': toast.type==='success', 'border-rose-500': toast.type==='error', 'border-amber-500': toast.type==='warning'}">
                <i class="fa-solid text-xl" 
                   :class="{'fa-check-circle text-emerald-500': toast.type==='success', 'fa-times-circle text-rose-500': toast.type==='error', 'fa-exclamation-circle text-amber-500': toast.type==='warning'}"></i>
                <div>
                    <h4 class="font-bold text-slate-800 text-sm">{{ toast.title }}</h4>
                    <p class="text-xs text-slate-500">{{ toast.msg }}</p>
                </div>
            </div>
        </transition-group>
    </div>

    <div v-if="!isConfigured" class="fixed inset-0 bg-slate-900 z-[99] flex items-center justify-center p-6">
        <div class="bg-white rounded-2xl p-8 w-full max-w-md shadow-2xl animate-fade-in-up">
            <h2 class="text-2xl font-bold text-slate-800 mb-6">ç³»çµ±åˆå§‹åŒ– V5.0</h2>
            <div class="space-y-4">
                <div><label class="text-xs font-bold text-slate-500">Supabase URL</label><input v-model="config.url" class="w-full border-2 border-slate-200 p-3 rounded-xl focus:border-indigo-500 outline-none"></div>
                <div><label class="text-xs font-bold text-slate-500">Supabase Key (Anon)</label><input v-model="config.key" class="w-full border-2 border-slate-200 p-3 rounded-xl focus:border-indigo-500 outline-none"></div>
                <div><label class="text-xs font-bold text-rose-500">ç®¡ç†å“¡å¯†ç¢¼</label><input v-model="config.adminPwd" type="password" placeholder="é è¨­: 0000" class="w-full border-2 border-rose-200 p-3 rounded-xl focus:border-rose-500 bg-rose-50 outline-none"></div>
                <button @click="saveConfig" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 transition">å•Ÿå‹•ç³»çµ±</button>
            </div>
        </div>
    </div>

    <header class="bg-white shadow-sm sticky top-0 z-40">
        <div class="px-5 py-4 flex justify-between items-center">
            <h1 class="text-xl font-bold text-slate-800 flex items-center"><i class="fa-solid fa-cube text-indigo-600 mr-2"></i>SmartMember <span class="text-xs bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded ml-2">PRO</span></h1>
            <div class="flex gap-4 items-center">
                <button @click="resetConfig" class="text-slate-300 hover:text-slate-500"><i class="fa-solid fa-gear"></i></button>
                <button @click="checkAdmin(() => modals.io = true)" class="text-slate-400 hover:text-indigo-600 transition"><i class="fa-solid fa-file-export text-xl"></i></button>
                <div class="flex items-center gap-2 text-xs font-bold bg-slate-100 px-3 py-1.5 rounded-full">
                    <span class="text-emerald-500 flex items-center"><i class="fa-solid fa-database mr-1.5"></i>{{ members.length }}</span>
                    <span class="w-[1px] h-3 bg-slate-300 mx-1"></span>
                    <span :class="isFaceModelLoaded ? 'text-indigo-500' : 'text-slate-400'" class="flex items-center">
                        <i class="fa-solid" :class="isFaceModelLoaded ? 'fa-brain' : 'fa-circle-notch fa-spin'"></i>
                    </span>
                </div>
            </div>
        </div>
        <div class="flex border-t border-slate-100 bg-white px-2">
            <button v-for="tab in tabs" :key="tab.id" @click="currentTab = tab.id" :class="{'tab-active': currentTab === tab.id}" class="tab-btn flex-1 py-3 text-sm flex justify-center items-center">
                <i :class="tab.icon" class="mr-1.5"></i>{{ tab.label }}
            </button>
        </div>
    </header>

    <main class="flex-grow p-4 overflow-y-auto bg-slate-50">
        <div v-show="currentTab === 'self_service'" class="max-w-md mx-auto mt-4 pb-20">
            <div class="bg-white rounded-3xl shadow-lg overflow-hidden border border-slate-100 p-8 min-h-[60vh] flex flex-col items-center justify-center text-center relative animate-fade-in-up">
                <div v-if="verifyStatus === 'idle'" class="w-full space-y-6">
                    <div class="space-y-2">
                        <i class="fa-solid fa-mobile-screen-button text-5xl text-indigo-500 mb-2"></i>
                        <h2 class="text-2xl font-black text-slate-800">æœƒå“¡è‡ªåŠ©èªè­‰</h2>
                        <p class="text-slate-400 text-sm">è«‹é¸æ“‡é©—è­‰æ–¹å¼</p>
                    </div>
                    <div class="flex justify-center items-center gap-3 mb-4">
                         <button v-for="m in ['phone', 'name']" :key="m" class="text-xs font-bold px-3 py-1.5 rounded-full transition border uppercase" :class="searchMode === m ? 'bg-indigo-600 text-white border-indigo-600' : 'text-slate-400 border-slate-200'" @click="searchMode=m">{{ m === 'phone' ? 'æ‰‹æ©Ÿ' : 'å§“å' }}</button>
                         <button @click="startSelfServiceFaceScan" class="text-xs font-bold px-4 py-1.5 rounded-full bg-gradient-to-r from-purple-500 to-indigo-500 text-white shadow-md flex items-center gap-1 hover:scale-105 active:scale-95"><i class="fa-solid fa-face-smile"></i> åˆ·è‡‰</button>
                    </div>
                    <input v-model="selfServiceInput" :type="searchMode === 'phone' ? 'tel' : 'text'" :placeholder="searchMode === 'phone' ? 'è¼¸å…¥é›»è©±è™Ÿç¢¼...' : 'è¼¸å…¥å§“å...'" class="w-full text-center text-2xl font-bold py-4 border-b-2 border-slate-200 focus:border-indigo-500 outline-none bg-transparent" @keyup.enter="performVerification">
                    <button @click="performVerification" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-4 rounded-2xl text-lg font-bold shadow-lg shadow-indigo-200 active:scale-95 transition mt-4">ç¢ºèªé€å‡º</button>
                    <div class="pt-8 mt-4 border-t border-slate-100"><button @click="openSelfRegister" class="w-full border-2 border-indigo-600 text-indigo-600 py-3 rounded-2xl font-bold hover:bg-indigo-50 transition">ç«‹å³åŠ å…¥æœƒå“¡</button></div>
                </div>

                <div v-else class="w-full space-y-6 animate-fade-in-up">
                    <div class="w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-4" :class="verifyStatus === 'success' ? 'bg-emerald-100' : 'bg-rose-100'">
                        <i class="fa-solid text-5xl" :class="verifyStatus === 'success' ? 'fa-check text-emerald-500' : 'fa-xmark text-rose-500'"></i>
                    </div>
                    <div>
                        <h2 class="text-3xl font-black text-slate-800">{{ verifyStatus === 'success' ? 'èªè­‰æˆåŠŸ' : 'é©—è­‰å¤±æ•—' }}</h2>
                        <p class="text-lg text-slate-600 mt-2" v-if="verifyStatus === 'success'">æ­¡è¿ï¼Œ<span class="font-bold text-indigo-600">{{ verifiedMember?.name }}</span></p>
                        <p class="text-slate-500 mt-2" v-else>æ‰¾ä¸åˆ°è³‡æ–™ï¼Œè«‹é‡è©¦</p>
                    </div>
                    <div v-if="verifyStatus === 'success' && !verifiedMember.face_descriptor" class="bg-indigo-50 p-4 rounded-xl"><button @click="registerFaceFromSelfService" class="text-indigo-600 font-bold w-full">ğŸ‘‰ ç«‹å³è¨»å†Šäººè‡‰</button></div>
                    <button @click="resetSelfService" class="w-full bg-slate-500 text-white py-3 rounded-xl font-bold mt-6">è¿”å›</button>
                </div>
            </div>
        </div>

        <div v-show="currentTab === 'list'" class="space-y-4 max-w-4xl mx-auto animate-fade-in-up">
             <div class="relative group"><i class="fa-solid fa-magnifying-glass absolute left-4 top-4 text-slate-400"></i><input v-model="searchQuery" type="text" placeholder="æœå°‹æœƒå“¡..." class="w-full pl-11 pr-4 py-3.5 border-0 rounded-2xl shadow-sm bg-white focus:ring-2 focus:ring-indigo-100 outline-none"></div>
             <div class="flex justify-between px-1"><span class="text-sm text-slate-500">å…± {{ members.length }} äºº</span><button @click="openAdminAdd" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow">+ æ–°å¢</button></div>
             <div class="grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
                 <div v-for="m in filteredMembers" :key="m.id" @click="editMember(m)" class="bg-white p-4 rounded-2xl shadow-sm flex items-center gap-4 cursor-pointer border border-slate-100 hover:border-indigo-200 transition">
                     <img :src="m.photo||'https://via.placeholder.com/150'" class="w-12 h-12 rounded-full object-cover bg-gray-100 border">
                     <div class="flex-1 overflow-hidden"><b class="truncate block">{{m.name}}</b><p class="text-xs text-gray-500 truncate">{{m.phone}}</p></div>
                     <i class="fa-solid fa-chevron-right text-slate-300 text-xs"></i>
                 </div>
             </div>
        </div>

        <div v-show="currentTab === 'dashboard'" class="max-w-4xl mx-auto animate-fade-in-up">
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-white p-5 rounded-2xl shadow-sm border-l-4 border-indigo-500"><h3 class="text-sm text-slate-500 mb-1">ä»Šæ—¥ä¾†å®¢</h3><span class="text-3xl font-bold text-indigo-600">{{stats.todayVisits}}</span></div>
                <div class="bg-white p-5 rounded-2xl shadow-sm border-l-4 border-emerald-500"><h3 class="text-sm text-slate-500 mb-1">æœƒå“¡ç¸½æ•¸</h3><span class="text-3xl font-bold text-emerald-600">{{members.length}}</span></div>
            </div>
        </div>
    </main>

    <div v-if="modals.register || modals.form" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-fade-in-up">
        <div class="bg-white w-full max-w-md rounded-3xl max-h-[90vh] flex flex-col shadow-2xl">
            <div class="px-6 py-4 bg-indigo-600 text-white flex justify-between items-center">
                <h3 class="font-bold text-lg">{{ modals.register ? 'ç”³è«‹åŠ å…¥æœƒå“¡' : 'ç·¨è¼¯è³‡æ–™' }}</h3>
                <button @click="closeModals" class="text-white/80 hover:text-white"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div class="p-6 overflow-y-auto space-y-4 flex-1">
                <div v-if="modals.register" class="bg-slate-50 p-3 rounded-lg border text-xs text-slate-500 mb-2">å€‹è³‡è²æ˜ï¼šæœ¬ç³»çµ±åƒ…ç”¨æ–¼æœƒå“¡è­˜åˆ¥ã€‚</div>
                <div v-if="modals.register" class="flex items-center gap-2 mb-2"><input type="checkbox" v-model="registerForm.agree" class="w-4 h-4"><span class="text-sm font-bold">æˆ‘åŒæ„æ¢æ¬¾</span></div>
                
                <div class="grid gap-4" :class="{'opacity-50 pointer-events-none': modals.register && !registerForm.agree}">
                    <div v-for="field in ['name', 'phone', 'birthday']" :key="field">
                        <label class="text-xs font-bold text-slate-500 uppercase">{{ field==='name'?'å§“å':field==='phone'?'é›»è©±':'ç”Ÿæ—¥' }}</label>
                        <input v-model="activeForm[field]" :type="field==='birthday'?'date':field==='phone'?'tel':'text'" class="w-full border-2 border-slate-200 p-2.5 rounded-xl mt-1 focus:border-indigo-500 outline-none">
                    </div>
                    <div class="flex gap-4 items-center mt-2">
                        <img v-if="activePhoto" :src="activePhoto" class="w-16 h-16 rounded object-cover border bg-gray-50">
                        <button @click="startScanForForm" class="flex-1 py-3 bg-slate-100 hover:bg-slate-200 rounded-xl font-bold text-slate-600 text-sm flex items-center justify-center gap-2 transition">
                            <i class="fa-solid fa-camera"></i> {{ activeForm.face_descriptor ? 'é‡æ‹ç…§ç‰‡' : 'æ‹æ”äººè‡‰' }}
                        </button>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t bg-slate-50 flex gap-3">
                <button v-if="modals.form" @click="deleteMember" class="px-4 py-3 text-rose-500 font-bold bg-rose-50 rounded-xl hover:bg-rose-100">åˆªé™¤</button>
                <button @click="submitForm" :disabled="modals.register && !registerForm.agree" class="flex-1 py-3 bg-indigo-600 text-white rounded-xl shadow-lg font-bold disabled:opacity-50 hover:bg-indigo-700">å„²å­˜è³‡æ–™</button>
            </div>
        </div>
    </div>

    <div v-show="modals.faceScan" class="fixed inset-0 bg-black z-[60] flex flex-col">
        <div class="absolute top-0 w-full z-30 p-4 flex justify-between bg-gradient-to-b from-black/60 to-transparent">
            <select v-model="currentDeviceId" @change="handleCameraSwitch" class="bg-black/40 text-white border border-white/20 py-2 pl-4 pr-10 rounded-full text-sm backdrop-blur-md outline-none appearance-none">
                <option value="">è‡ªå‹•é¸æ“‡é¡é ­</option>
                <option v-for="cam in videoDevices" :key="cam.deviceId" :value="cam.deviceId">{{ cam.label || 'Camera '+cam.deviceId.slice(0,4) }}</option>
            </select>
            <button @click="stopFaceScan" class="w-10 h-10 rounded-full bg-white/20 backdrop-blur-md text-white"><i class="fa-solid fa-times"></i></button>
        </div>
        <div id="video-container" class="flex-1 relative flex items-center justify-center bg-black">
            <video id="video" autoplay muted playsinline></video>
            <div class="absolute w-64 h-64 border-2 border-white/30 rounded-3xl overflow-hidden"><div class="scan-line"></div></div>
            <div v-if="scanMessage" class="absolute bottom-24 bg-emerald-500 text-white px-6 py-2 rounded-full font-bold shadow-lg animate-bounce">
                <i class="fa-solid fa-check-circle mr-1"></i> {{ scanMessage }}
            </div>
            <div class="absolute bottom-8 text-white/50 text-xs">AI Running @ {{ fps }} FPS</div>
        </div>
    </div>
    
    <div v-if="modals.io" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl text-center">
            <h3 class="font-bold text-lg mb-4">è³‡æ–™ç®¡ç†</h3>
            <button @click="exportFastExcel" class="w-full py-3 bg-green-50 text-green-700 rounded-xl font-bold border border-green-200 mb-4 hover:bg-green-100">{{ isExporting ? 'è™•ç†ä¸­...' : 'åŒ¯å‡º Excel' }}</button>
            <button @click="modals.io=false" class="text-gray-400">é—œé–‰</button>
        </div>
    </div>

</div>

<script>
const { createApp, ref, computed, onMounted, reactive, watch } = Vue;

const app = createApp({
    setup() {
        // --- æ ¸å¿ƒç‹€æ…‹ ---
        const config = reactive({ url: '', key: '', adminPwd: '' });
        const isConfigured = ref(false);
        const members = ref([]);
        const toasts = ref([]);
        
        // --- UI æ§åˆ¶ ---
        const isLoading = ref(false);
        const currentTab = ref('self_service');
        const searchQuery = ref('');
        const modals = reactive({ form: false, faceScan: false, io: false, register: false });
        const tabs = [
            {id:'self_service', label:'è‡ªåŠ©èªè­‰', icon:'fa-solid fa-user-check'},
            {id:'list', label:'åˆ—è¡¨ç®¡ç†', icon:'fa-solid fa-list-ul'},
            {id:'dashboard', label:'æ•¸æ“šåˆ†æ', icon:'fa-solid fa-chart-line'},
        ];

        // --- è¡¨å–®æ•¸æ“š ---
        const form = reactive({ id: null, name: '', phone: '', notes: '', birthday: '', photo: null, search_history: [], face_descriptor: null });
        const registerForm = reactive({ name: '', phone: '', birthday: '', photo: null, face_descriptor: null, agree: false });
        const activeForm = computed(() => modals.register ? registerForm : form);
        const activePhoto = computed(() => modals.register ? registerForm.photo : form.photo);

        // --- AI & æƒæç‹€æ…‹ ---
        const isFaceModelLoaded = ref(false);
        const verifyStatus = ref('idle');
        const verifiedMember = ref(null);
        const searchMode = ref('phone');
        const selfServiceInput = ref('');
        const scanMessage = ref('');
        const fps = ref(0);
        
        // --- ç¡¬é«”åƒè€ƒ ---
        const videoDevices = ref([]);
        const currentDeviceId = ref('');
        
        // --- å…§éƒ¨è®Šæ•¸ (ééŸ¿æ‡‰å¼) ---
        let supabase = null;
        let faceMatcher = null;
        let videoStream = null;
        let isScanning = false;
        let lastScanTime = 0;
        let frameCount = 0;
        let lastFpsTime = 0;
        let audioContext = null;

        // ==========================================
        // 1. ç³»çµ±åˆå§‹åŒ–èˆ‡å·¥å…·å‡½æ•¸
        // ==========================================
        const showToast = (msg, type='success', title='æç¤º') => {
            const id = Date.now();
            toasts.value.push({ id, msg, type, title });
            setTimeout(() => toasts.value = toasts.value.filter(t => t.id !== id), 3000);
        };

        const playSound = (type) => {
            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            if (audioContext.state === 'suspended') audioContext.resume();
            const osc = audioContext.createOscillator(); const gain = audioContext.createGain();
            osc.connect(gain); gain.connect(audioContext.destination);
            osc.type = type === 'success' ? 'sine' : 'square';
            osc.frequency.setValueAtTime(type==='success'?523:150, audioContext.currentTime);
            gain.gain.setValueAtTime(0.1, audioContext.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.3);
            osc.start(); osc.stop(audioContext.currentTime + 0.3);
        };

        const unlockAudio = () => { if(!audioContext) playSound('success'); };

        onMounted(async () => {
            const saved = localStorage.getItem('supabase_config_v5');
            if(saved) {
                try { Object.assign(config, JSON.parse(saved)); if(config.url) initSupabase(); } 
                catch(e) { console.error(e); }
            }
            // é è¼‰ AI æ¨¡å‹
            const URL = 'https://justadudewhohacks.github.io/face-api.js/models';
            try {
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(URL)
                ]);
                isFaceModelLoaded.value = true;
            } catch(e) { showToast('AI æ¨¡å‹è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯', 'error'); }
            
            // å–å¾—ç›¸æ©Ÿåˆ—è¡¨
            try {
                await navigator.mediaDevices.getUserMedia({ video: true });
                const devices = await navigator.mediaDevices.enumerateDevices();
                videoDevices.value = devices.filter(d => d.kind === 'videoinput');
                // å„ªå…ˆä½¿ç”¨å¾Œé¡é ­
                const back = videoDevices.value.find(d => d.label.toLowerCase().includes('back'));
                if(back) currentDeviceId.value = back.deviceId;
            } catch(e) {/* ignore */}
        });

        const initSupabase = () => {
            if(!config.url || !config.key) return;
            try {
                supabase = window.supabase.createClient(config.url, config.key);
                isConfigured.value = true;
                fetchMembers();
            } catch(e) { showToast('Supabase é€£ç·šå¤±æ•—', 'error'); }
        };

        // ==========================================
        // 2. è³‡æ–™åº«æ“ä½œ (å•†ç”¨ç´šåˆ¥ï¼šéŒ¯èª¤è™•ç†)
        // ==========================================
        const fetchMembers = async () => {
            if(!supabase) return;
            isLoading.value = true;
            const { data, error } = await supabase.from('members').select('*').order('updated_at', {ascending:false});
            if(error) { showToast(error.message, 'error', 'è®€å–å¤±æ•—'); }
            else {
                members.value = data || [];
                // é‡å»º AI ç´¢å¼•
                if(members.value.length > 0) {
                    const labeled = members.value
                        .filter(m => m.face_descriptor)
                        .map(m => new faceapi.LabeledFaceDescriptors(m.id, [new Float32Array(m.face_descriptor)]));
                    if(labeled.length) faceMatcher = new faceapi.FaceMatcher(labeled, 0.45);
                }
            }
            isLoading.value = false;
        };

        const compressImage = (base64) => {
            return new Promise(resolve => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 600; // é™ä½è§£æåº¦ä»¥ç¯€çœæµé‡
                    const scale = MAX_WIDTH / img.width;
                    canvas.width = MAX_WIDTH;
                    canvas.height = img.height * scale;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    resolve(canvas.toDataURL('image/jpeg', 0.6)); // é«˜å£“ç¸®ç‡
                };
                img.src = base64;
            });
        };

        const submitForm = async () => {
            const target = modals.register ? registerForm : form;
            if(!target.name || !target.phone) return showToast('è«‹å¡«å¯«å®Œæ•´è³‡æ–™', 'warning');
            
            isLoading.value = true;
            try {
                const payload = { ...target };
                delete payload.agree; // ç§»é™¤ UI åƒ…ç”¨æ¬„ä½
                
                // è‹¥æœ‰æ–°ç…§ç‰‡ï¼Œç¢ºä¿å·²å£“ç¸®
                if(payload.photo && payload.photo.length > 100000) {
                   payload.photo = await compressImage(payload.photo);
                }

                if(!modals.register && payload.id) {
                    const { error } = await supabase.from('members').update({...payload, updated_at: new Date()}).eq('id', payload.id);
                    if(error) throw error;
                    showToast('æ›´æ–°æˆåŠŸ');
                } else {
                    payload.id = Date.now().toString();
                    payload.created_at = new Date();
                    payload.updated_at = new Date();
                    const { error } = await supabase.from('members').insert(payload);
                    if(error) throw error;
                    showToast('è¨»å†ŠæˆåŠŸ');
                    if(modals.register) {
                        selfServiceInput.value = payload.phone;
                        searchMode.value = 'phone';
                        performVerification();
                    }
                }
                closeModals();
                fetchMembers();
            } catch(e) { showToast(e.message, 'error', 'å„²å­˜å¤±æ•—'); }
            finally { isLoading.value = false; }
        };

        const deleteMember = async () => {
            if(!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) return;
            const { error } = await supabase.from('members').delete().eq('id', form.id);
            if(error) showToast('åˆªé™¤å¤±æ•—', 'error');
            else { showToast('å·²åˆªé™¤'); closeModals(); fetchMembers(); }
        };

        // ==========================================
        // 3. AI æƒææ ¸å¿ƒ (å„ªåŒ–ï¼šrequestAnimationFrame)
        // ==========================================
        const startVideo = async () => {
            if(!isFaceModelLoaded.value) { showToast('AI åˆå§‹åŒ–ä¸­...', 'warning'); return null; }
            const v = document.getElementById('video');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { deviceId: currentDeviceId.value ? { exact: currentDeviceId.value } : undefined, width: { ideal: 640 }, height: { ideal: 480 } } 
                });
                v.srcObject = stream;
                videoStream = stream;
                return new Promise(resolve => v.onloadedmetadata = () => { v.play(); resolve(v); });
            } catch(e) { showToast('ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿ', 'error'); return null; }
        };

        // ä½¿ç”¨éè¿´ Loop ä»£æ›¿ setIntervalï¼Œæå‡æ•ˆèƒ½
        const scanningLoop = async (video) => {
            if(!isScanning || !modals.faceScan) return;

            const now = Date.now();
            // FPS è¨ˆç®—
            if(now - lastFpsTime >= 1000) { fps.value = frameCount; frameCount = 0; lastFpsTime = now; }
            frameCount++;

            try {
                // ä½¿ç”¨ TinyFaceDetectorï¼Œé€Ÿåº¦æœ€å¿«
                const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions({ inputSize: 224, scoreThreshold: 0.5 }))
                    .withFaceLandmarks().withFaceDescriptor();

                if(detection) {
                    // 1. è¨»å†Šæ¨¡å¼ï¼šæ‹ç…§
                    if(app.scanMode === 'register') {
                        isScanning = false;
                        const canvas = document.createElement('canvas');
                        // è£åˆ‡äººè‡‰
                        const box = detection.detection.box;
                        const pad = 50;
                        canvas.width = 300; canvas.height = 300;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(video, box.x - pad, box.y - pad, box.width + (pad*2), box.height + (pad*2), 0, 0, 300, 300);
                        
                        const photo = canvas.toDataURL('image/jpeg', 0.8);
                        const desc = Array.from(detection.descriptor);
                        
                        if(modals.register) { registerForm.photo = photo; registerForm.face_descriptor = desc; }
                        else { form.photo = photo; form.face_descriptor = desc; }
                        
                        playSound('success');
                        stopFaceScan();
                        return; // çµæŸ Loop
                    }
                    
                    // 2. æœå°‹æ¨¡å¼ï¼šæ¯”å°
                    if(faceMatcher && (now - lastScanTime > 2000)) {
                        const match = faceMatcher.findBestMatch(detection.descriptor);
                        if(match.label !== 'unknown') {
                            const member = members.value.find(m => m.id === match.label);
                            if(member) {
                                lastScanTime = now;
                                playSound('success');
                                // å¯«å…¥æ­·å²ç´€éŒ„ (éåŒæ­¥ï¼Œä¸é˜»æ“‹ UI)
                                const history = member.search_history || [];
                                history.push({ timestamp: new Date().toISOString() });
                                supabase.from('members').update({ search_history: history }).eq('id', member.id).then();

                                if(app.scanMode === 'self') {
                                    verifyStatus.value = 'success';
                                    verifiedMember.value = member;
                                    stopFaceScan();
                                    return;
                                } else {
                                    scanMessage.value = `è­˜åˆ¥æˆåŠŸ: ${member.name}`;
                                    setTimeout(() => scanMessage.value='', 2000);
                                }
                            }
                        }
                    }
                }
            } catch(e) { console.error(e); }

            // è«‹æ±‚ä¸‹ä¸€å¹€
            if(isScanning) requestAnimationFrame(() => scanningLoop(video));
        };

        const startScan = async (mode) => {
            app.scanMode = mode; // register, self, search
            modals.faceScan = true;
            isScanning = true;
            const video = await startVideo();
            if(video) scanningLoop(video);
        };

        const stopFaceScan = () => {
            isScanning = false;
            modals.faceScan = false;
            if(videoStream) { videoStream.getTracks().forEach(t => t.stop()); videoStream = null; }
        };

        // ==========================================
        // 4. å…¶ä»–é‚è¼¯
        // ==========================================
        const performVerification = () => {
            const val = selfServiceInput.value.trim();
            if(!val) return showToast('è«‹è¼¸å…¥å…§å®¹', 'warning');
            
            const member = members.value.find(m => 
                (searchMode.value === 'phone' && m.phone === val) || 
                (searchMode.value === 'name' && m.name === val)
            );

            if(member) {
                verifyStatus.value = 'success';
                verifiedMember.value = member;
                playSound('success');
            } else {
                verifyStatus.value = 'fail';
                playSound('fail');
                setTimeout(() => verifyStatus.value = 'idle', 2000);
            }
        };

        const resetSelfService = () => { verifyStatus.value = 'idle'; selfServiceInput.value = ''; verifiedMember.value = null; };
        
        // Excel åŒ¯å‡º (å„ªåŒ–ï¼šæ‰¹æ¬¡è™•ç†)
        const isExporting = ref(false);
        const exportFastExcel = async () => {
            isExporting.value = true;
            try {
                const wb = new ExcelJS.Workbook();
                const ws = wb.addWorksheet('Members');
                ws.columns = [{header:'ID',key:'id'}, {header:'Name',key:'name'}, {header:'Phone',key:'phone'}, {header:'Created',key:'created_at'}];
                members.value.forEach(m => ws.addRow(m));
                const buffer = await wb.xlsx.writeBuffer();
                saveAs(new Blob([buffer]), `members_${Date.now()}.xlsx`);
                showToast('åŒ¯å‡ºå®Œæˆ');
            } catch(e) { showToast('åŒ¯å‡ºå¤±æ•—', 'error'); }
            finally { isExporting.value = false; }
        };

        // å„²å­˜è¨­å®š
        const saveConfig = () => {
            localStorage.setItem('supabase_config_v5', JSON.stringify(config));
            initSupabase();
        };
        
        const resetConfig = () => {
            if(confirm('æ¸…é™¤æ‰€æœ‰è¨­å®šï¼Ÿ')) { localStorage.removeItem('supabase_config_v5'); location.reload(); }
        };

        const filteredMembers = computed(() => {
            if(!searchQuery.value) return members.value;
            const q = searchQuery.value.toLowerCase();
            return members.value.filter(m => m.name.toLowerCase().includes(q) || m.phone.includes(q));
        });

        // çµ±è¨ˆè³‡æ–™
        const stats = computed(() => {
            const today = new Date().toISOString().slice(0,10);
            const visits = members.value.reduce((acc, m) => acc + (m.search_history?.filter(h => h.timestamp.startsWith(today)).length || 0), 0);
            return { todayVisits: visits };
        });

        // æš´éœ²çµ¦æ¨¡æ¿
        app.scanMode = ''; // æ›è¼‰åˆ° app å¯¦ä¾‹ä»¥ä¾¿ Loop å­˜å–
        return {
            config, isConfigured, saveConfig, resetConfig, checkAdmin: (cb) => config.adminPwd === prompt('Pwd?') ? cb() : alert('Err'),
            members, filteredMembers, isLoading, isExporting, exportFastExcel,
            currentTab, tabs, modals, closeModals: () => { modals.form=false; modals.register=false; stopFaceScan(); },
            form, registerForm, activeForm, activePhoto, submitForm, deleteMember,
            // Actions
            openAdminAdd: () => { Object.assign(form, {id:null,name:'',phone:'',birthday:'',photo:null,face_descriptor:null}); modals.form=true; modals.register=false; },
            editMember: (m) => { Object.assign(form, JSON.parse(JSON.stringify(m))); modals.form=true; modals.register=false; },
            openSelfRegister: () => { Object.assign(registerForm, {name:'',phone:'',birthday:'',photo:null,face_descriptor:null, agree:false}); modals.register=true; modals.form=false; },
            startScanForForm: () => startScan('register'),
            startSelfServiceFaceScan: () => startScan('self'),
            showFaceSearch: () => { modals.io=false; currentTab.value='list'; startScan('search'); },
            stopFaceScan, handleCameraSwitch: async () => { if(videoStream) { stopFaceScan(); await startScan(app.scanMode); } },
            // Verify
            selfServiceInput, searchMode, verifyStatus, verifiedMember, performVerification, resetSelfService, registerFaceFromSelfService: () => { app.editMember(verifiedMember.value); app.startScanForForm(); },
            // UI
            stats, isFaceModelLoaded, videoDevices, currentDeviceId, scanMessage, fps,
            unlockAudio, toasts
        };
    }
});

app.mount('#app');
</script>
</body>
</html>
