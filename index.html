<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI 智能會員系統 V4.0 (商用專業版)</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f1f5f9; -webkit-tap-highlight-color: transparent; overflow: hidden; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        
        /* 導航與互動 */
        .tab-btn { position: relative; color: #94a3b8; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .tab-active { color: #4f46e5; font-weight: 900; transform: translateY(-2px); }
        .tab-active::after { content: ''; position: absolute; bottom: -12px; left: 50%; transform: translateX(-50%); width: 20px; height: 4px; background: #4f46e5; border-radius: 4px; }
        
        /* 掃描動畫 */
        .scan-container { position: relative; overflow: hidden; border-radius: 24px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        .scan-line { position: absolute; width: 100%; height: 3px; background: #4f46e5; box-shadow: 0 0 15px #4f46e5, 0 0 30px #818cf8; animation: scanning 2.5s ease-in-out infinite; z-index: 10; opacity: 0.8; }
        @keyframes scanning { 0% {top:5%; opacity:0;} 10% {opacity:1;} 90% {opacity:1;} 100% {top:95%; opacity:0;} }
        
        /* 視覺優化 */
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.5); }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        
        /* 狀態動畫 */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .toast-enter-active { animation: toast-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .toast-leave-active { transition: all 0.3s ease; opacity: 0; transform: translateY(-20px); }
        @keyframes toast-in { 0% {transform: translateY(-50px) scale(0.9); opacity: 0;} 100% {transform: translateY(0) scale(1); opacity: 1;} }
        
        [v-cloak] { display: none; }
    </style>
</head>
<body>

<div id="app" v-cloak class="h-screen flex flex-col pb-safe bg-slate-50">
    
    <div v-if="!isConfigured" class="fixed inset-0 bg-slate-900 z-[100] flex items-center justify-center p-6 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]">
        <div class="bg-white rounded-3xl p-8 w-full max-w-md shadow-2xl relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-indigo-600"></div>
            <h2 class="text-3xl font-black mb-2 text-slate-800 tracking-tight">系統初始化</h2>
            <p class="text-slate-500 mb-8 text-sm">請輸入 Supabase 連線資訊以啟動商用環境</p>
            <div class="space-y-5">
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Project URL</label>
                    <input v-model="config.url" placeholder="https://xxx.supabase.co" class="w-full bg-slate-50 border border-slate-200 p-4 rounded-xl focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 outline-none transition font-mono text-sm">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">API Key (Public)</label>
                    <input v-model="config.key" type="password" placeholder="eyJ..." class="w-full bg-slate-50 border border-slate-200 p-4 rounded-xl focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 outline-none transition font-mono text-sm">
                </div>
                <button @click="saveConfig" :disabled="isChecking" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold hover:bg-indigo-700 transition shadow-lg shadow-indigo-200 disabled:opacity-70 disabled:cursor-not-allowed flex items-center justify-center">
                    <i v-if="isChecking" class="fa-solid fa-circle-notch fa-spin mr-2"></i>
                    {{ isChecking ? '連線測試中...' : '驗證並啟動' }}
                </button>
            </div>
        </div>
    </div>

    <header class="bg-white shadow-sm z-40 flex-none">
        <div class="px-5 py-3 flex justify-between items-center border-b border-slate-100">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white shadow-md shadow-indigo-200">
                    <i class="fa-solid fa-cube text-lg"></i>
                </div>
                <div>
                    <h1 class="text-lg font-black text-slate-800 leading-tight">SmartMember <span class="text-indigo-600">Pro</span></h1>
                    <div class="flex items-center gap-2">
                         <span class="w-2 h-2 rounded-full" :class="isOnline ? 'bg-emerald-500 animate-pulse' : 'bg-rose-500'"></span>
                         <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">{{ isOnline ? 'SYSTEM ONLINE' : 'OFFLINE' }}</span>
                    </div>
                </div>
            </div>
            <div class="flex gap-3">
                <button @click="refreshData" class="w-10 h-10 rounded-full bg-slate-50 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 transition flex items-center justify-center">
                    <i class="fa-solid fa-rotate-right" :class="{'fa-spin': isLoading}"></i>
                </button>
                <button @click="modals.io = true" class="w-10 h-10 rounded-full bg-slate-50 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 transition flex items-center justify-center">
                    <i class="fa-solid fa-gear"></i>
                </button>
            </div>
        </div>
        
        <div class="flex px-2 pt-1 pb-1 gap-1 bg-slate-50/50">
            <button @click="changeTab('self_service')" :class="{'tab-active': currentTab === 'self_service'}" class="tab-btn flex-1 py-3 text-sm font-medium rounded-lg hover:bg-white"><i class="fa-solid fa-mobile-screen mr-1.5"></i>自助報到</button>
            <button @click="changeTab('list')" :class="{'tab-active': currentTab === 'list'}" class="tab-btn flex-1 py-3 text-sm font-medium rounded-lg hover:bg-white"><i class="fa-solid fa-users mr-1.5"></i>會員管理</button>
            <button @click="changeTab('dashboard')" :class="{'tab-active': currentTab === 'dashboard'}" class="tab-btn flex-1 py-3 text-sm font-medium rounded-lg hover:bg-white"><i class="fa-solid fa-chart-pie mr-1.5"></i>數據中心</button>
            <button @click="enterFaceSearchMode" class="tab-btn flex-1 py-3 text-sm font-bold text-white bg-indigo-600 rounded-lg shadow-md shadow-indigo-200 active:scale-95 hover:bg-indigo-700 mx-1"><i class="fa-solid fa-expand mr-1.5"></i>AI 監控</button>
        </div>
    </header>

    <main class="flex-grow overflow-y-auto custom-scrollbar p-4 relative">
        
        <div v-show="currentTab === 'self_service'" class="h-full flex flex-col justify-center max-w-md mx-auto animate-fade-in-up">
            <div class="bg-white rounded-[2rem] shadow-xl border border-slate-100 p-8 text-center relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-indigo-500 to-purple-500"></div>
                
                <div v-if="verifyStatus === 'idle' || verifyStatus === 'fail'" class="space-y-6">
                    <div class="mb-6">
                        <div class="w-20 h-20 bg-indigo-50 rounded-full flex items-center justify-center mx-auto mb-4 text-indigo-600">
                            <i class="fa-solid fa-fingerprint text-4xl"></i>
                        </div>
                        <h2 class="text-2xl font-black text-slate-800">會員自助報到</h2>
                        <p class="text-slate-400 text-sm mt-1">請輸入您的手機號碼或姓名</p>
                    </div>

                    <div class="relative">
                        <input 
                            v-model="selfServiceInput" 
                            type="tel"
                            placeholder="輸入查詢資料..."
                            class="w-full text-center text-3xl font-bold py-4 border-b-2 border-slate-200 focus:border-indigo-500 outline-none bg-transparent transition placeholder:text-slate-200 text-slate-700 tracking-wider"
                            @keyup.enter="performVerification"
                            @focus="initAudioContext"
                        >
                        <i v-if="selfServiceInput" @click="selfServiceInput=''" class="fa-solid fa-circle-xmark absolute right-2 top-6 text-slate-300 cursor-pointer hover:text-slate-400"></i>
                    </div>

                    <button @click="performVerification" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-4 rounded-2xl text-lg font-bold shadow-lg shadow-indigo-200 active:scale-95 transition hover:shadow-xl mt-4">
                        確認報到
                    </button>

                    <div v-if="verifyStatus === 'fail'" class="bg-rose-50 text-rose-600 p-3 rounded-xl text-sm font-bold flex items-center justify-center gap-2 animate-bounce-in">
                        <i class="fa-solid fa-circle-exclamation"></i> 查無此會員資料
                    </div>
                </div>

                <div v-else-if="verifyStatus === 'success'" class="py-10">
                    <div class="w-28 h-28 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-6 animate-scale-in">
                        <i class="fa-solid fa-check text-5xl text-emerald-500"></i>
                    </div>
                    <h2 class="text-3xl font-black text-slate-800 mb-2">歡迎光臨！</h2>
                    <p class="text-xl text-slate-600 font-bold mb-8">{{ verifiedMember?.name }}</p>
                    
                    <div v-if="!verifiedMember?.face_descriptor" class="bg-indigo-50 p-4 rounded-2xl mb-6 text-left border border-indigo-100 cursor-pointer hover:bg-indigo-100 transition group" @click="registerFaceFromSelfService">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-indigo-600 shadow-sm group-hover:scale-110 transition">
                                <i class="fa-solid fa-face-viewfinder"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-indigo-900 text-sm">啟用 AI 刷臉</h4>
                                <p class="text-indigo-600/70 text-xs">下次報到只需 1 秒</p>
                            </div>
                            <i class="fa-solid fa-chevron-right ml-auto text-indigo-300"></i>
                        </div>
                    </div>

                    <button @click="resetSelfService" class="text-slate-400 hover:text-slate-600 text-sm font-medium">
                        返回首頁 ({{ countDown }}s)
                    </button>
                </div>
            </div>
        </div>

        <div v-show="currentTab === 'list'" class="max-w-5xl mx-auto pb-20">
            <div class="sticky top-0 bg-slate-50 pt-2 pb-4 z-30 space-y-4">
                <div class="relative group">
                    <i class="fa-solid fa-magnifying-glass absolute left-4 top-4 text-slate-400 group-focus-within:text-indigo-500 transition"></i>
                    <input v-model="searchQuery" type="text" placeholder="搜尋姓名或電話..." class="w-full pl-11 pr-4 py-3.5 border-0 rounded-2xl shadow-sm bg-white focus:ring-2 focus:ring-indigo-100 outline-none text-slate-700 font-medium">
                </div>
                <div class="flex justify-between items-center px-1">
                    <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Total: {{ members.length }}</span>
                    <button @click="openModal('add')" class="bg-slate-800 hover:bg-slate-700 text-white px-5 py-2 rounded-xl text-sm font-bold shadow-lg transition active:scale-95 flex items-center">
                        <i class="fa-solid fa-plus mr-2"></i> 新增
                    </button>
                </div>
            </div>

            <div v-if="isLoading" class="flex flex-col items-center py-20 text-slate-400">
                <i class="fa-solid fa-circle-notch fa-spin text-3xl mb-3 text-indigo-500"></i>
                <p class="text-sm font-bold">資料載入中...</p>
            </div>

            <div v-else class="grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
                <div v-for="member in filteredMembers" :key="member.id" @click="fetchAndEditMember(member.id)" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition cursor-pointer group hover:border-indigo-200">
                    <div class="flex items-center gap-4">
                        <div class="w-14 h-14 rounded-xl bg-slate-100 flex items-center justify-center text-slate-400 font-black text-xl border border-slate-200 group-hover:bg-indigo-50 group-hover:text-indigo-600 transition">
                            {{ member.name.charAt(0) }}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-start">
                                <h3 class="font-bold text-slate-800 text-lg truncate">{{ member.name }}</h3>
                                <i v-if="member.face_descriptor" class="fa-solid fa-face-smile text-indigo-500 text-xs" title="已註冊 AI"></i>
                            </div>
                            <p class="text-slate-500 text-sm font-mono">{{ member.phone || '無電話' }}</p>
                        </div>
                    </div>
                    <div class="mt-3 flex items-center justify-between text-xs pt-3 border-t border-slate-50">
                        <span class="px-2 py-1 rounded bg-slate-100 text-slate-500 font-bold">{{ getLoyaltyLabel(member) }}</span>
                        <span class="text-slate-300">{{ formatDateShort(member.updated_at) }}</span>
                    </div>
                </div>
            </div>
        </div>

        <div v-show="currentTab === 'dashboard'" class="max-w-4xl mx-auto space-y-6 pb-20">
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-gradient-to-br from-indigo-500 to-indigo-600 p-6 rounded-3xl shadow-lg shadow-indigo-200 text-white relative overflow-hidden">
                    <i class="fa-solid fa-users absolute -right-4 -bottom-4 text-8xl text-white/10"></i>
                    <p class="text-indigo-100 text-xs font-bold uppercase tracking-wider mb-1">今日來客</p>
                    <p class="text-4xl font-black">{{ stats.todayVisits }}</p>
                </div>
                <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                    <p class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-1">活躍佔比</p>
                    <div class="flex items-end gap-2">
                        <p class="text-4xl font-black text-slate-800">{{ stats.activeRate }}</p>
                        <span class="text-sm font-bold text-emerald-500 mb-1">%</span>
                    </div>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                <h3 class="font-bold text-slate-700 mb-6 flex items-center"><i class="fa-solid fa-clock text-indigo-500 mr-2"></i>時段熱點分析</h3>
                <div class="h-56"><canvas id="hourChart"></canvas></div>
            </div>
        </div>
    </main>

    <div v-if="modals.form" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-3xl max-h-[90vh] flex flex-col shadow-2xl overflow-hidden animate-scale-in">
            <div class="px-6 py-4 border-b flex justify-between items-center bg-slate-50">
                <h3 class="font-bold text-lg text-slate-800">{{ isEditing ? '會員資料編輯' : '新增會員' }}</h3>
                <button @click="modals.form = false" class="w-8 h-8 rounded-full hover:bg-slate-200 flex items-center justify-center transition"><i class="fa-solid fa-times text-slate-500"></i></button>
            </div>
            
            <div class="p-6 overflow-y-auto custom-scrollbar space-y-5">
                <div v-if="isDetailLoading" class="flex justify-center py-10"><i class="fa-solid fa-circle-notch fa-spin text-2xl text-indigo-500"></i></div>
                
                <div v-else class="space-y-5">
                    <div class="flex gap-4 items-start">
                        <div class="w-24 h-24 bg-slate-100 rounded-2xl overflow-hidden border border-slate-200 relative group flex-shrink-0 cursor-pointer" @click="$refs.fileInput.click()">
                            <img v-if="photoPreview" :src="photoPreview" class="w-full h-full object-cover">
                            <div v-else class="flex flex-col items-center justify-center h-full text-slate-300">
                                <i class="fa-solid fa-camera text-2xl mb-1"></i>
                                <span class="text-[10px] font-bold">上傳照片</span>
                            </div>
                            <div class="absolute inset-0 bg-black/30 flex items-center justify-center opacity-0 group-hover:opacity-100 transition">
                                <i class="fa-solid fa-pen text-white"></i>
                            </div>
                        </div>
                        <div class="flex-1 space-y-3">
                            <input v-model="form.name" placeholder="姓名 (必填)" class="w-full bg-slate-50 border-b-2 border-slate-200 p-2 focus:border-indigo-500 outline-none font-bold text-lg transition">
                            <input v-model="form.phone" type="tel" placeholder="電話號碼" class="w-full bg-slate-50 border-b-2 border-slate-200 p-2 focus:border-indigo-500 outline-none font-mono transition">
                        </div>
                    </div>

                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase">備註事項</label>
                        <textarea v-model="form.notes" rows="2" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl mt-1 focus:border-indigo-500 outline-none transition text-sm"></textarea>
                    </div>

                    <div class="bg-indigo-50/50 p-4 rounded-xl border border-indigo-100 flex items-center justify-between">
                        <div>
                            <p class="text-xs font-bold text-indigo-800 uppercase mb-1">AI 人臉識別</p>
                            <p class="text-xs text-indigo-600/70" v-if="form.face_descriptor"><i class="fa-solid fa-check-circle mr-1"></i>已註冊特徵模型</p>
                            <p class="text-xs text-slate-400" v-else>尚未註冊</p>
                        </div>
                        <button @click="startFaceRegistration" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-xs font-bold shadow hover:bg-indigo-700 transition">
                            {{ form.face_descriptor ? '重新錄入' : '立即註冊' }}
                        </button>
                    </div>

                    <div v-if="form.search_history?.length" class="border-t pt-4">
                        <p class="text-xs font-bold text-slate-400 uppercase mb-2">最近 5 筆紀錄</p>
                        <div class="space-y-2">
                            <div v-for="(h, i) in form.search_history.slice(-5).reverse()" :key="i" class="flex justify-between text-xs text-slate-600 bg-slate-50 p-2 rounded">
                                <span><i class="fa-solid fa-clock mr-1 text-slate-400"></i>{{ new Date(h.timestamp).toLocaleString() }}</span>
                                <span class="font-bold text-emerald-600">報到成功</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="p-4 border-t bg-slate-50 flex justify-between items-center" v-if="!isDetailLoading">
                <button v-if="isEditing" @click="deleteMember" class="text-rose-500 font-bold text-sm px-2 hover:bg-rose-50 py-2 rounded transition">刪除此會員</button>
                <div class="flex gap-3 ml-auto">
                    <button @click="modals.form = false" class="px-5 py-2.5 text-slate-500 font-bold hover:bg-slate-200 rounded-xl transition">取消</button>
                    <button @click="saveMember" :disabled="isSaving" class="px-6 py-2.5 bg-indigo-600 text-white rounded-xl shadow-lg shadow-indigo-200 font-bold hover:bg-indigo-700 transition disabled:opacity-70 flex items-center">
                        <i v-if="isSaving" class="fa-solid fa-circle-notch fa-spin mr-2"></i> {{ isSaving ? '處理中' : '儲存資料' }}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div v-show="modals.faceScan" class="fixed inset-0 bg-black z-[70] flex flex-col">
        <div class="absolute top-0 w-full z-30 p-4 flex justify-between items-start bg-gradient-to-b from-black/80 to-transparent">
            <div class="flex flex-col gap-2">
                <select v-model="currentDeviceId" @change="handleCameraSwitch" class="bg-black/40 text-white border border-white/20 py-2 pl-4 pr-10 rounded-full text-xs backdrop-blur-md outline-none appearance-none font-bold">
                    <option value="">自動選擇鏡頭</option>
                    <option v-for="cam in videoDevices" :key="cam.deviceId" :value="cam.deviceId">{{ cam.label || 'Camera ' + cam.deviceId.slice(0,4) }}</option>
                </select>
                <div class="text-white/60 text-[10px] px-2"><i class="fa-solid fa-temperature-half mr-1"></i>智慧溫控模式運作中</div>
            </div>
            <button @click="stopFaceScan" class="w-10 h-10 rounded-full bg-white/20 backdrop-blur-md flex items-center justify-center text-white hover:bg-white/30 transition border border-white/10">
                <i class="fa-solid fa-times text-lg"></i>
            </button>
        </div>

        <transition name="toast">
            <div v-if="scanMessage" class="absolute top-28 left-0 w-full z-40 flex justify-center px-4 pointer-events-none">
                <div class="bg-white/95 backdrop-blur-xl p-4 rounded-2xl shadow-[0_10px_40px_-10px_rgba(0,0,0,0.5)] w-full max-w-sm border border-emerald-500/30 ring-4 ring-emerald-500/20">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 rounded-full overflow-hidden border-2 border-emerald-500 flex-shrink-0 bg-slate-200">
                             <img v-if="scannedMember?.photo" :src="scannedMember.photo" class="w-full h-full object-cover">
                             <div v-else class="w-full h-full flex items-center justify-center text-emerald-600 font-bold text-xl">{{ scannedMember?.name.charAt(0) }}</div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center justify-between">
                                <h3 class="font-bold text-xl text-slate-800 truncate">{{ scannedMember?.name }}</h3>
                                <span class="bg-emerald-100 text-emerald-700 text-[10px] px-2 py-0.5 rounded-full font-black uppercase tracking-wide">Verified</span>
                            </div>
                            <p class="text-sm text-slate-500 mt-0.5">累計來訪: <span class="text-indigo-600 font-black">{{ scannedMember?.search_history?.length }}</span> 次</p>
                        </div>
                    </div>
                    <div v-if="scannedMember?.notes" class="mt-3 bg-amber-50 border border-amber-100 p-2.5 rounded-lg flex gap-2 items-start">
                        <i class="fa-solid fa-note-sticky text-amber-500 mt-0.5 text-xs"></i>
                        <p class="text-xs font-bold text-amber-800 leading-snug">{{ scannedMember.notes }}</p>
                    </div>
                </div>
            </div>
        </transition>

        <div id="video-container" class="flex-1 relative flex items-center justify-center bg-black overflow-hidden">
            <video id="video" autoplay muted playsinline class="w-full h-full object-cover opacity-80"></video>
            
            <div class="absolute w-72 h-72 rounded-[2rem] overflow-hidden border border-white/20 shadow-[0_0_0_9999px_rgba(0,0,0,0.5)]">
                <div class="scan-line"></div>
                <div class="absolute top-0 left-0 w-8 h-8 border-t-4 border-l-4 border-indigo-500 rounded-tl-xl"></div>
                <div class="absolute top-0 right-0 w-8 h-8 border-t-4 border-r-4 border-indigo-500 rounded-tr-xl"></div>
                <div class="absolute bottom-0 left-0 w-8 h-8 border-b-4 border-l-4 border-indigo-500 rounded-bl-xl"></div>
                <div class="absolute bottom-0 right-0 w-8 h-8 border-b-4 border-r-4 border-indigo-500 rounded-br-xl"></div>
            </div>
            
            <div class="absolute bottom-12 bg-black/60 backdrop-blur px-5 py-2 rounded-full text-white/90 text-sm font-mono flex items-center gap-3 border border-white/10">
                <div class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div>
                {{ isRegisterMode ? '請保持正臉並靠近框線' : 'AI 監控保護中...' }}
            </div>
        </div>
    </div>

    <input type="file" ref="fileInput" @change="handleFileSelect" accept="image/*" class="hidden">
    
    <div v-if="modals.io" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[80] flex items-center justify-center p-6">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl">
            <h3 class="font-bold text-lg mb-4 text-slate-800">系統設定</h3>
            <div class="space-y-3">
                <button @click="exportFastExcel" class="w-full py-3 bg-emerald-50 text-emerald-700 rounded-xl font-bold border border-emerald-100 hover:bg-emerald-100 transition flex items-center justify-center gap-2">
                    <i class="fa-solid fa-file-excel"></i> 匯出 Excel (含紀錄)
                </button>
                <button @click="resetConfig" class="w-full py-3 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200 transition text-sm">
                   登出 / 重置連線
                </button>
            </div>
            <button @click="modals.io = false" class="mt-6 w-full text-slate-400 py-2 hover:text-slate-600 transition text-sm">關閉視窗</button>
        </div>
    </div>

</div>

<script>
const { createApp, ref, computed, onMounted, reactive, nextTick, watch } = Vue;

createApp({
    setup() {
        // --- 狀態管理 ---
        const config = reactive({ url: '', key: '' });
        const isConfigured = ref(false);
        const isChecking = ref(false);
        const isOnline = ref(true);
        const isLoading = ref(false);
        const isSaving = ref(false);
        const currentTab = ref('self_service');
        const searchQuery = ref('');
        const members = ref([]); // 列表只存簡易資訊
        const modals = reactive({ form: false, faceScan: false, io: false });
        
        // 編輯表單
        const isEditing = ref(false);
        const isDetailLoading = ref(false);
        const form = reactive({ id: null, name: '', phone: '', notes: '', photo: null, search_history: [], face_descriptor: null });
        const photoPreview = ref(null);

        // 自助 & AI
        const selfServiceInput = ref('');
        const verifyStatus = ref('idle');
        const verifiedMember = ref(null);
        const countDown = ref(5);
        let countDownTimer = null;

        // 相機與 AI
        const videoDevices = ref([]);
        const currentDeviceId = ref('');
        const scanMessage = ref(false);
        const scannedMember = ref(null);
        const isRegisterMode = ref(false);
        
        let supabase = null;
        let videoStream = null;
        let faceMatcher = null;
        let isFaceModelLoaded = false;
        let lastScanTime = 0;
        let isDetecting = false; // 節流閥
        let audioCtx = null;

        // 統計
        const stats = reactive({ todayVisits: 0, activeRate: 0 });
        const charts = {};

        // --- 初始化與連線 ---
        onMounted(async () => {
            const saved = localStorage.getItem('supabase_config_v4');
            if(saved) { 
                Object.assign(config, JSON.parse(saved)); 
                await initSystem(); 
            }
            // 預載入 AI 模型
            loadFaceModels();
            // 監聽網路狀態
            window.addEventListener('online', () => isOnline.value = true);
            window.addEventListener('offline', () => isOnline.value = false);
        });

        const initSystem = async () => {
            if(!config.url || !config.key) return;
            isChecking.value = true;
            try {
                supabase = window.supabase.createClient(config.url, config.key);
                // 測試連線
                const { count, error } = await supabase.from('members').select('*', { count: 'exact', head: true });
                if(error) throw error;
                
                isConfigured.value = true;
                localStorage.setItem('supabase_config_v4', JSON.stringify(config));
                fetchMemberList(); // 只抓列表
                getCameras();
            } catch(e) {
                alert('連線失敗: ' + e.message);
                localStorage.removeItem('supabase_config_v4');
                isConfigured.value = false;
            } finally {
                isChecking.value = false;
            }
        };

        const loadFaceModels = async () => {
            const URL = 'https://justadudewhohacks.github.io/face-api.js/models';
            try {
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(URL)
                ]);
                isFaceModelLoaded = true;
                console.log('AI Models Loaded');
            } catch(e) {
                console.error('Model Load Failed', e);
                // 3秒後重試
                setTimeout(loadFaceModels, 3000);
            }
        };

        // --- 資料操作 (優化版) ---
        const fetchMemberList = async () => {
            isLoading.value = true;
            // 優化：列表不抓 photo (base64太大)，只抓必要欄位 + face_descriptor (用於比對)
            const { data, error } = await supabase
                .from('members')
                .select('id, name, phone, notes, updated_at, face_descriptor, search_history')
                .order('updated_at', {ascending:false});
            
            if(data) {
                members.value = data;
                calcStats();
                if(currentTab.value === 'dashboard') updateDashboard();
            }
            isLoading.value = false;
        };

        const fetchAndEditMember = async (id) => {
            isDetailLoading.value = true;
            modals.form = true;
            isEditing.value = true;
            
            // 抓取包含 photo 的完整資料
            const { data } = await supabase.from('members').select('*').eq('id', id).single();
            if(data) {
                Object.assign(form, data);
                photoPreview.value = data.photo;
            }
            isDetailLoading.value = false;
        };

        const saveMember = async () => {
            if(!form.name) return alert('請輸入姓名');
            isSaving.value = true;
            
            const payload = { ...form };
            payload.photo = photoPreview.value; // 這是已經壓縮過的 Base64
            payload.updated_at = new Date().toISOString();
            
            try {
                if(form.id) {
                    await supabase.from('members').update(payload).eq('id', form.id);
                } else {
                    payload.id = Date.now().toString();
                    payload.created_at = new Date().toISOString();
                    if(!payload.search_history) payload.search_history = [];
                    await supabase.from('members').insert(payload);
                }
                modals.form = false;
                fetchMemberList();
                
                // 如果是自助註冊後的保存
                if(currentTab.value === 'self_service' && verifiedMember.value) {
                    verifyStatus.value = 'success';
                }
            } catch(e) {
                alert('儲存失敗: ' + e.message);
            } finally {
                isSaving.value = false;
            }
        };

        // --- 音效系統 ---
        const initAudioContext = () => {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        };
        
        const playSound = (type) => {
            initAudioContext();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            if (type === 'success') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(880, audioCtx.currentTime); // A5
                osc.frequency.exponentialRampToValueAtTime(1760, audioCtx.currentTime + 0.1); 
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.3);
            } else {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, audioCtx.currentTime);
                osc.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.2);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.2);
            }
        };

        // --- 自助報到邏輯 ---
        const performVerification = async () => {
            initAudioContext();
            if (!selfServiceInput.value.trim()) return;
            
            // 本地模糊搜尋 (比網路搜尋快)
            const input = selfServiceInput.value.trim();
            const member = members.value.find(m => m.phone === input || m.name === input);

            if (member) {
                verifiedMember.value = member;
                verifyStatus.value = 'success';
                playSound('success');
                await recordVisit(member);
                startCountDown();
            } else {
                verifyStatus.value = 'fail';
                playSound('fail');
                setTimeout(() => { if(verifyStatus.value === 'fail') verifyStatus.value = 'idle'; }, 3000);
            }
        };

        const recordVisit = async (member) => {
            const h = member.search_history || [];
            h.push({ timestamp: new Date().toISOString() });
            // 更新本地快取 (立即反應)
            member.search_history = h;
            // 背景更新 DB
            supabase.from('members').update({ search_history: h }).eq('id', member.id).then();
        };

        const startCountDown = () => {
            if(countDownTimer) clearInterval(countDownTimer);
            countDown.value = 5;
            countDownTimer = setInterval(() => {
                countDown.value--;
                if(countDown.value <= 0) resetSelfService();
            }, 1000);
        };

        const resetSelfService = () => {
            if(countDownTimer) clearInterval(countDownTimer);
            verifyStatus.value = 'idle';
            selfServiceInput.value = '';
            verifiedMember.value = null;
        };

        const registerFaceFromSelfService = () => {
            if(countDownTimer) clearInterval(countDownTimer);
            fetchAndEditMember(verifiedMember.value.id).then(() => {
                startFaceRegistration();
            });
        };

        // --- 相機與 AI 核心 (優化版) ---
        const getCameras = async () => {
            try {
                await navigator.mediaDevices.getUserMedia({ video: true }); // 觸發權限請求
                const devices = await navigator.mediaDevices.enumerateDevices();
                videoDevices.value = devices.filter(d => d.kind === 'videoinput');
                // 優先使用後置鏡頭
                const back = videoDevices.value.find(d => d.label.toLowerCase().includes('back') || d.label.toLowerCase().includes('environment'));
                currentDeviceId.value = back ? back.deviceId : (videoDevices.value[0]?.deviceId || '');
            } catch(e) { console.error('Camera perm denied'); }
        };

        const handleCameraSwitch = async () => {
            if(videoStream) {
                videoStream.getTracks().forEach(t => t.stop());
                await startVideo();
            }
        };

        const startVideo = async () => {
            const video = document.getElementById('video');
            if(!video) return null;
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        deviceId: currentDeviceId.value ? { exact: currentDeviceId.value } : undefined,
                        width: { ideal: 1280 }, // 降低解析度以提升效能
                        height: { ideal: 720 }
                    } 
                });
                video.srcObject = videoStream;
                return new Promise(resolve => {
                    video.onloadedmetadata = () => { video.play(); resolve(video); };
                });
            } catch(e) { 
                alert('鏡頭啟動失敗，請檢查權限'); 
                modals.faceScan = false;
                return null; 
            }
        };

        // 註冊模式 (拍照)
        const startFaceRegistration = async () => {
            isRegisterMode.value = true;
            modals.faceScan = true;
            const video = await startVideo();
            if(!video) return;

            // 註冊不需要高頻偵測，每 500ms 檢查一次即可
            const t = setInterval(async () => {
                if(!modals.faceScan || !isRegisterMode.value) return clearInterval(t);
                
                // 使用 TinyFaceDetector 提升速度
                const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
                
                if(detection) {
                    clearInterval(t);
                    form.face_descriptor = Array.from(detection.descriptor);
                    
                    // --- 關鍵修正：安全截圖算法 ---
                    const cvs = document.createElement('canvas');
                    cvs.width = 300; cvs.height = 300;
                    const ctx = cvs.getContext('2d');
                    const b = detection.detection.box;
                    
                    // 計算安全邊界 (Clamp)
                    const sX = Math.max(0, b.x - 50);
                    const sY = Math.max(0, b.y - 50);
                    const sW = Math.min(b.width + 100, video.videoWidth - sX);
                    const sH = Math.min(b.height + 100, video.videoHeight - sY);

                    ctx.drawImage(video, sX, sY, sW, sH, 0, 0, 300, 300);
                    
                    photoPreview.value = cvs.toDataURL('image/jpeg', 0.7); // 70% 品質壓縮
                    playSound('success');
                    
                    // 稍微延遲關閉讓用戶看到成功
                    setTimeout(() => {
                        stopFaceScan();
                        // 如果是在表單中觸發的，不關閉表單，只關閉相機 Modal
                    }, 500);
                }
            }, 500);
        };

        // 搜尋模式 (監控)
        const enterFaceSearchMode = () => {
            isRegisterMode.value = false;
            showFaceSearch();
        };

        const showFaceSearch = async () => {
            if(!isFaceModelLoaded) return alert('AI 模型載入中，請稍候...');
            
            // 準備比對資料
            const labeledDescriptors = members.value
                .filter(m => m.face_descriptor)
                .map(m => new faceapi.LabeledFaceDescriptors(m.id, [new Float32Array(m.face_descriptor)]));
            
            if(labeledDescriptors.length === 0) return alert('尚未有會員註冊人臉資料');
            
            faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, 0.45); // 嚴格度 0.45
            modals.faceScan = true;
            const video = await startVideo();
            if(!video) return;

            lastScanTime = 0;
            isDetecting = false;
            detectLoop(video);
        };

        const detectLoop = async (video) => {
            if(!modals.faceScan || isRegisterMode.value) return;

            // 溫控機制：如果正在處理或是剛成功過，跳過
            if (isDetecting || (Date.now() - lastScanTime < 3000)) {
                requestAnimationFrame(() => detectLoop(video));
                return;
            }

            isDetecting = true;
            try {
                const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
                
                if (detection) {
                    const bestMatch = faceMatcher.findBestMatch(detection.descriptor);
                    if (bestMatch.label !== 'unknown') {
                        const member = members.value.find(m => m.id === bestMatch.label);
                        if(member) {
                            lastScanTime = Date.now();
                            scannedMember.value = member;
                            scanMessage.value = true;
                            playSound('success');
                            recordVisit(member);
                            setTimeout(() => scanMessage.value = false, 2500);
                        }
                    }
                }
            } catch(e) {
                console.error(e);
            } finally {
                // 強制休息 200ms 釋放 CPU
                setTimeout(() => {
                    isDetecting = false;
                    requestAnimationFrame(() => detectLoop(video));
                }, 200);
            }
        };

        const stopFaceScan = () => {
            if(videoStream) { videoStream.getTracks().forEach(t => t.stop()); videoStream = null; }
            modals.faceScan = false;
            isRegisterMode.value = false;
        };

        // --- 圖片處理 ---
        const handleFileSelect = async (e) => {
            const file = e.target.files[0];
            if(!file) return;
            
            // 壓縮圖片
            const img = new Image();
            const reader = new FileReader();
            reader.onload = (ev) => {
                img.src = ev.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    // 限制最大寬度 400
                    const scale = 400 / img.width;
                    canvas.width = 400;
                    canvas.height = img.height * scale;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    photoPreview.value = canvas.toDataURL('image/jpeg', 0.7);
                };
            };
            reader.readAsDataURL(file);
        };

        // --- 輔助函式 ---
        const changeTab = (t) => {
            currentTab.value = t;
            // 如果切換到列表，重新抓一次以保證數據最新
            if(t === 'list') fetchMemberList(); 
        };
        const resetConfig = () => {
            if(confirm('確定要登出並清除設定嗎？')) {
                localStorage.removeItem('supabase_config_v4');
                location.reload();
            }
        };
        const getLoyaltyLabel = (m) => {
            const count = m.search_history?.length || 0;
            if(count > 20) return 'VIP 會員';
            if(count > 5) return '熟客';
            return '新會員';
        };
        const formatDateShort = (d) => {
            if(!d) return '-';
            const date = new Date(d);
            return `${date.getMonth()+1}/${date.getDate()}`;
        };
        const openModal = (type) => {
            if(type === 'add') {
                Object.assign(form, { id: null, name: '', phone: '', notes: '', photo: null, search_history: [], face_descriptor: null });
                photoPreview.value = null;
                isEditing.value = false;
            }
            modals.form = true;
        };
        const deleteMember = async () => {
            if(confirm('確定刪除此會員？不可復原。')) {
                await supabase.from('members').delete().eq('id', form.id);
                modals.form = false;
                fetchMemberList();
            }
        };
        const refreshData = () => fetchMemberList();

        const filteredMembers = computed(() => {
            const q = searchQuery.value.toLowerCase();
            if(!q) return members.value;
            return members.value.filter(m => m.name.toLowerCase().includes(q) || m.phone.includes(q));
        });

        // 簡單 Excel 導出
        const exportFastExcel = async () => {
             alert('商用版建議使用後台 API 進行大數據導出，此處僅演示簡易導出。');
             // 這裡保留原有的 ExcelJS 邏輯即可，或簡化為 CSV
             const ws = XLSX.utils.json_to_sheet(members.value.map(m => ({
                 姓名: m.name,
                 電話: m.phone,
                 備註: m.notes,
                 來訪次數: m.search_history?.length || 0,
                 最後來訪: m.search_history?.slice(-1)[0]?.timestamp || ''
             })));
             const wb = XLSX.utils.book_new();
             XLSX.utils.book_append_sheet(wb, ws, "Members");
             XLSX.writeFile(wb, "Member_Export.xlsx");
        };

        return {
            config, isConfigured, saveConfig: initSystem, isChecking, isOnline, isLoading, isSaving, 
            currentTab, changeTab, members, filteredMembers, searchQuery, refreshData,
            modals, form, photoPreview, isEditing, isDetailLoading, openModal, saveMember, deleteMember, fetchAndEditMember,
            videoDevices, currentDeviceId, scanMessage, scannedMember, isRegisterMode, handleCameraSwitch, stopFaceScan,
            selfServiceInput, verifyStatus, verifiedMember, countDown, performVerification, resetSelfService, registerFaceFromSelfService,
            startFaceRegistration, enterFaceSearchMode, initAudioContext, handleFileSelect, resetConfig,
            stats, getLoyaltyLabel, formatDateShort, exportFastExcel
        };
    }
}).mount('#app');
</script>
</body>
</html>
