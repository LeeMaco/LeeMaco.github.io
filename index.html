<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI 會員系統 V4.1 (修復版)</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .tab-btn { position: relative; color: #64748b; transition: all 0.3s; }
        .tab-active { color: #4f46e5; font-weight: bold; }
        .tab-active::after { content: ''; position: absolute; bottom: -12px; left: 0; width: 100%; height: 3px; background: #4f46e5; border-radius: 3px 3px 0 0; }
        .loader { width: 18px; height: 18px; border: 2px solid #e2e8f0; border-top-color: #4f46e5; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        #video-container video { width: 100%; height: 100%; object-fit: cover; }
        .bounce-enter-active { animation: bounce-in 0.5s; }
        @keyframes bounce-in { 0% {transform: scale(0);} 50% {transform: scale(1.1);} 100% {transform: scale(1);} }
    </style>
</head>
<body>

<div id="app" class="min-h-screen flex flex-col pb-safe">
    
    <div v-if="!isConfigured" class="fixed inset-0 bg-slate-900 z-[99] flex items-center justify-center p-6">
        <div class="bg-white rounded-2xl p-8 w-full max-w-md shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-slate-800">系統初始化 V4.1</h2>
                <button @click="resetConfig" class="text-xs text-rose-500 underline">清除設定</button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase">Supabase URL</label>
                    <input v-model="config.url" class="w-full border-2 border-slate-200 p-3 rounded-xl focus:border-indigo-500 outline-none transition" placeholder="https://...">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase">Supabase Key</label>
                    <input v-model="config.key" class="w-full border-2 border-slate-200 p-3 rounded-xl focus:border-indigo-500 outline-none transition" placeholder="eyJ...">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase text-rose-500">管理員密碼</label>
                    <input v-model="config.adminPwd" type="password" placeholder="預設: 0000" class="w-full border-2 border-rose-200 p-3 rounded-xl focus:border-rose-500 outline-none transition bg-rose-50">
                </div>
                <button @click="saveConfig" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 transition">啟動系統</button>
            </div>
            <p class="text-xs text-slate-400 mt-4 text-center">如遇白畫面，請按左上角「清除設定」重試</p>
        </div>
    </div>

    <header class="bg-white shadow-sm sticky top-0 z-40">
        <div class="px-5 py-4 flex justify-between items-center">
            <h1 class="text-xl font-bold text-slate-800 flex items-center"><i class="fa-solid fa-shield-halved text-indigo-600 mr-2"></i>會員系統 V4.1</h1>
            <div class="flex gap-4 items-center">
                <button @click="resetConfig" class="text-slate-300 hover:text-slate-500"><i class="fa-solid fa-gear"></i></button>
                <button @click="checkAdmin(() => modals.io = true)" class="text-slate-400 hover:text-indigo-600 transition"><i class="fa-solid fa-file-export text-xl"></i></button>
                
                <div class="flex items-center gap-2 text-xs font-bold bg-slate-100 px-3 py-1.5 rounded-full">
                    <span v-if="isLoading" class="loader"></span>
                    <span v-else class="text-emerald-500 flex items-center"><i class="fa-solid fa-database mr-1.5"></i>{{ members.length }}</span>
                    <span class="w-[1px] h-3 bg-slate-300 mx-1"></span>
                    <span :class="isFaceModelLoaded ? 'text-indigo-500' : 'text-slate-400'" class="flex items-center">
                        <i class="fa-solid" :class="isFaceModelLoaded ? 'fa-brain' : 'fa-circle-notch fa-spin'"></i>
                    </span>
                </div>
            </div>
        </div>
        <div class="flex border-t border-slate-100 bg-white px-2">
            <button @click="currentTab = 'self_service'" :class="{'tab-active': currentTab === 'self_service'}" class="tab-btn flex-1 py-3 text-sm text-indigo-600"><i class="fa-solid fa-user-check mr-1.5"></i>自助認證</button>
            <button @click="currentTab = 'list'" :class="{'tab-active': currentTab === 'list'}" class="tab-btn flex-1 py-3 text-sm"><i class="fa-solid fa-list-ul mr-1.5"></i>列表</button>
            <button @click="currentTab = 'dashboard'" :class="{'tab-active': currentTab === 'dashboard'}" class="tab-btn flex-1 py-3 text-sm"><i class="fa-solid fa-chart-line mr-1.5"></i>分析</button>
            <button @click="showFaceSearch" class="tab-btn flex-1 py-3 text-sm text-indigo-600 bg-indigo-50/50"><i class="fa-solid fa-expand mr-1.5"></i>AI 掃描</button>
        </div>
    </header>

    <main class="flex-grow p-4 overflow-y-auto bg-slate-50">
        
        <div v-show="currentTab === 'self_service'" class="max-w-md mx-auto mt-4">
            <div class="bg-white rounded-3xl shadow-lg overflow-hidden border border-slate-100 p-8 min-h-[60vh] flex flex-col items-center justify-center text-center">
                
                <div v-if="verifyStatus === 'idle' || verifyStatus === 'fail'" class="w-full space-y-6">
                    <div class="space-y-2">
                        <i class="fa-solid fa-mobile-screen-button text-5xl text-indigo-500 mb-2"></i>
                        <h2 class="text-2xl font-black text-slate-800">會員自助認證</h2>
                        <p class="text-slate-400 text-sm">請輸入您的手機號碼進行報到</p>
                    </div>

                    <div class="flex justify-center gap-2 mb-4">
                         <span class="text-xs font-bold px-2 py-1 rounded cursor-pointer transition" :class="searchMode === 'phone' ? 'bg-indigo-100 text-indigo-600' : 'text-slate-400'" @click="searchMode='phone'">手機搜尋</span>
                         <span class="text-xs font-bold px-2 py-1 rounded cursor-pointer transition" :class="searchMode === 'name' ? 'bg-indigo-100 text-indigo-600' : 'text-slate-400'" @click="searchMode='name'">姓名搜尋</span>
                    </div>

                    <input v-model="selfServiceInput" :type="searchMode === 'phone' ? 'tel' : 'text'" :placeholder="searchMode === 'phone' ? '請輸入電話號碼...' : '請輸入姓名...'" class="w-full text-center text-2xl font-bold py-4 border-b-2 border-slate-200 focus:border-indigo-500 outline-none bg-transparent transition placeholder:text-slate-300" @keyup.enter="performVerification">

                    <button @click="performVerification" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-4 rounded-2xl text-lg font-bold shadow-lg shadow-indigo-200 active:scale-95 transition">確認送出</button>

                    <div v-if="verifyStatus === 'fail'" class="mt-4 bg-rose-50 border border-rose-100 p-4 rounded-xl animate-pulse">
                        <p class="text-rose-600 font-bold text-lg"><i class="fa-solid fa-circle-xmark mr-1"></i> 驗證失敗</p>
                        <p class="text-slate-500 text-sm mt-1">找不到此資料</p>
                        <p class="text-indigo-600 text-sm font-bold mt-2 cursor-pointer underline" @click="searchMode = searchMode === 'phone' ? 'name' : 'phone'">改試試{{ searchMode === 'phone' ? '姓名' : '電話' }}查詢？</p>
                    </div>
                </div>

                <div v-else-if="verifyStatus === 'success'" class="w-full space-y-6">
                    <div class="w-24 h-24 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fa-solid fa-check text-5xl text-emerald-500"></i>
                    </div>
                    <div>
                        <h2 class="text-3xl font-black text-slate-800">認證成功！</h2>
                        <p class="text-lg text-slate-600 mt-2">歡迎回來，<span class="font-bold text-indigo-600">{{ verifiedMember && verifiedMember.name }}</span></p>
                    </div>

                    <div v-if="verifiedMember && !verifiedMember.face_descriptor" class="bg-indigo-50 border border-indigo-100 p-5 rounded-2xl mt-4">
                        <h4 class="font-bold text-indigo-800 mb-1"><i class="fa-solid fa-face-smile mr-1"></i> 還沒註冊人臉嗎？</h4>
                        <p class="text-indigo-600/80 text-sm mb-4">註冊後，下次只要「刷臉」就能秒速報到喔！</p>
                        <button @click="registerFaceFromSelfService" class="w-full bg-white border border-indigo-200 text-indigo-600 py-3 rounded-xl font-bold hover:bg-indigo-50 transition shadow-sm"><i class="fa-solid fa-camera mr-1"></i> 立即掃描人臉</button>
                    </div>
                    
                    <div v-else class="bg-emerald-50 border border-emerald-100 p-4 rounded-2xl mt-4">
                        <p class="text-emerald-700 font-bold flex items-center justify-center"><i class="fa-solid fa-check-circle mr-2"></i> 您已完成 AI 人臉註冊</p>
                    </div>

                    <button @click="resetSelfService" class="text-slate-400 hover:text-slate-600 text-sm mt-6">返回首頁</button>
                </div>
            </div>
        </div>

        <div v-show="currentTab === 'list'" class="space-y-4 max-w-4xl mx-auto">
            <div class="relative group">
                <i class="fa-solid fa-magnifying-glass absolute left-4 top-4 text-slate-400 group-focus-within:text-indigo-500 transition"></i>
                <input v-model="searchQuery" type="text" placeholder="搜尋姓名或電話..." class="w-full pl-11 pr-4 py-3.5 border-0 rounded-2xl shadow-sm bg-white focus:ring-2 focus:ring-indigo-100 outline-none text-slate-700">
            </div>

            <div class="flex justify-between items-center px-1">
                <span class="text-sm font-medium text-slate-500">會員總數：{{ members.length }} 人</span>
                <button @click="openModal('add')" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2.5 rounded-xl text-sm font-bold shadow-lg shadow-indigo-200 transition active:scale-95"><i class="fa-solid fa-plus mr-1.5"></i>新增會員</button>
            </div>

            <div class="grid gap-3 sm:grid-cols-2">
                <div v-for="member in filteredMembers" :key="member.id" @click="editMember(member)" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-4 hover:shadow-md transition cursor-pointer relative overflow-hidden group">
                    <div class="w-16 h-16 rounded-xl bg-slate-100 overflow-hidden border border-slate-200 flex-shrink-0">
                        <img :src="member.photo || 'https://via.placeholder.com/150?text=No+Img'" class="w-full h-full object-cover">
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-start">
                            <h3 class="font-bold text-slate-800 text-lg">{{ member.name }}</h3>
                            <span class="text-xs font-bold px-2.5 py-1 rounded-lg" :class="getLoyaltyClass(member)">{{ getLoyaltyLabel(member) }}</span>
                        </div>
                        <p class="text-slate-500 text-sm mt-0.5">{{ member.phone }}</p>
                        <p v-if="member.notes" class="text-xs text-amber-600 mt-2 truncate bg-amber-50 inline-block px-2 py-0.5 rounded"><i class="fa-solid fa-note-sticky mr-1"></i>{{ member.notes }}</p>
                    </div>
                </div>
            </div>
        </div>

        <div v-show="currentTab === 'dashboard'" class="space-y-6 max-w-4xl mx-auto pb-10">
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-white p-5 rounded-2xl shadow-sm border-l-4 border-indigo-500">
                    <p class="text-slate-400 text-xs font-bold uppercase tracking-wider">今日來客</p>
                    <p class="text-3xl font-black text-slate-800 mt-1">{{ stats.todayVisits }}</p>
                </div>
                <div class="bg-white p-5 rounded-2xl shadow-sm border-l-4 border-emerald-500">
                    <p class="text-slate-400 text-xs font-bold uppercase tracking-wider">活躍佔比</p>
                    <p class="text-3xl font-black text-slate-800 mt-1">{{ stats.activeRate }}%</p>
                </div>
            </div>
            <div class="bg-white p-5 rounded-2xl shadow-sm">
                <h3 class="font-bold text-slate-700 mb-4 flex items-center"><i class="fa-solid fa-clock text-indigo-500 mr-2"></i>熱門時段</h3>
                <div class="h-48"><canvas id="hourChart"></canvas></div>
            </div>
            <div class="grid sm:grid-cols-2 gap-4">
                <div class="bg-white p-5 rounded-2xl shadow-sm">
                    <h3 class="font-bold text-slate-700 mb-4 flex items-center"><i class="fa-solid fa-users text-rose-500 mr-2"></i>客群結構</h3>
                    <div class="h-40 relative"><canvas id="loyaltyChart"></canvas></div>
                </div>
                <div class="bg-white p-5 rounded-2xl shadow-sm">
                    <h3 class="font-bold text-slate-700 mb-4 flex items-center"><i class="fa-solid fa-chart-area text-blue-500 mr-2"></i>七日流量</h3>
                    <div class="h-40"><canvas id="trendChart"></canvas></div>
                </div>
            </div>
        </div>
    </main>

    <div v-if="modals.form" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-2xl max-h-[95vh] flex flex-col shadow-2xl overflow-hidden">
            <div class="px-6 py-4 border-b flex justify-between items-center bg-slate-50">
                <h3 class="font-bold text-lg text-slate-800">{{ isEditing ? '編輯會員資料' : '新增會員' }}</h3>
                <button @click="modals.form = false" class="w-8 h-8 rounded-full bg-white hover:bg-slate-100 flex items-center justify-center transition"><i class="fa-solid fa-times text-slate-500"></i></button>
            </div>
            <div class="p-6 overflow-y-auto space-y-5">
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2">
                        <label class="text-xs font-bold text-slate-500 uppercase">姓名 <span class="text-red-500">*</span></label>
                        <input v-model="form.name" class="w-full border-2 border-slate-200 p-3 rounded-xl mt-1 focus:border-indigo-500 outline-none transition bg-slate-50 focus:bg-white">
                    </div>
                    <div class="col-span-2">
                        <label class="text-xs font-bold text-slate-500 uppercase">電話</label>
                        <input v-model="form.phone" type="tel" class="w-full border-2 border-slate-200 p-3 rounded-xl mt-1 focus:border-indigo-500 outline-none transition bg-slate-50 focus:bg-white">
                    </div>
                    <div class="col-span-2">
                        <label class="text-xs font-bold text-slate-500 uppercase">備註</label>
                        <textarea v-model="form.notes" rows="2" class="w-full border-2 border-slate-200 p-3 rounded-xl mt-1 focus:border-indigo-500 outline-none transition bg-slate-50 focus:bg-white" placeholder="喜好、特徵..."></textarea>
                    </div>
                </div>
                
                <div class="border-t border-slate-100 pt-4">
                    <label class="text-xs font-bold text-slate-500 uppercase block mb-3">會員照片與 AI 識別</label>
                    <div class="flex gap-4 mb-4">
                        <div class="w-24 h-24 bg-slate-100 rounded-xl overflow-hidden border border-slate-200 shadow-inner relative flex-shrink-0">
                            <img v-if="photoPreview" :src="photoPreview" class="w-full h-full object-cover">
                            <div v-else class="flex items-center justify-center h-full text-slate-300"><i class="fa-solid fa-user text-3xl"></i></div>
                        </div>
                        <div class="flex flex-col justify-center gap-2 flex-1">
                             <button @click="$refs.fileInput.click()" class="w-full bg-white border border-slate-200 hover:bg-slate-50 py-2 rounded-lg text-sm font-bold text-slate-600 transition shadow-sm">
                                <i class="fa-solid fa-upload mr-1"></i> 上傳照片
                            </button>
                            <p class="text-xs text-slate-400">支援 JPG/PNG，自動優化畫質</p>
                        </div>
                    </div>
                    <button @click="startFaceRegistration" class="w-full py-4 rounded-xl text-white font-bold text-lg shadow-lg shadow-indigo-200 transition transform active:scale-95 flex items-center justify-center relative overflow-hidden group" :class="form.face_descriptor ? 'bg-gradient-to-r from-emerald-500 to-teal-500' : 'bg-gradient-to-r from-indigo-500 to-purple-600 animate-pulse'">
                        <i class="fa-solid fa-camera text-2xl mr-3"></i>
                        <span>{{ form.face_descriptor ? '重新錄入 AI 人臉' : '註冊 AI 人臉辨識' }}</span>
                    </button>
                </div>
            </div>
            <div class="p-4 border-t bg-slate-50 flex justify-between items-center">
                <button v-if="isEditing" @click="checkAdmin(() => deleteMember())" class="text-rose-500 font-bold text-sm px-2 hover:text-rose-600"><i class="fa-solid fa-lock mr-1"></i>刪除會員</button>
                <div class="flex gap-3 ml-auto">
                    <button @click="modals.form = false" class="px-5 py-2.5 text-slate-500 font-bold hover:bg-slate-200 rounded-lg transition">取消</button>
                    <button @click="saveMember" class="px-6 py-2.5 bg-indigo-600 text-white rounded-lg shadow-lg shadow-indigo-200 font-bold hover:bg-indigo-700 transition">儲存資料</button>
                </div>
            </div>
        </div>
    </div>

    <div v-show="modals.faceScan" class="fixed inset-0 bg-black z-[60] flex flex-col">
        <div class="absolute top-0 w-full z-30 p-4 flex justify-between bg-gradient-to-b from-black/80 to-transparent">
            <select v-model="currentDeviceId" @change="handleCameraSwitch" class="bg-black/40 text-white border border-white/20 py-2 pl-4 pr-10 rounded-full text-sm backdrop-blur-md outline-none appearance-none">
                <option value="">自動選擇鏡頭</option>
                <option v-for="cam in videoDevices" :key="cam.deviceId" :value="cam.deviceId">{{ cam.label || 'Camera' }}</option>
            </select>
            <button @click="stopFaceScan" class="w-10 h-10 rounded-full bg-white/20 backdrop-blur-md flex items-center justify-center text-white hover:bg-white/30"><i class="fa-solid fa-times"></i></button>
        </div>

        <div v-if="scanMessage" class="absolute top-24 left-0 w-full z-40 flex justify-center px-4 pointer-events-none">
            <div class="bg-white/95 backdrop-blur-xl p-4 rounded-2xl shadow-[0_10px_40px_-10px_rgba(0,0,0,0.3)] w-full max-w-sm border border-emerald-100">
                <div class="flex items-center gap-4">
                    <div class="w-16 h-16 rounded-full overflow-hidden border-2 border-emerald-500 shadow-sm flex-shrink-0">
                        <img :src="scannedMember && scannedMember.photo ? scannedMember.photo : ''" class="w-full h-full object-cover">
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center justify-between">
                            <h3 class="font-bold text-xl text-slate-800 truncate">{{ scannedMember && scannedMember.name }}</h3>
                            <span class="bg-emerald-100 text-emerald-700 text-xs px-2 py-0.5 rounded font-bold">已記錄</span>
                        </div>
                        <p class="text-sm text-slate-500">來訪: <span class="text-indigo-600 font-black">{{ scannedMember && scannedMember.search_history && scannedMember.search_history.length }}</span> 次</p>
                    </div>
                </div>
                <div v-if="scannedMember && scannedMember.notes" class="mt-3 bg-amber-50 border border-amber-100 p-3 rounded-xl flex gap-3">
                    <i class="fa-solid fa-circle-exclamation text-amber-500 mt-0.5"></i>
                    <p class="text-sm font-bold text-amber-800 leading-snug">{{ scannedMember.notes }}</p>
                </div>
            </div>
        </div>

        <div id="video-container" class="flex-1 relative flex items-center justify-center bg-black">
            <video id="video" autoplay muted playsinline></video>
            <div class="absolute w-72 h-72 border-2 border-white/30 rounded-3xl overflow-hidden">
                <div class="scan-line"></div>
                <div class="absolute inset-0 border-4 border-indigo-500/50 rounded-3xl"></div>
            </div>
            <div class="absolute bottom-10 bg-black/50 backdrop-blur px-4 py-2 rounded-full text-white/80 text-sm font-mono flex items-center gap-2">
                <div class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div>AI 辨識中...
            </div>
        </div>
    </div>

    <div v-if="modals.io" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl">
            <h3 class="font-bold text-lg mb-4 text-slate-800">資料管理</h3>
            <div class="space-y-3">
                <button @click="exportFastExcel" class="w-full py-3.5 bg-emerald-50 text-emerald-700 rounded-xl font-bold border border-emerald-100 hover:bg-emerald-100 transition flex items-center justify-center gap-2 disabled:opacity-50" :disabled="isExporting">
                    <i v-if="isExporting" class="fa-solid fa-circle-notch fa-spin"></i>
                    <i v-else class="fa-solid fa-file-excel"></i> 
                    {{ isExporting ? '處理中...' : '極速導出 (含照片)' }}
                </button>
                <div class="border-t border-slate-100 pt-4 mt-2">
                     <p class="text-xs font-bold text-slate-400 mb-2 uppercase">資料還原 (Excel/JSON)</p>
                     <input type="file" @change="handleImport" accept=".xlsx,.xls,.json" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 cursor-pointer"/>
                </div>
            </div>
            <button @click="modals.io = false" class="mt-6 w-full text-slate-400 py-2 hover:text-slate-600 transition">關閉</button>
        </div>
    </div>
    <input type="file" ref="fileInput" @change="handleFileSelect" accept="image/*" class="hidden">
</div>

<script>
const { createApp, ref, computed, onMounted, reactive, nextTick, watch } = Vue;

const app = createApp({
    setup() {
        const config = reactive({ url: '', key: '', adminPwd: '' });
        const isConfigured = ref(false);
        const members = ref([]);
        const isLoading = ref(false);
        const isExporting = ref(false);
        const currentTab = ref('self_service');
        const searchQuery = ref('');
        const modals = reactive({ form: false, faceScan: false, io: false });
        const isEditing = ref(false);
        const form = reactive({ id: null, name: '', phone: '', notes: '', photo: null, search_history: [], face_descriptor: null });
        const photoPreview = ref(null);
        
        const selfServiceInput = ref('');
        const verifyStatus = ref('idle');
        const verifiedMember = ref(null);
        const searchMode = ref('phone');

        const videoDevices = ref([]);
        const currentDeviceId = ref('');
        const scanMessage = ref(false);
        const scannedMember = ref(null);
        let supabase = null, charts = {}, videoStream = null, faceMatcher = null, isFaceModelLoaded = false;
        let lastScanTime = 0;
        const stats = reactive({ todayVisits: 0, activeRate: 0 });

        onMounted(async () => {
            try {
                const saved = localStorage.getItem('supabase_config');
                if(saved) { Object.assign(config, JSON.parse(saved)); initSystem(); }
            } catch(e) { console.error("Init error", e); resetConfig(); }
            loadFaceModels(); getCameras();
        });

        const initSystem = async () => {
            if(!config.url || !config.key) return;
            try {
                if(!window.supabase) throw new Error("Supabase Library not loaded");
                supabase = window.supabase.createClient(config.url, config.key);
                isConfigured.value = true;
                fetchMembers();
            } catch(e) { alert("初始化失敗: " + e.message); isConfigured.value = false; }
        };

        const loadFaceModels = async () => {
            const URL = 'https://justadudewhohacks.github.io/face-api.js/models';
            await Promise.all([
                faceapi.nets.tinyFaceDetector.loadFromUri(URL),
                faceapi.nets.faceLandmark68Net.loadFromUri(URL),
                faceapi.nets.faceRecognitionNet.loadFromUri(URL)
            ]);
            isFaceModelLoaded = true;
        };

        const getCameras = async () => {
            try {
                await navigator.mediaDevices.getUserMedia({ video: true });
                const devices = await navigator.mediaDevices.enumerateDevices();
                videoDevices.value = devices.filter(d => d.kind === 'videoinput');
                const back = videoDevices.value.find(d => d.label.toLowerCase().includes('back'));
                currentDeviceId.value = back ? back.deviceId : (videoDevices.value[0]?.deviceId || '');
            } catch(e) {}
        };

        const fetchMembers = async () => {
            isLoading.value = true;
            const { data, error } = await supabase.from('members').select('*').order('updated_at', {ascending:false});
            if(data) members.value = data;
            isLoading.value = false;
            calcStats();
            if(currentTab.value === 'dashboard') updateDashboard();
        };

        const checkAdmin = (action) => {
            const pwd = prompt("請輸入管理員密碼以繼續：");
            const targetPwd = config.adminPwd || '0000';
            if(pwd === targetPwd) { if(typeof action === 'function') action(); } 
            else { alert("密碼錯誤"); }
        };

        const saveConfig = () => { localStorage.setItem('supabase_config', JSON.stringify(config)); initSystem(); };
        const resetConfig = () => { if(confirm('確定重設系統設定？')) { localStorage.removeItem('supabase_config'); location.reload(); } };

        const performVerification = () => {
            if (!selfServiceInput.value.trim()) return;
            const input = selfServiceInput.value.trim();
            const member = members.value.find(m => (searchMode.value === 'phone' && m.phone === input) || (searchMode.value === 'name' && m.name === input));
            if (member) {
                verifyStatus.value = 'success'; verifiedMember.value = member;
                const h = member.search_history||[]; h.push({timestamp:new Date().toISOString()});
                member.search_history = h; supabase.from('members').update({search_history:h}).eq('id',member.id).then();
            } else {
                verifyStatus.value = 'fail';
                setTimeout(() => { if(verifyStatus.value === 'fail') verifyStatus.value = 'idle'; }, 5000);
            }
        };

        const resetSelfService = () => { verifyStatus.value = 'idle'; selfServiceInput.value = ''; verifiedMember.value = null; };
        const registerFaceFromSelfService = () => { editMember(verifiedMember.value); startFaceRegistration(); };

        const saveMember = async () => {
            if(!form.name) return alert('請輸入姓名');
            isLoading.value = true;
            const payload = { name: form.name, phone: form.phone, notes: form.notes, photo: photoPreview.value, face_descriptor: form.face_descriptor, updated_at: new Date().toISOString() };
            try {
                if(form.id) { await supabase.from('members').update(payload).eq('id', form.id); } 
                else { 
                    payload.id = Date.now().toString(); payload.created_at = new Date().toISOString(); payload.search_history = [];
                    await supabase.from('members').insert(payload); 
                }
                modals.form = false; fetchMembers();
                if(currentTab.value === 'self_service') verifyStatus.value = 'success';
            } catch(e) { alert("儲存失敗: " + e.message); } finally { isLoading.value = false; }
        };

        // --- 核心優化：JPEG 圖片壓縮與導出 ---
        const compressImage = (base64, targetWidth) => {
            return new Promise(resolve => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas'); const scale = targetWidth / img.width;
                    canvas.width = targetWidth; canvas.height = img.height * scale;
                    const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    resolve(canvas.toDataURL('image/jpeg', 0.6));
                }; img.src = base64;
            });
        };

        const exportFastExcel = async () => {
            if(isExporting.value) return; isExporting.value = true;
            try {
                const workbook = new ExcelJS.Workbook(); const sheet = workbook.addWorksheet('會員名單');
                sheet.columns = [
                    { header: 'ID', key: 'id', width: 10 }, { header: '照片', key: 'photo', width: 12 },
                    { header: '姓名', key: 'name', width: 15 }, { header: '電話', key: 'phone', width: 15 },
                    { header: '備註', key: 'notes', width: 25 }, { header: '次數', key: 'visits', width: 8 },
                    { header: '新增日期', key: 'created', width: 15 }
                ];
                for (let i = 0; i < members.value.length; i++) {
                    const m = members.value[i]; const rowId = i + 2; const row = sheet.getRow(rowId);
                    row.values = { id: i + 1, name: m.name, phone: m.phone, notes: m.notes, visits: m.search_history ? m.search_history.length : 0, created: m.created_at ? m.created_at.slice(0,10) : '-' };
                    row.height = 60;
                    if (m.photo) {
                        const resizedBase64 = await compressImage(m.photo, 150);
                        const imageId = workbook.addImage({ base64: resizedBase64.split(',')[1], extension: 'jpeg' });
                        sheet.addImage(imageId, { tl: { col: 1, row: rowId - 1 }, ext: { width: 80, height: 80 }, editAs: 'oneCell' });
                    }
                }
                const buffer = await workbook.xlsx.writeBuffer();
                saveAs(new Blob([buffer]), `會員名單_Fast_${new Date().toISOString().slice(0,10)}.xlsx`);
            } catch (e) { alert("導出失敗: " + e.message); } finally { isExporting.value = false; }
        };

        const startFaceRegistration = async () => {
            if(!isFaceModelLoaded) return alert('AI 載入中...');
            modals.faceScan = true; const video = await startVideo(); if(!video) return;
            const t = setInterval(async()=>{
                if(!modals.faceScan) return clearInterval(t);
                const d = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
                if(d) {
                    clearInterval(t);
                    form.face_descriptor = Array.from(d.descriptor);
                    const cvs = document.createElement('canvas'); cvs.width=360; cvs.height=360;
                    const ctx = cvs.getContext('2d'); const b = d.detection.box;
                    ctx.drawImage(video, b.x-50, b.y-50, b.width+100, b.height+100, 0, 0, 360, 360);
                    photoPreview.value = cvs.toDataURL('image/jpeg', 0.8);
                    alert('註冊成功'); modals.faceScan = false; stopFaceScan();
                }
            }, 500);
        };

        const showFaceSearch = async () => {
            if(!isFaceModelLoaded) return alert('AI 載入中...');
            if(members.value.filter(m => m.face_descriptor).length === 0) return alert('尚無 AI 數據');
            modals.faceScan = true; const video = await startVideo(); if(!video) return;
            const labeled = members.value.filter(m=>m.face_descriptor).map(m=>new faceapi.LabeledFaceDescriptors(m.id, [new Float32Array(m.face_descriptor)]));
            faceMatcher = new faceapi.FaceMatcher(labeled, 0.45);
            
            const loop = async () => {
                if(!modals.faceScan) return;
                if(Date.now() - lastScanTime > 3000) {
                    const d = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
                    if(d) {
                        const m = faceMatcher.findBestMatch(d.descriptor);
                        if(m.label !== 'unknown') {
                            const member = members.value.find(x=>x.id === m.label);
                            if(member) {
                                lastScanTime = Date.now(); scannedMember.value = member; scanMessage.value = true;
                                const h = member.search_history||[]; h.push({timestamp:new Date().toISOString()});
                                member.search_history = h; supabase.from('members').update({search_history:h}).eq('id',member.id).then();
                                setTimeout(()=>scanMessage.value=false, 2500);
                            }
                        }
                    }
                }
                requestAnimationFrame(loop);
            };
            loop();
        };

        const startVideo = async () => {
            try {
                const video = document.getElementById('video');
                const constraints = { video: { deviceId: currentDeviceId.value ? { exact: currentDeviceId.value } : undefined } };
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                videoStream = stream; video.srcObject = stream;
                return new Promise(r => video.onloadedmetadata = () => { video.play(); r(video); });
            } catch(e) { alert('鏡頭啟動失敗: ' + e.message); return null; }
        };

        const stopFaceScan = () => { if(videoStream) { videoStream.getTracks().forEach(t=>t.stop()); videoStream=null; } modals.faceScan = false; };
        const handleCameraSwitch = async () => { if(videoStream) { videoStream.getTracks().forEach(t=>t.stop()); await startVideo(); } };
        const editMember = (m) => { Object.assign(form, JSON.parse(JSON.stringify(m))); photoPreview.value = m.photo; isEditing.value = true; modals.form = true; };
        const openModal = (t) => { if(t==='add') { Object.assign(form, {id:null, name:'', phone:'', notes:'', photo:null, face_descriptor:null}); photoPreview.value=null; isEditing.value=false; } modals.form=true; };
        const handleFileSelect = (e) => { const f=e.target.files[0]; if(f){const r=new FileReader(); r.onload=ev=>photoPreview.value=ev.target.result; r.readAsDataURL(f);} };
        const handleImport = (e) => {
            const f=e.target.files[0]; const r=new FileReader();
            r.onload=async(ev)=>{
                try {
                    const wb=XLSX.read(ev.target.result, {type:'binary'});
                    const j=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                    if(confirm(`導入 ${j.length} 筆?`)) {
                        isLoading.value=true;
                        for(let row of j) await supabase.from('members').insert({id:Date.now().toString()+Math.random(), name:row['姓名']||row.name, phone:row['電話']||row.phone, notes:row['備註']||row.notes, created_at:new Date().toISOString(), search_history:[]});
                        fetchMembers(); alert('完成'); modals.io=false;
                    }
                } catch(e){ alert('格式錯誤'); }
            }; r.readAsBinaryString(f);
        };

        const calcStats = () => {
            const today = new Date().toISOString().slice(0,10);
            stats.todayVisits = members.value.reduce((acc, m) => acc + (m.search_history?.filter(h=>h.timestamp.startsWith(today)).length||0), 0);
            const activeCount = members.value.filter(m => m.search_history?.some(h => new Date(h.timestamp) > new Date(Date.now() - 5184000000))).length;
            stats.activeRate = Math.round((activeCount / (members.value.length || 1)) * 100);
        };

        const updateDashboard = () => {
            nextTick(() => {
                const hours = Array(24).fill(0); members.value.forEach(m => m.search_history?.forEach(h => hours[new Date(h.timestamp).getHours()]++));
                renderChart('hourChart', 'bar', { labels: hours.map((_, i) => `${i}時`), datasets: [{ label: '來客', data: hours, backgroundColor: '#4f46e5', borderRadius: 4 }] });
                const loyalty = { new:0, regular:0, vip:0, lost:0 }; members.value.forEach(m => loyalty[getLoyaltyType(m)]++);
                renderChart('loyaltyChart', 'doughnut', { labels: ['新客', '常客', 'VIP', '沈睡'], datasets: [{ data: Object.values(loyalty), backgroundColor: ['#38bdf8', '#4f46e5', '#f59e0b', '#94a3b8'] }] });
                const days = Array(7).fill(0).map((_, i) => { const d=new Date(); d.setDate(d.getDate()-i); return d.toISOString().slice(5,10); }).reverse();
                const trends = days.map(d => members.value.reduce((acc, m) => acc + (m.search_history?.filter(h=>h.timestamp.includes(d)).length||0), 0));
                renderChart('trendChart', 'line', { labels: days, datasets: [{ label: '流量', data: trends, borderColor: '#10b981', tension: 0.4, fill: true, backgroundColor: '#10b98120' }] });
            });
        };

        const renderChart = (id, type, data) => {
            const ctx = document.getElementById(id); if(!ctx) return;
            if(charts[id]) charts[id].destroy();
            charts[id] = new Chart(ctx, { type, data, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: type!=='bar' } } } });
        };

        const getLoyaltyType = (m) => {
            const v = m.search_history ? m.search_history.length : 0; 
            const last = m.search_history && m.search_history.length ? new Date(m.search_history[m.search_history.length-1].timestamp) : null;
            if(last && (new Date()-last)/(86400000) > 60) return 'lost';
            if(v > 20) return 'vip'; if(v > 5) return 'regular'; return 'new';
        };
        const getLoyaltyLabel = (m) => ({lost:'沈睡客', vip:'VIP', regular:'常客', new:'新客'}[getLoyaltyType(m)]);
        const getLoyaltyClass = (m) => ({lost:'bg-slate-100 text-slate-500', vip:'bg-amber-100 text-amber-700', regular:'bg-indigo-100 text-indigo-700', new:'bg-sky-100 text-sky-700'}[getLoyaltyType(m)]);

        const deleteMember = async () => { if(confirm('確定刪除？')) { await supabase.from('members').delete().eq('id', form.id); modals.form = false; fetchMembers(); } };

        watch(currentTab, v => { if(v==='dashboard') updateDashboard(); });
        const filteredMembers = computed(() => members.value.filter(m => m.name.includes(searchQuery.value) || m.phone.includes(searchQuery.value)));

        return {
            config, isConfigured, saveConfig, resetConfig, isLoading, isExporting, currentTab, searchQuery, members, filteredMembers, stats, isFaceModelLoaded,
            modals, form, photoPreview, isEditing, videoDevices, currentDeviceId, scanMessage, scannedMember,
            selfServiceInput, verifyStatus, verifiedMember, searchMode,
            saveMember, deleteMember, editMember, openModal, handleFileSelect, exportFastExcel, handleImport,
            startFaceRegistration, showFaceSearch, stopFaceScan, handleCameraSwitch, performVerification, resetSelfService, registerFaceFromSelfService, checkAdmin,
            getLoyaltyLabel, getLoyaltyClass
        };
    }
});

app.config.errorHandler = (err) => {
    console.error(err);
    alert("系統發生錯誤，請截圖給開發者:\n" + err.message);
};

app.mount('#app');
</script>
</body>
</html>
