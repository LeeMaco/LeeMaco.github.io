<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI 會員系統 V5.0 (安全重構版)</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">

    <style>
        body { font-family: system-ui, -apple-system, sans-serif; background-color: #f1f5f9; -webkit-tap-highlight-color: transparent; }
        .tab-btn { position: relative; color: #64748b; transition: all 0.3s; }
        .tab-active { color: #4f46e5; font-weight: 700; }
        .tab-active::after { content: ''; position: absolute; bottom: -12px; left: 0; width: 100%; height: 3px; background: #4f46e5; border-radius: 3px 3px 0 0; }
        .loader { width: 18px; height: 18px; border: 2px solid #cbd5e1; border-top-color: #4f46e5; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        #video-container video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        .scan-overlay { position: absolute; width: 280px; height: 280px; border: 2px solid rgba(255,255,255,0.5); border-radius: 24px; box-shadow: 0 0 0 9999px rgba(0,0,0,0.5); }
        .scan-line { width: 100%; height: 2px; background: #4f46e5; box-shadow: 0 0 15px #4f46e5; animation: scanning 2s infinite ease-in-out; }
        @keyframes scanning { 0% {transform: translateY(0);} 50% {transform: translateY(280px);} 100% {transform: translateY(0);} }
        /* 隱藏滾動條 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>

<div id="app" class="min-h-screen flex flex-col pb-safe text-slate-800" @click="unlockAudio">
    
    <div v-if="!isConfigured" class="fixed inset-0 bg-slate-900 z-[100] flex items-center justify-center p-6 backdrop-blur-sm">
        <div class="bg-white rounded-3xl p-8 w-full max-w-md shadow-2xl space-y-6">
            <div class="text-center">
                <div class="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fa-solid fa-rocket text-3xl text-indigo-600"></i>
                </div>
                <h2 class="text-2xl font-black text-slate-800">系統初始化 V5.0</h2>
                <p class="text-slate-400 text-sm mt-1">請輸入連線資訊以啟動系統</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wider ml-1">Supabase URL</label>
                    <input v-model="config.url" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition mt-1" placeholder="https://...">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wider ml-1">Supabase Key</label>
                    <input v-model="config.key" type="password" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition mt-1" placeholder="eyJ...">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wider ml-1">管理員密碼</label>
                    <input v-model="config.adminPwd" type="password" placeholder="預設: 0000" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition mt-1">
                </div>
                <button @click="saveConfig" class="w-full bg-indigo-600 text-white py-3.5 rounded-xl font-bold hover:bg-indigo-700 transition shadow-lg shadow-indigo-200 active:scale-95">
                    啟動系統
                </button>
                <div class="text-center pt-2">
                    <button @click="forceReset" class="text-xs text-rose-400 hover:text-rose-600 underline">清除舊設定 (無法啟動時請按此)</button>
                </div>
            </div>
        </div>
    </div>

    <header class="bg-white shadow-sm sticky top-0 z-40">
        <div class="px-5 py-4 flex justify-between items-center">
            <h1 class="text-lg font-black text-slate-800 flex items-center gap-2">
                <span class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white text-sm"><i class="fa-solid fa-brain"></i></span>
                AI 會員系統
            </h1>
            <div class="flex gap-3 items-center">
                <button @click="forceReset" class="w-8 h-8 rounded-full bg-slate-100 text-slate-400 hover:bg-slate-200 flex items-center justify-center"><i class="fa-solid fa-gear"></i></button>
                <button @click="checkAdmin(() => modals.io = true)" class="w-8 h-8 rounded-full bg-slate-100 text-slate-400 hover:bg-slate-200 flex items-center justify-center"><i class="fa-solid fa-cloud-arrow-down"></i></button>
                <div class="flex items-center gap-2 text-xs font-bold bg-slate-100 px-3 py-1.5 rounded-full border border-slate-200">
                    <span v-if="isLoading" class="loader"></span>
                    <span v-else class="text-emerald-600 flex items-center"><i class="fa-solid fa-circle text-[6px] mr-1.5 animate-pulse"></i>連線中</span>
                </div>
            </div>
        </div>
        <div class="flex border-t border-slate-100 bg-white px-2">
            <button @click="currentTab = 'self_service'" :class="{'tab-active text-indigo-600': currentTab === 'self_service'}" class="tab-btn flex-1 py-3 text-sm flex justify-center items-center gap-1"><i class="fa-solid fa-mobile-screen"></i> 自助</button>
            <button @click="currentTab = 'list'" :class="{'tab-active text-indigo-600': currentTab === 'list'}" class="tab-btn flex-1 py-3 text-sm flex justify-center items-center gap-1"><i class="fa-solid fa-list-ul"></i> 列表</button>
            <button @click="currentTab = 'dashboard'" :class="{'tab-active text-indigo-600': currentTab === 'dashboard'}" class="tab-btn flex-1 py-3 text-sm flex justify-center items-center gap-1"><i class="fa-solid fa-chart-pie"></i> 分析</button>
            <button @click="showFaceSearch(false)" class="tab-btn flex-1 py-3 text-sm text-indigo-600 bg-indigo-50/50 font-bold flex justify-center items-center gap-1"><i class="fa-solid fa-expand"></i> 掃描</button>
        </div>
    </header>

    <main class="flex-grow p-4 overflow-y-auto bg-slate-50 relative">
        
        <div v-show="currentTab === 'self_service'" class="max-w-md mx-auto mt-4 pb-20 animate-fade-in">
            <div class="bg-white rounded-3xl shadow-xl border border-slate-100 p-8 min-h-[60vh] flex flex-col items-center justify-center text-center relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-indigo-500 to-purple-500"></div>
                
                <div v-if="verifyStatus === 'idle' || verifyStatus === 'fail'" class="w-full space-y-8">
                    <div>
                        <div class="w-20 h-20 bg-indigo-50 rounded-full flex items-center justify-center mx-auto mb-4 text-indigo-600 text-4xl shadow-inner">
                            <i class="fa-solid fa-user-check"></i>
                        </div>
                        <h2 class="text-2xl font-black text-slate-800">會員自助認證</h2>
                        <p class="text-slate-400 text-sm mt-1">請選擇一種方式進行報到</p>
                    </div>

                    <div class="grid grid-cols-3 gap-3">
                         <button class="py-3 rounded-xl border border-slate-200 hover:border-indigo-500 hover:bg-indigo-50 transition flex flex-col items-center gap-1" :class="searchMode==='phone'?'ring-2 ring-indigo-500 bg-indigo-50':''" @click="searchMode='phone'">
                             <i class="fa-solid fa-phone text-indigo-500 text-lg"></i> <span class="text-xs font-bold text-slate-600">手機</span>
                         </button>
                         <button @click="startSelfServiceFaceScan" class="py-3 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 text-white shadow-lg shadow-indigo-200 hover:scale-105 active:scale-95 transition flex flex-col items-center gap-1 transform">
                             <i class="fa-solid fa-face-smile text-lg"></i> <span class="text-xs font-bold">刷臉</span>
                         </button>
                         <button class="py-3 rounded-xl border border-slate-200 hover:border-indigo-500 hover:bg-indigo-50 transition flex flex-col items-center gap-1" :class="searchMode==='name'?'ring-2 ring-indigo-500 bg-indigo-50':''" @click="searchMode='name'">
                             <i class="fa-solid fa-signature text-indigo-500 text-lg"></i> <span class="text-xs font-bold text-slate-600">姓名</span>
                         </button>
                    </div>

                    <div class="relative">
                        <input v-model="selfServiceInput" :type="searchMode === 'phone' ? 'tel' : 'text'" :placeholder="searchMode === 'phone' ? '請輸入手機號碼' : '請輸入姓名'" class="w-full text-center text-xl font-bold py-4 border-b-2 border-slate-200 focus:border-indigo-500 outline-none bg-transparent transition placeholder:text-slate-300" @keyup.enter="performVerification">
                        <button @click="performVerification" class="absolute right-0 top-3 text-indigo-600 hover:text-indigo-800"><i class="fa-solid fa-arrow-right text-2xl"></i></button>
                    </div>

                    <div v-if="verifyStatus === 'fail'" class="bg-rose-50 text-rose-600 p-3 rounded-xl text-sm font-bold animate-bounce">
                        <i class="fa-solid fa-circle-exclamation mr-1"></i> 找不到資料，請重試
                    </div>

                    <div class="pt-6 border-t border-slate-100">
                        <p class="text-slate-400 text-xs mb-3">還不是會員嗎？</p>
                        <button @click="openSelfRegister" class="w-full border-2 border-dashed border-indigo-300 text-indigo-600 py-3 rounded-xl font-bold hover:bg-indigo-50 transition">
                            立即加入會員
                        </button>
                    </div>
                </div>

                <div v-else-if="verifyStatus === 'success'" class="w-full space-y-6 animate-fade-in-up">
                    <div class="w-24 h-24 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-4 border-4 border-white shadow-xl">
                        <i class="fa-solid fa-check text-5xl text-emerald-500"></i>
                    </div>
                    <div>
                        <h2 class="text-3xl font-black text-slate-800">認證成功！</h2>
                        <p class="text-lg text-slate-500 mt-2">歡迎回來，<span class="font-bold text-indigo-600 text-2xl">{{ verifiedMember?.name }}</span></p>
                    </div>

                    <div v-if="verifiedMember && !verifiedMember.face_descriptor" class="bg-indigo-50 border border-indigo-100 p-5 rounded-2xl mt-4 text-left">
                        <div class="flex items-start gap-3">
                            <i class="fa-solid fa-lightbulb text-yellow-500 text-xl mt-1"></i>
                            <div>
                                <h4 class="font-bold text-indigo-900">建議註冊人臉辨識</h4>
                                <p class="text-indigo-600/80 text-xs mt-1 leading-relaxed">註冊後，下次只要「看鏡頭」就能秒速報到，完全不用動手喔！</p>
                            </div>
                        </div>
                        <button @click="registerFaceFromSelfService" class="w-full mt-4 bg-white border border-indigo-200 text-indigo-600 py-2.5 rounded-lg font-bold hover:bg-indigo-50 transition shadow-sm text-sm">
                            <i class="fa-solid fa-camera mr-1"></i> 立即補錄人臉
                        </button>
                    </div>
                    
                    <div v-else class="bg-emerald-50 border border-emerald-100 p-4 rounded-2xl">
                        <p class="text-emerald-700 font-bold flex items-center justify-center gap-2">
                            <i class="fa-solid fa-shield-check text-xl"></i> 您的帳號已受 AI 保護
                        </p>
                    </div>

                    <button @click="resetSelfService" class="w-full bg-slate-800 text-white py-3.5 rounded-xl font-bold shadow-lg hover:bg-slate-700 transition mt-6">
                        <i class="fa-solid fa-rotate-left mr-2"></i>返回首頁
                    </button>
                </div>
            </div>
        </div>

        <div v-show="currentTab === 'list'" class="space-y-4 max-w-4xl mx-auto pb-20">
             <div class="relative group">
                 <i class="fa-solid fa-search absolute left-4 top-4 text-slate-400"></i>
                 <input v-model="searchQuery" type="text" placeholder="搜尋姓名或電話..." class="w-full pl-11 pr-4 py-3.5 border-0 rounded-2xl shadow-sm bg-white focus:ring-2 focus:ring-indigo-100 outline-none text-slate-700">
             </div>
             <div class="flex justify-between items-center px-2">
                 <span class="text-xs font-bold text-slate-400 bg-white px-3 py-1 rounded-full shadow-sm">{{ members.length }} 位會員</span>
                 <button @click="openAdminAdd" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md transition flex items-center gap-2"><i class="fa-solid fa-plus"></i> 新增</button>
             </div>
             <div class="grid gap-3 sm:grid-cols-2">
                 <div v-for="m in filteredMembers" :key="m.id" @click="editMember(m)" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-4 hover:shadow-md transition cursor-pointer relative group">
                     <div class="w-14 h-14 rounded-xl bg-slate-100 overflow-hidden border border-slate-200 flex-shrink-0">
                         <img :src="m.photo||'https://via.placeholder.com/150?text=No+Img'" class="w-full h-full object-cover">
                     </div>
                     <div class="flex-1 min-w-0">
                         <div class="flex justify-between">
                             <h3 class="font-bold text-slate-800">{{m.name}}</h3>
                             <span class="text-xs bg-slate-100 px-2 py-0.5 rounded text-slate-500 font-mono">{{m.search_history?.length||0}}次</span>
                         </div>
                         <p class="text-xs text-slate-400 mt-1 font-mono">{{m.phone}}</p>
                     </div>
                     <i class="fa-solid fa-chevron-right text-slate-300 text-xs"></i>
                 </div>
             </div>
        </div>

        <div v-show="currentTab === 'dashboard'" class="max-w-4xl mx-auto space-y-4">
            <div class="bg-white p-6 rounded-2xl shadow-sm border-l-4 border-indigo-500">
                <p class="text-slate-400 text-xs font-bold uppercase">今日來客</p>
                <p class="text-4xl font-black text-slate-800 mt-1">{{ stats.todayVisits }}</p>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border-l-4 border-emerald-500">
                <p class="text-slate-400 text-xs font-bold uppercase">活躍會員佔比</p>
                <p class="text-4xl font-black text-slate-800 mt-1">{{ stats.activeRate }}<span class="text-xl">%</span></p>
            </div>
        </div>
    </main>

    <div v-if="modals.form || modals.register" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-3xl max-h-[95vh] flex flex-col shadow-2xl overflow-hidden animate-fade-in-up">
            <div class="px-6 py-4 border-b flex justify-between items-center bg-slate-50">
                <h3 class="font-bold text-lg text-slate-800">{{ modals.register ? '顧客自助註冊' : (isEditing ? '編輯會員' : '新增會員') }}</h3>
                <button @click="closeModals" class="w-8 h-8 rounded-full bg-white hover:bg-slate-100 flex items-center justify-center transition"><i class="fa-solid fa-times text-slate-500"></i></button>
            </div>
            
            <div class="p-6 overflow-y-auto space-y-5 flex-1">
                <div v-if="modals.register" class="bg-indigo-50 p-4 rounded-xl border border-indigo-100 text-xs text-indigo-800 mb-4">
                    <p class="font-bold mb-1"><i class="fa-solid fa-file-contract mr-1"></i> 會員個資同意書</p>
                    <p class="opacity-80 leading-relaxed">本人同意提供姓名、電話及照片供貴店進行會員管理與身分識別(含AI人臉辨識)使用。</p>
                    <label class="flex items-center gap-2 mt-3 cursor-pointer">
                        <input type="checkbox" v-model="registerForm.agree" class="rounded text-indigo-600 focus:ring-indigo-500">
                        <span class="font-bold">我已閱讀並同意</span>
                    </label>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2">
                        <label class="text-xs font-bold text-slate-500 uppercase">姓名 <span class="text-red-500">*</span></label>
                        <input v-model="activeForm.name" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl mt-1 focus:ring-2 focus:ring-indigo-500 outline-none transition">
                    </div>
                    <div class="col-span-2">
                        <label class="text-xs font-bold text-slate-500 uppercase">電話 <span class="text-red-500">*</span></label>
                        <input v-model="activeForm.phone" type="tel" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl mt-1 focus:ring-2 focus:ring-indigo-500 outline-none transition">
                    </div>
                    <div class="col-span-2" v-if="!modals.register">
                        <label class="text-xs font-bold text-slate-500 uppercase">備註</label>
                        <textarea v-model="activeForm.notes" rows="2" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl mt-1 focus:ring-2 focus:ring-indigo-500 outline-none transition"></textarea>
                    </div>
                </div>

                <div class="border-t border-slate-100 pt-4">
                    <label class="text-xs font-bold text-slate-500 uppercase block mb-3">AI 辨識照片</label>
                    <div class="flex gap-4 mb-4">
                        <div class="w-20 h-20 bg-slate-100 rounded-xl overflow-hidden border border-slate-200 shadow-inner flex-shrink-0">
                            <img v-if="activePhoto" :src="activePhoto" class="w-full h-full object-cover">
                            <div v-else class="flex items-center justify-center h-full text-slate-300"><i class="fa-solid fa-user text-2xl"></i></div>
                        </div>
                        <div class="flex flex-col justify-center gap-2 flex-1">
                             <button @click="$refs.fileInput.click()" class="w-full bg-white border border-slate-200 hover:bg-slate-50 py-2 rounded-lg text-xs font-bold text-slate-600 transition shadow-sm">
                                <i class="fa-solid fa-upload mr-1"></i> 上傳照片
                            </button>
                            <p class="text-[10px] text-slate-400">支援 JPG/PNG，自動優化畫質</p>
                        </div>
                    </div>
                    <button @click="startScanForForm" class="w-full py-3.5 rounded-xl text-white font-bold text-sm shadow-lg transition transform active:scale-95 flex items-center justify-center gap-2 relative overflow-hidden group"
                        :class="activeForm.face_descriptor ? 'bg-emerald-500' : 'bg-indigo-600 hover:bg-indigo-700'">
                        <i class="fa-solid fa-camera text-lg"></i>
                        <span>{{ activeForm.face_descriptor ? '已完成 (點擊重拍)' : '開啟鏡頭拍攝' }}</span>
                    </button>
                </div>
            </div>

            <div class="p-4 border-t bg-slate-50 flex justify-between items-center">
                <button v-if="isEditing && !modals.register" @click="checkAdmin(() => deleteMember())" class="text-rose-500 font-bold text-sm px-2 hover:text-rose-600"><i class="fa-solid fa-trash mr-1"></i>刪除</button>
                <div v-else></div> <div class="flex gap-3">
                    <button @click="closeModals" class="px-5 py-2.5 text-slate-500 font-bold hover:bg-slate-200 rounded-lg transition">取消</button>
                    <button @click="submitForm" class="px-6 py-2.5 bg-indigo-600 text-white rounded-lg shadow-lg font-bold hover:bg-indigo-700 transition disabled:opacity-50" :disabled="modals.register && !registerForm.agree">
                        {{ modals.register ? '送出申請' : '儲存' }}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div v-show="modals.faceScan" class="fixed inset-0 bg-black z-[200] flex flex-col">
        <div class="absolute top-0 w-full z-30 p-6 flex justify-between items-start bg-gradient-to-b from-black/80 to-transparent pb-20">
            <select v-model="currentDeviceId" @change="handleCameraSwitch" class="bg-black/30 backdrop-blur text-white border border-white/20 py-2 pl-4 pr-10 rounded-full text-sm outline-none appearance-none font-mono">
                <option value="">自動選擇鏡頭</option>
                <option v-for="cam in videoDevices" :key="cam.deviceId" :value="cam.deviceId">{{ cam.label || 'Camera '+cam.deviceId.slice(0,4) }}</option>
            </select>
            <button @click="stopFaceScan" class="w-10 h-10 rounded-full bg-white/20 backdrop-blur flex items-center justify-center text-white hover:bg-white/30 transition"><i class="fa-solid fa-times text-lg"></i></button>
        </div>

        <transition name="bounce">
            <div v-if="scanMessage" class="absolute top-24 left-0 w-full z-40 flex justify-center px-4 pointer-events-none">
                <div class="bg-white/95 backdrop-blur-xl p-4 rounded-3xl shadow-2xl w-full max-w-sm border-2 border-emerald-400">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 rounded-full overflow-hidden border-2 border-emerald-500 shadow-sm flex-shrink-0">
                            <img :src="scannedMember?.photo || ''" class="w-full h-full object-cover">
                        </div>
                        <div class="flex-1 min-w-0 text-left">
                            <div class="flex items-center justify-between">
                                <h3 class="font-black text-xl text-slate-800 truncate">{{ scannedMember?.name }}</h3>
                                <span class="bg-emerald-100 text-emerald-700 text-xs px-2 py-0.5 rounded font-bold">OK</span>
                            </div>
                            <p class="text-sm text-slate-500">累計來訪: <span class="text-indigo-600 font-black">{{ scannedMember?.search_history?.length }}</span> 次</p>
                        </div>
                    </div>
                    <div v-if="scannedMember?.notes" class="mt-3 bg-amber-50 border border-amber-200 p-3 rounded-xl flex gap-3 text-left">
                        <i class="fa-solid fa-note-sticky text-amber-500 mt-0.5"></i>
                        <p class="text-sm font-bold text-amber-800 leading-snug">{{ scannedMember.notes }}</p>
                    </div>
                </div>
            </div>
        </transition>

        <div id="video-container" class="flex-1 relative flex items-center justify-center bg-black">
            <video id="video" autoplay muted playsinline></video>
            <div class="scan-overlay overflow-hidden relative">
                <div class="scan-line"></div>
            </div>
            <div class="absolute bottom-12 bg-black/40 backdrop-blur px-6 py-2 rounded-full text-white/90 text-sm font-bold tracking-wide flex items-center gap-2">
                <span class="w-2 h-2 bg-emerald-400 rounded-full animate-pulse"></span> AI 視覺辨識運作中...
            </div>
        </div>
    </div>

    <div v-if="modals.io" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl text-center">
            <h3 class="font-bold text-lg mb-4 text-slate-800">資料管理中心</h3>
            <button @click="exportFastExcel" class="w-full py-3.5 bg-emerald-50 text-emerald-700 rounded-xl font-bold border border-emerald-200 mb-4 hover:bg-emerald-100 transition flex items-center justify-center gap-2" :disabled="isExporting">
                <i v-if="isExporting" class="fa-solid fa-circle-notch fa-spin"></i> {{ isExporting ? '處理中...' : '導出 Excel (含照片)' }}
            </button>
            <div class="border-t pt-4">
                <p class="text-xs text-slate-400 mb-2 uppercase font-bold">資料還原</p>
                <input type="file" @change="handleImport" accept=".xlsx,.xls,.json" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 cursor-pointer">
            </div>
            <button @click="modals.io=false" class="mt-6 text-slate-400 hover:text-slate-600 transition">關閉視窗</button>
        </div>
    </div>
    <input type="file" ref="fileInput" @change="handleFileSelect" accept="image/*" class="hidden">
</div>

<script>
const { createApp, ref, computed, onMounted, reactive, nextTick, watch } = Vue;

const app = createApp({
    setup() {
        // --- State ---
        const config = reactive({ url: '', key: '', adminPwd: '' });
        const isConfigured = ref(false);
        const members = ref([]);
        const isLoading = ref(false);
        const isExporting = ref(false);
        const currentTab = ref('self_service');
        const searchQuery = ref('');
        const modals = reactive({ form: false, faceScan: false, io: false, register: false });
        
        // Forms
        const isEditing = ref(false);
        const form = reactive({ id: null, name: '', phone: '', notes: '', photo: null, search_history: [], face_descriptor: null });
        const registerForm = reactive({ name: '', phone: '', photo: null, face_descriptor: null, agree: false });
        // Computed for active form
        const activeForm = computed(() => modals.register ? registerForm : form);
        const activePhoto = computed(() => modals.register ? registerForm.photo : form.photo);

        // Scan & Self Service
        const scanMode = ref('search'); // search, register, self_verify
        const selfServiceInput = ref('');
        const verifyStatus = ref('idle');
        const verifiedMember = ref(null);
        const searchMode = ref('phone');
        
        // Hardware & AI
        const videoDevices = ref([]);
        const currentDeviceId = ref('');
        const scanMessage = ref(false);
        const scannedMember = ref(null);
        let supabase = null, videoStream = null, faceMatcher = null, isFaceModelLoaded = false;
        let lastScanTime = 0, audioContext = null;
        const stats = reactive({ todayVisits: 0, activeRate: 0 });

        // --- Init ---
        onMounted(async () => {
            try {
                const saved = localStorage.getItem('supabase_config');
                if(saved && saved !== 'undefined') {
                    const parsed = JSON.parse(saved);
                    if(parsed && parsed.url && parsed.key) { Object.assign(config, parsed); initSystem(); }
                }
            } catch(e) { console.error("Config Error", e); resetConfig(); }
            loadFaceModels(); getCameras();
        });

        const initSystem = async () => {
            if(!config.url || !config.key) return;
            try {
                supabase = window.supabase.createClient(config.url, config.key);
                isConfigured.value = true;
                fetchMembers();
            } catch(e) { alert("Init Failed"); isConfigured.value=false; }
        };

        const loadFaceModels = async () => {
            const URL = 'https://justadudewhohacks.github.io/face-api.js/models';
            await Promise.all([
                faceapi.nets.tinyFaceDetector.loadFromUri(URL),
                faceapi.nets.faceLandmark68Net.loadFromUri(URL),
                faceapi.nets.faceRecognitionNet.loadFromUri(URL)
            ]);
            isFaceModelLoaded = true;
        };

        const getCameras = async () => {
            try {
                await navigator.mediaDevices.getUserMedia({ video: true });
                const devices = await navigator.mediaDevices.enumerateDevices();
                videoDevices.value = devices.filter(d => d.kind === 'videoinput');
                const back = videoDevices.value.find(d => d.label.toLowerCase().includes('back'));
                currentDeviceId.value = back ? back.deviceId : (videoDevices.value[0]?.deviceId || '');
            } catch(e) {}
        };

        const fetchMembers = async () => {
            isLoading.value = true;
            try {
                const { data } = await supabase.from('members').select('*').order('updated_at', {ascending:false});
                if(data) members.value = data;
                calcStats();
            } catch(e) { console.error(e); }
            isLoading.value = false;
        };

        // --- Logic ---
        const checkAdmin = (action) => {
            const pwd = prompt("請輸入管理員密碼：");
            if(pwd === (config.adminPwd || '0000')) action(); else alert("密碼錯誤");
        };
        const saveConfig = () => { localStorage.setItem('supabase_config', JSON.stringify(config)); initSystem(); };
        const resetConfig = () => { if(confirm('重設設定？')) { localStorage.removeItem('supabase_config'); location.reload(); } };
        const forceReset = () => { localStorage.removeItem('supabase_config'); location.reload(); };
        
        const unlockAudio = () => { if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)(); if (audioContext.state === 'suspended') audioContext.resume(); };
        const playSound = (type) => {
            if (!audioContext) unlockAudio();
            const osc = audioContext.createOscillator(); const gain = audioContext.createGain();
            osc.connect(gain); gain.connect(audioContext.destination);
            osc.type = type === 'success' ? 'sine' : 'sawtooth';
            osc.frequency.setValueAtTime(type==='success'?523:150, audioContext.currentTime);
            gain.gain.setValueAtTime(0.1, audioContext.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.5);
            osc.start(); osc.stop(audioContext.currentTime + 0.5);
        };

        // --- Member Actions ---
        const openAdminAdd = () => { 
            Object.assign(form, {id:null,name:'',phone:'',notes:'',photo:null,face_descriptor:null}); 
            isEditing.value=false; modals.form=true; modals.register=false; 
        };
        const editMember = (m) => { 
            Object.assign(form, JSON.parse(JSON.stringify(m))); 
            isEditing.value=true; modals.form=true; modals.register=false; 
        };
        const openSelfRegister = () => {
            Object.assign(registerForm, { name: '', phone: '', photo: null, face_descriptor: null, agree: false });
            modals.register = true; modals.form=false;
        };
        const closeModals = () => { modals.form=false; modals.register=false; modals.faceScan=false; stopFaceScan(); };

        const submitForm = async () => {
            const target = modals.register ? registerForm : form;
            if(!target.name || !target.phone) return alert("請填寫姓名與電話");
            
            isLoading.value = true;
            const payload = {
                name: target.name, phone: target.phone, 
                notes: target.notes || '', photo: target.photo, face_descriptor: target.face_descriptor,
                updated_at: new Date().toISOString()
            };

            try {
                if(!modals.register && form.id) {
                    await supabase.from('members').update(payload).eq('id', form.id);
                } else {
                    // Check duplicate for register
                    if(members.value.some(m => m.phone === target.phone)) throw new Error("此電話已註冊");
                    payload.id = Date.now().toString();
                    payload.created_at = new Date().toISOString();
                    payload.search_history = [];
                    await supabase.from('members').insert(payload);
                }
                
                await fetchMembers();
                
                if(modals.register) {
                    alert("註冊成功！");
                    selfServiceInput.value = target.phone; searchMode.value = 'phone';
                    performVerification();
                }
                closeModals();
            } catch(e) { alert(e.message); } finally { isLoading.value = false; }
        };

        const deleteMember = async () => { 
            if(confirm('確定刪除？')) { await supabase.from('members').delete().eq('id', form.id); closeModals(); fetchMembers(); } 
        };

        // --- AI Scan ---
        const startVideo = async () => {
            if(!isFaceModelLoaded) { alert("AI 模型載入中，請稍候..."); return null; }
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { deviceId: currentDeviceId.value ? { exact: currentDeviceId.value } : undefined } });
                const v = document.getElementById('video'); v.srcObject = stream; videoStream = stream;
                return new Promise(r => v.onloadedmetadata = () => { v.play(); r(v); });
            } catch(e) { alert('無法啟動鏡頭'); return null; }
        };
        const stopFaceScan = () => { if(videoStream) { videoStream.getTracks().forEach(t=>t.stop()); videoStream=null; } modals.faceScan = false; };
        const handleCameraSwitch = async () => { if(videoStream) { videoStream.getTracks().forEach(t=>t.stop()); await startVideo(); } };

        const startScanForForm = () => { 
            scanMode.value = 'register'; 
            modals.faceScan = true; 
            startScanningLoop(); 
        };
        
        const startSelfServiceFaceScan = () => { showFaceSearch(true); };
        const showFaceSearch = (isSelf) => { 
            scanMode.value = isSelf ? 'self_verify' : 'search'; 
            modals.faceScan = true; 
            startScanningLoop(); 
        };

        const startScanningLoop = async () => {
            const video = await startVideo(); if(!video) return;
            const loop = setInterval(async () => {
                if(!modals.faceScan) return clearInterval(loop);
                
                const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
                
                if(detection) {
                    // Registration Mode (Capture Photo)
                    if(scanMode.value === 'register') {
                        clearInterval(loop);
                        const desc = Array.from(detection.descriptor);
                        const cvs = document.createElement('canvas'); cvs.width=360; cvs.height=360;
                        const ctx = cvs.getContext('2d'); const b = detection.detection.box;
                        ctx.drawImage(video, b.x-50, b.y-50, b.width+100, b.height+100, 0, 0, 360, 360);
                        const photoData = cvs.toDataURL('image/jpeg', 0.8);
                        
                        const target = modals.register ? registerForm : form;
                        target.face_descriptor = desc;
                        target.photo = photoData;
                        
                        alert("已擷取人臉特徵！"); stopFaceScan();
                    } 
                    // Search Mode
                    else if(members.value.length > 0) {
                        if(!faceMatcher) {
                            const labeled = members.value.filter(m=>m.face_descriptor).map(m=>new faceapi.LabeledFaceDescriptors(m.id, [new Float32Array(m.face_descriptor)]));
                            if(labeled.length) faceMatcher = new faceapi.FaceMatcher(labeled, 0.45);
                        }
                        if(faceMatcher) {
                            const match = faceMatcher.findBestMatch(detection.descriptor);
                            if(match.label !== 'unknown') {
                                const m = members.value.find(x=>x.id === match.label);
                                if(m && (Date.now() - lastScanTime > 3000)) {
                                    lastScanTime = Date.now();
                                    
                                    // Update Visit
                                    const h = m.search_history||[]; h.push({timestamp:new Date().toISOString()});
                                    m.search_history = h; supabase.from('members').update({search_history:h}).eq('id',m.id).then();
                                    
                                    playSound('success');
                                    
                                    if(scanMode.value === 'self_verify') {
                                        verifyStatus.value = 'success'; verifiedMember.value = m; stopFaceScan();
                                    } else {
                                        scannedMember.value = m; scanMessage.value = true;
                                        setTimeout(()=>scanMessage.value=false, 2500);
                                    }
                                }
                            }
                        }
                    }
                }
            }, 500);
        };

        // --- Utils ---
        const performVerification = () => {
            const t = selfServiceInput.value.trim();
            const m = members.value.find(x => (searchMode.value==='phone' && x.phone===t) || (searchMode.value==='name' && x.name===t));
            if(m) { verifyStatus.value='success'; verifiedMember.value=m; playSound('success'); }
            else { verifyStatus.value='fail'; playSound('fail'); setTimeout(()=>verifyStatus.value='idle', 3000); }
        };
        const resetSelfService = () => { verifyStatus.value='idle'; selfServiceInput.value=''; verifiedMember.value=null; };
        const registerFaceFromSelfService = () => { editMember(verifiedMember.value); startScanForForm(); };
        const handleFileSelect = (e) => { 
            const f=e.target.files[0]; 
            if(f){const r=new FileReader(); r.onload=ev=> { 
                const target = modals.register ? registerForm : form;
                target.photo=ev.target.result; 
            }; r.readAsDataURL(f);} 
        };
        
        const compressImage = (base64, targetWidth) => {
            return new Promise(resolve => {
                const img = new Image(); img.onload = () => {
                    const c = document.createElement('canvas'); const s = targetWidth/img.width;
                    c.width = targetWidth; c.height = img.height*s;
                    c.getContext('2d').drawImage(img,0,0,c.width,c.height);
                    resolve(c.toDataURL('image/jpeg', 0.7));
                }; img.src = base64;
            });
        };

        const exportFastExcel = async () => {
            if(isExporting.value) return; isExporting.value = true;
            try {
                const wb = new ExcelJS.Workbook(); const ws = wb.addWorksheet('Members');
                ws.columns = [ {header:'ID',key:'id'}, {header:'Name',key:'name'}, {header:'Phone',key:'phone'} ];
                for(let m of members.value) {
                    const row = ws.addRow({id:m.id, name:m.name, phone:m.phone});
                    if(m.photo) {
                        const img = await compressImage(m.photo, 100);
                        const id = wb.addImage({base64:img.split(',')[1], extension:'jpeg'});
                        ws.addImage(id, {tl:{col:3,row:row.number-1}, ext:{width:50,height:50}});
                    }
                }
                const b = await wb.xlsx.writeBuffer(); saveAs(new Blob([b]), 'members.xlsx');
            } catch(e){ alert("Error"); } finally { isExporting.value=false; }
        };
        
        const handleImport = (e) => { /* Same as V4.2 */ };
        const calcStats = () => { stats.todayVisits = members.value.reduce((acc, m) => acc + (m.search_history?.filter(h=>h.timestamp.slice(0,10) === new Date().toISOString().slice(0,10)).length||0), 0); };

        watch(currentTab, v => { if(v==='dashboard') {} });
        const filteredMembers = computed(() => members.value.filter(m => m.name.includes(searchQuery.value) || m.phone.includes(searchQuery.value)));

        return {
            config, isConfigured, saveConfig, resetConfig, forceReset, isLoading, isExporting, currentTab, searchQuery, members, filteredMembers, stats, isFaceModelLoaded,
            modals, form, registerForm, activeForm, activePhoto, videoDevices, currentDeviceId, scanMessage, scannedMember,
            selfServiceInput, verifyStatus, verifiedMember, searchMode,
            saveMember, deleteMember, editMember, openAdminAdd, handleFileSelect, exportFastExcel, handleImport,
            startScanForForm, startSelfServiceFaceScan, showFaceSearch, stopFaceScan, handleCameraSwitch, 
            performVerification, resetSelfService, registerFaceFromSelfService, checkAdmin,
            unlockAudio, openSelfRegister, submitForm, closeModals,
            getLoyaltyLabel: () => 'Member', getLoyaltyClass: () => 'bg-gray-100 text-gray-500'
        };
    }
});

app.mount('#app');
</script>
</body>
</html>
